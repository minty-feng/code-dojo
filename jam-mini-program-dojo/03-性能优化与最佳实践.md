# æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

## ğŸ’¡ æ ¸å¿ƒç»“è®º

1. **setDataæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œéœ€æ§åˆ¶é¢‘ç‡å’Œæ•°æ®é‡**
2. **å›¾ç‰‡æ‡’åŠ è½½å’Œé¢„åŠ è½½å¯æ˜¾è‘—æå‡ä½“éªŒ**
3. **åˆ†åŒ…åŠ è½½å¯çªç ´2MBä¸»åŒ…é™åˆ¶**
4. **é•¿åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡èŠ‚ç‚¹**
5. **åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚**

---

## 1. setDataä¼˜åŒ–

### 1.1 setDataåŸç†

```
é€»è¾‘å±‚(JS)  â†’  åºåˆ—åŒ–æ•°æ®  â†’  WebViewçº¿ç¨‹  â†’  é‡æ–°æ¸²æŸ“
         â†‘                             â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è€—æ—¶è¿‡ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**ï¼š
- æ•°æ®ä¼ è¾“æœ‰æ€§èƒ½å¼€é”€
- ä¼šé˜»å¡ç”¨æˆ·äº¤äº’
- é¢‘ç¹è°ƒç”¨å¯¼è‡´å¡é¡¿

### 1.2 ä¼˜åŒ–ç­–ç•¥

**1. åªæ›´æ–°å¿…è¦çš„æ•°æ®**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šæ›´æ–°æ•´ä¸ªå¯¹è±¡
this.setData({
  user: {
    name: 'å¼ ä¸‰',
    age: 25,
    address: 'åŒ—äº¬',
    avatar: 'https://...'
  }
})

// âœ… æ­£ç¡®ï¼šåªæ›´æ–°å˜åŒ–çš„å­—æ®µ
this.setData({
  'user.name': 'æå››'
})
```

**2. åˆå¹¶å¤šæ¬¡setData**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šå¤šæ¬¡è°ƒç”¨
this.setData({ count: 1 })
this.setData({ name: 'å¼ ä¸‰' })
this.setData({ age: 25 })

// âœ… æ­£ç¡®ï¼šåˆå¹¶è°ƒç”¨
this.setData({
  count: 1,
  name: 'å¼ ä¸‰',
  age: 25
})
```

**3. æ§åˆ¶æ•°æ®é‡**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šä¼ è¾“å¤§é‡æ•°æ®
this.setData({
  list: hugeArray  // 1000ä¸ªå¤æ‚å¯¹è±¡
})

// âœ… æ­£ç¡®ï¼šåˆ†é¡µåŠ è½½
this.setData({
  list: hugeArray.slice(0, 20)
})
```

**4. é˜²æŠ–å’ŒèŠ‚æµ**ï¼š
```javascript
// utils/debounce.js
export function debounce(fn, delay = 500) {
  let timer = null
  return function(...args) {
    if (timer) clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}

// ä½¿ç”¨
Page({
  onInput: debounce(function(e) {
    this.setData({
      keyword: e.detail.value
    })
    this.search()
  }, 300)
})
```

**5. é¿å…åœ¨åå°æ€è°ƒç”¨**ï¼š
```javascript
Page({
  data: {
    isActive: true
  },
  
  onShow() {
    this.setData({ isActive: true })
  },
  
  onHide() {
    this.setData({ isActive: false })
  },
  
  updateData() {
    // åªåœ¨é¡µé¢æ¿€æ´»æ—¶æ›´æ–°
    if (this.data.isActive) {
      this.setData({ /* data */ })
    }
  }
})
```

---

## 2. é•¿åˆ—è¡¨ä¼˜åŒ–

### 2.1 è™šæ‹Ÿåˆ—è¡¨

```javascript
// components/virtual-list/virtual-list.js
Component({
  properties: {
    list: {
      type: Array,
      value: []
    },
    itemHeight: {
      type: Number,
      value: 100
    }
  },
  
  data: {
    visibleData: [],
    startIndex: 0,
    endIndex: 0,
    scrollTop: 0
  },
  
  lifetimes: {
    attached() {
      this.updateVisibleData()
    }
  },
  
  methods: {
    onScroll(e) {
      const { scrollTop } = e.detail
      this.setData({ scrollTop })
      this.updateVisibleData()
    },
    
    updateVisibleData() {
      const { list, itemHeight, scrollTop } = this.data
      
      // è®¡ç®—å¯è§åŒºåŸŸ
      const viewportHeight = wx.getSystemInfoSync().windowHeight
      const startIndex = Math.floor(scrollTop / itemHeight)
      const endIndex = Math.ceil((scrollTop + viewportHeight) / itemHeight)
      
      // æ·»åŠ ç¼“å†²åŒº
      const bufferSize = 5
      const start = Math.max(0, startIndex - bufferSize)
      const end = Math.min(list.length, endIndex + bufferSize)
      
      this.setData({
        visibleData: list.slice(start, end),
        startIndex: start,
        endIndex: end
      })
    }
  }
})
```

### 2.2 åˆ†é¡µåŠ è½½

```javascript
Page({
  data: {
    list: [],
    page: 1,
    hasMore: true,
    loading: false
  },
  
  async onLoad() {
    await this.loadData()
  },
  
  async onReachBottom() {
    if (!this.data.hasMore || this.data.loading) {
      return
    }
    
    this.setData({
      page: this.data.page + 1
    })
    
    await this.loadData()
  },
  
  async loadData() {
    this.setData({ loading: true })
    
    try {
      const res = await wx.request({
        url: 'https://api.example.com/list',
        data: {
          page: this.data.page,
          size: 20
        }
      })
      
      const newList = res.data.list
      
      this.setData({
        list: [...this.data.list, ...newList],
        hasMore: newList.length === 20
      })
    } finally {
      this.setData({ loading: false })
    }
  },
  
  // ä¸‹æ‹‰åˆ·æ–°
  async onPullDownRefresh() {
    this.setData({
      list: [],
      page: 1,
      hasMore: true
    })
    
    await this.loadData()
    wx.stopPullDownRefresh()
  }
})
```

---

## 3. å›¾ç‰‡ä¼˜åŒ–

### 3.1 å›¾ç‰‡æ‡’åŠ è½½

```html
<!-- pages/list/list.wxml -->
<scroll-view scroll-y bindscroll="onScroll">
  <view wx:for="{{list}}" wx:key="id">
    <image 
      src="{{item.visible ? item.image : placeholderImage}}"
      lazy-load
      mode="aspectFill"
    ></image>
  </view>
</scroll-view>
```

```javascript
Page({
  data: {
    list: [],
    placeholderImage: '/images/placeholder.png'
  },
  
  onScroll(e) {
    const { scrollTop } = e.detail
    const viewportHeight = wx.getSystemInfoSync().windowHeight
    
    // è®¡ç®—å“ªäº›å›¾ç‰‡åº”è¯¥åŠ è½½
    this.data.list.forEach((item, index) => {
      const itemTop = index * 200  // å‡è®¾æ¯é¡¹é«˜åº¦200rpx
      const itemBottom = itemTop + 200
      
      if (itemTop < scrollTop + viewportHeight && itemBottom > scrollTop) {
        this.setData({
          [`list[${index}].visible`]: true
        })
      }
    })
  }
})
```

### 3.2 å›¾ç‰‡é¢„åŠ è½½

```javascript
Page({
  preloadImages() {
    const images = [
      'https://example.com/image1.jpg',
      'https://example.com/image2.jpg',
      'https://example.com/image3.jpg'
    ]
    
    images.forEach(src => {
      wx.getImageInfo({ src })
    })
  }
})
```

### 3.3 å›¾ç‰‡å‹ç¼©

```javascript
Page({
  async compressImage(filePath) {
    const res = await wx.compressImage({
      src: filePath,
      quality: 80  // å‹ç¼©è´¨é‡ 0-100
    })
    
    return res.tempFilePath
  },
  
  async chooseAndCompress() {
    const chooseRes = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed']  // é€‰æ‹©å‹ç¼©å›¾
    })
    
    const compressedPath = await this.compressImage(chooseRes.tempFilePaths[0])
    
    // ä¸Šä¼ å‹ç¼©åçš„å›¾ç‰‡
    this.uploadImage(compressedPath)
  }
})
```

---

## 4. åˆ†åŒ…åŠ è½½

### 4.1 åˆ†åŒ…é…ç½®

```json
// app.json
{
  "pages": [
    "pages/index/index",
    "pages/logs/logs"
  ],
  "subPackages": [
    {
      "root": "packageA",
      "name": "å•†åŸ",
      "pages": [
        "pages/products/products",
        "pages/detail/detail",
        "pages/cart/cart"
      ]
    },
    {
      "root": "packageB",
      "name": "ä¸ªäººä¸­å¿ƒ",
      "pages": [
        "pages/profile/profile",
        "pages/orders/orders",
        "pages/settings/settings"
      ],
      "independent": true  // ç‹¬ç«‹åˆ†åŒ…
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["packageA"]
    }
  }
}
```

### 4.2 åˆ†åŒ…è·³è½¬

```javascript
// è·³è½¬åˆ°åˆ†åŒ…é¡µé¢
wx.navigateTo({
  url: '/packageA/pages/products/products'
})

// é¢„ä¸‹è½½åˆ†åŒ…
wx.preloadSubpackage({
  name: 'packageA',
  success() {
    console.log('åˆ†åŒ…é¢„ä¸‹è½½æˆåŠŸ')
  }
})
```

---

## 5. ç¼“å­˜ç­–ç•¥

### 5.1 æ•°æ®ç¼“å­˜

```javascript
// utils/cache.js
const CACHE_EXPIRE = 5 * 60 * 1000  // 5åˆ†é’Ÿ

export const cache = {
  set(key, value, expire = CACHE_EXPIRE) {
    const data = {
      value,
      expire: Date.now() + expire
    }
    wx.setStorageSync(key, data)
  },
  
  get(key) {
    const data = wx.getStorageSync(key)
    if (!data) return null
    
    if (Date.now() > data.expire) {
      wx.removeStorageSync(key)
      return null
    }
    
    return data.value
  },
  
  remove(key) {
    wx.removeStorageSync(key)
  },
  
  clear() {
    wx.clearStorageSync()
  }
}

// ä½¿ç”¨
import { cache } from '../../utils/cache.js'

Page({
  async loadData() {
    // å…ˆä»ç¼“å­˜è¯»å–
    let data = cache.get('products')
    
    if (!data) {
      // ç¼“å­˜ä¸å­˜åœ¨ï¼Œè¯·æ±‚æ¥å£
      const res = await wx.request({
        url: 'https://api.example.com/products'
      })
      
      data = res.data
      
      // å­˜å…¥ç¼“å­˜
      cache.set('products', data)
    }
    
    this.setData({ products: data })
  }
})
```

### 5.2 å›¾ç‰‡ç¼“å­˜

```javascript
// å°ç¨‹åºä¼šè‡ªåŠ¨ç¼“å­˜å›¾ç‰‡
// ä½¿ç”¨ç›¸åŒçš„URLä¼šä»ç¼“å­˜è¯»å–

// æ¸…é™¤å›¾ç‰‡ç¼“å­˜
wx.removeImageCache({
  success() {
    console.log('å›¾ç‰‡ç¼“å­˜å·²æ¸…é™¤')
  }
})
```

---

## 6. ä»£ç ä¼˜åŒ–

### 6.1 å‡å°‘åŒ…ä½“ç§¯

**1. æ¸…ç†æ— ç”¨ä»£ç **ï¼š
```bash
# ä½¿ç”¨æ„å»ºå·¥å…·
npm run build

# å‹ç¼©å›¾ç‰‡
tinypngã€imagemin
```

**2. ä½¿ç”¨npmåŒ…**ï¼š
```javascript
// æŒ‰éœ€å¼•å…¥
import { formatTime } from 'miniprogram-date-utils'

// è€Œä¸æ˜¯
import * as utils from 'utils'
```

**3. ä»£ç åˆ†ç¦»**ï¼š
```javascript
// å°†å…¬å…±ä»£ç æŠ½ç¦»åˆ°utils
// utils/format.js
export function formatPrice(price) {
  return 'Â¥' + (price / 100).toFixed(2)
}
```

### 6.2 é¿å…ä¸å¿…è¦çš„æ¸²æŸ“

```html
<!-- âŒ é”™è¯¯ï¼šwx:ifé¢‘ç¹åˆ‡æ¢ -->
<view wx:if="{{show}}">å†…å®¹</view>

<!-- âœ… æ­£ç¡®ï¼šhiddenåˆ‡æ¢ -->
<view hidden="{{!show}}">å†…å®¹</view>

<!-- è¯´æ˜ï¼š
  wx:if: æ¡ä»¶ä¸ºfalseæ—¶ä¸æ¸²æŸ“ï¼Œé€‚åˆä¸é¢‘ç¹åˆ‡æ¢
  hidden: å§‹ç»ˆæ¸²æŸ“ï¼Œåªæ˜¯éšè—ï¼Œé€‚åˆé¢‘ç¹åˆ‡æ¢
-->
```

### 6.3 ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶

```javascript
// components/product-item/product-item.js
Component({
  properties: {
    product: Object
  },
  
  methods: {
    onTap() {
      this.triggerEvent('tap', { id: this.data.product.id })
    }
  }
})
```

```html
<!-- pages/list/list.wxml -->
<product-item 
  wx:for="{{products}}" 
  wx:key="id"
  product="{{item}}"
  bind:tap="onProductTap"
></product-item>
```

---

## 7. æ€§èƒ½ç›‘æ§

### 7.1 æ€§èƒ½æ•°æ®ä¸ŠæŠ¥

```javascript
// app.js
App({
  onLaunch() {
    // è·å–æ€§èƒ½æ•°æ®
    const performance = wx.getPerformance()
    
    // ç›‘å¬æ€§èƒ½æ•°æ®
    const observer = performance.createObserver((entryList) => {
      console.log('æ€§èƒ½æ•°æ®', entryList.getEntries())
      
      // ä¸ŠæŠ¥åˆ°åç«¯
      this.reportPerformance(entryList.getEntries())
    })
    
    observer.observe({ entryTypes: ['navigation', 'render', 'script'] })
  },
  
  reportPerformance(entries) {
    wx.request({
      url: 'https://api.example.com/performance',
      method: 'POST',
      data: { entries }
    })
  }
})
```

### 7.2 ä½“éªŒè¯„åˆ†

```javascript
// å°ç¨‹åºåå° â†’ è¿ç»´ä¸­å¿ƒ â†’ æ€§èƒ½ç›‘æ§
// å¯ä»¥çœ‹åˆ°ï¼š
// - å¯åŠ¨è€—æ—¶
// - é¡µé¢åˆ‡æ¢è€—æ—¶
// - é¦–å±æ¸²æŸ“æ—¶é—´
// - å†…å­˜å ç”¨
// - å¡é¡¿æ¬¡æ•°
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ä»£ç è§„èŒƒ

```javascript
// 1. ä½¿ç”¨ES6+è¯­æ³•
const { list } = this.data
const newList = [...list, newItem]

// 2. async/awaitæ›¿ä»£å›è°ƒ
async loadData() {
  const res = await wx.request({ url: '...' })
  this.setData({ data: res.data })
}

// 3. åˆç†çš„æ³¨é‡Š
/**
 * åŠ è½½å•†å“åˆ—è¡¨
 * @param {number} page é¡µç 
 * @param {number} size æ¯é¡µæ•°é‡
 */
async loadProducts(page, size) {
  // ...
}

// 4. é”™è¯¯å¤„ç†
try {
  await this.loadData()
} catch (error) {
  console.error(error)
  wx.showToast({
    title: 'åŠ è½½å¤±è´¥',
    icon: 'none'
  })
}
```

### 8.2 ç›®å½•ç»“æ„

```
miniprogram/
â”œâ”€â”€ pages/               # é¡µé¢
â”‚   â”œâ”€â”€ index/
â”‚   â”œâ”€â”€ detail/
â”‚   â””â”€â”€ profile/
â”œâ”€â”€ components/          # ç»„ä»¶
â”‚   â”œâ”€â”€ product-item/
â”‚   â””â”€â”€ user-card/
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ request.js
â”‚   â”œâ”€â”€ cache.js
â”‚   â””â”€â”€ util.js
â”œâ”€â”€ api/                 # APIæ¥å£
â”‚   â”œâ”€â”€ product.js
â”‚   â””â”€â”€ user.js
â”œâ”€â”€ styles/              # å…¬å…±æ ·å¼
â”‚   â””â”€â”€ common.wxss
â”œâ”€â”€ images/              # å›¾ç‰‡èµ„æº
â””â”€â”€ config/              # é…ç½®æ–‡ä»¶
    â””â”€â”€ index.js
```

### 8.3 ç”¨æˆ·ä½“éªŒ

```javascript
// 1. åŠ è½½æç¤º
wx.showLoading({ title: 'åŠ è½½ä¸­' })
await loadData()
wx.hideLoading()

// 2. ç©ºçŠ¶æ€
<view wx:if="{{list.length === 0}}">
  <text>æš‚æ— æ•°æ®</text>
</view>

// 3. é”™è¯¯æç¤º
wx.showToast({
  title: 'æ“ä½œå¤±è´¥',
  icon: 'none',
  duration: 2000
})

// 4. éª¨æ¶å±
<view wx:if="{{loading}}" class="skeleton">
  <view class="skeleton-item"></view>
  <view class="skeleton-item"></view>
</view>
```

---

## 9. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è°ƒè¯•æ€§èƒ½é—®é¢˜ï¼Ÿ
**A**:
1. å¼€å‘è€…å·¥å…· â†’ è°ƒè¯•å™¨ â†’ Performance
2. æŸ¥çœ‹setDataè°ƒç”¨é¢‘ç‡å’Œæ•°æ®é‡
3. ä½¿ç”¨Traceå·¥å…·åˆ†æ

### Q2: å¦‚ä½•ä¼˜åŒ–é¦–å±åŠ è½½é€Ÿåº¦ï¼Ÿ
**A**:
1. å‡å°‘é¦–å±è¯·æ±‚æ•°é‡
2. ä½¿ç”¨éª¨æ¶å±
3. é¢„åŠ è½½å…³é”®èµ„æº
4. å¯ç”¨åˆ†åŒ…é¢„ä¸‹è½½

### Q3: å¦‚ä½•å‡å°‘åŒ…ä½“ç§¯ï¼Ÿ
**A**:
1. å‹ç¼©å›¾ç‰‡èµ„æº
2. ä½¿ç”¨åˆ†åŒ…åŠ è½½
3. æ¸…ç†æ— ç”¨ä»£ç 
4. ä½¿ç”¨CDNå­˜å‚¨é™æ€èµ„æº

---

## å‚è€ƒèµ„æº

- å°ç¨‹åºæ€§èƒ½ä¼˜åŒ–æŒ‡å—
- å°ç¨‹åºä½“éªŒè¯„åˆ†è§„åˆ™
- å¾®ä¿¡å°ç¨‹åºæœ€ä½³å®è·µ

