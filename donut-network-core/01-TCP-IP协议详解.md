# TCP/IPåè®®è¯¦è§£

## ğŸ’¡ æ ¸å¿ƒç»“è®º

1. **TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œå››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥**
2. **TCPé€šè¿‡åºåˆ—å·ã€ç¡®è®¤å·ã€é‡ä¼ å®ç°å¯é ä¼ è¾“**
3. **æ»‘åŠ¨çª—å£æ§åˆ¶æµé‡ï¼Œæ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…æ§åˆ¶æ‹¥å¡**
4. **TIME_WAITçŠ¶æ€é˜²æ­¢æ—§è¿æ¥æ•°æ®åŒ…å¹²æ‰°æ–°è¿æ¥**
5. **UDPæ— è¿æ¥ã€ä¸å¯é ï¼Œä½†å»¶è¿Ÿä½ï¼Œé€‚åˆå®æ—¶åº”ç”¨**

---

## 1. TCP/IPæ¨¡å‹

### 1.1 å››å±‚æ¨¡å‹

```
åº”ç”¨å±‚    HTTP, FTP, DNS, SMTP
    â†“
ä¼ è¾“å±‚    TCP, UDP
    â†“
ç½‘ç»œå±‚    IP, ICMP, ARP
    â†“
é“¾è·¯å±‚    Ethernet, WiFi
```

### 1.2 æ•°æ®å°è£…

```
åº”ç”¨æ•°æ®
    â†“
[TCPå¤´éƒ¨ | åº”ç”¨æ•°æ®]          TCPæ®µï¼ˆSegmentï¼‰
    â†“
[IPå¤´éƒ¨ | TCPå¤´éƒ¨ | åº”ç”¨æ•°æ®]   IPæ•°æ®åŒ…ï¼ˆPacketï¼‰
    â†“
[ä»¥å¤ªç½‘å¤´éƒ¨ | IPæ•°æ®åŒ… | å°¾éƒ¨]   ä»¥å¤ªç½‘å¸§ï¼ˆFrameï¼‰
```

---

## 2. TCPåè®®

### 2.1 TCPå¤´éƒ¨æ ¼å¼

```c
struct tcp_header {
    uint16_t source_port;      // æºç«¯å£
    uint16_t dest_port;        // ç›®æ ‡ç«¯å£
    uint32_t seq_num;          // åºåˆ—å·
    uint32_t ack_num;          // ç¡®è®¤å·
    uint8_t  data_offset : 4;  // å¤´éƒ¨é•¿åº¦
    uint8_t  reserved : 4;     // ä¿ç•™
    uint8_t  flags;            // æ ‡å¿—ä½
    // URG, ACK, PSH, RST, SYN, FIN
    uint16_t window;           // çª—å£å¤§å°
    uint16_t checksum;         // æ ¡éªŒå’Œ
    uint16_t urgent_ptr;       // ç´§æ€¥æŒ‡é’ˆ
    // å¯é€‰é¡¹...
};
```

**å…³é”®å­—æ®µ**ï¼š
- **seq_num**ï¼šæœ¬æ¬¡å‘é€æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·
- **ack_num**ï¼šæœŸæœ›æ¥æ”¶çš„ä¸‹ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·
- **flags**ï¼šæ§åˆ¶æ ‡å¿—ï¼ˆSYN, ACK, FIN, RSTç­‰ï¼‰
- **window**ï¼šæ¥æ”¶çª—å£å¤§å°

### 2.2 ä¸‰æ¬¡æ¡æ‰‹

```
å®¢æˆ·ç«¯                                  æœåŠ¡å™¨
  â”‚                                       â”‚
  â”‚â”€â”€ SYN seq=x â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  LISTEN
  â”‚                                       â”‚  SYN_RCVD
  â”‚â†â”€ SYN+ACK seq=y, ack=x+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚                                       â”‚
  â”‚â”€â”€ ACK seq=x+1, ack=y+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  ESTABLISHED
  â”‚                                       â”‚
ESTABLISHED                           ESTABLISHED
```

**ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡ï¼Ÿ**
1. **ç¬¬ä¸€æ¬¡**ï¼šå®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡å™¨"æˆ‘è¦è¿æ¥ä½ "
2. **ç¬¬äºŒæ¬¡**ï¼šæœåŠ¡å™¨å›å¤"æˆ‘æ”¶åˆ°äº†ï¼Œæˆ‘ä¹Ÿè¦è¿æ¥ä½ "
3. **ç¬¬ä¸‰æ¬¡**ï¼šå®¢æˆ·ç«¯ç¡®è®¤"å¥½çš„ï¼Œè¿æ¥å»ºç«‹"

**é˜²æ­¢å†å²è¿æ¥**ï¼š
```
å¦‚æœåªæœ‰ä¸¤æ¬¡æ¡æ‰‹ï¼š
1. å®¢æˆ·ç«¯å‘é€SYNï¼ˆä½†ç½‘ç»œå»¶è¿Ÿï¼‰
2. å®¢æˆ·ç«¯è¶…æ—¶é‡å‘SYN
3. æœåŠ¡å™¨æ”¶åˆ°ç¬¬äºŒä¸ªSYNï¼Œå›å¤SYN+ACK
4. è¿æ¥å»ºç«‹ï¼Œæ­£å¸¸é€šä¿¡
5. ç¬¬ä¸€ä¸ªå»¶è¿Ÿçš„SYNåˆ°è¾¾æœåŠ¡å™¨
6. æœåŠ¡å™¨åˆå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼ˆé”™è¯¯ï¼ï¼‰

ä¸‰æ¬¡æ¡æ‰‹å¯ä»¥è®©å®¢æˆ·ç«¯æ‹’ç»æ—§çš„SYN+ACK
```

**ä»£ç ç¤ºä¾‹**ï¼š
```c
// å®¢æˆ·ç«¯
int sockfd = socket(AF_INET, SOCK_STREAM, 0);

struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(8080);
inet_pton(AF_INET, "127.0.0.1", &server_addr.sin_addr);

// å‘èµ·ä¸‰æ¬¡æ¡æ‰‹
connect(sockfd, (struct sockaddr*)&server_addr, sizeof(server_addr));
```

### 2.3 å››æ¬¡æŒ¥æ‰‹

```
å®¢æˆ·ç«¯                                  æœåŠ¡å™¨
  â”‚                                       â”‚
  â”‚â”€â”€ FIN seq=u â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  CLOSE_WAIT
FIN_WAIT_1                                â”‚
  â”‚                                       â”‚
  â”‚â†â”€ ACK ack=u+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
FIN_WAIT_2                                â”‚
  â”‚                                       â”‚
  â”‚â†â”€ FIN seq=v â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  LAST_ACK
TIME_WAIT                                 â”‚
  â”‚                                       â”‚
  â”‚â”€â”€ ACK ack=v+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  CLOSED
  â”‚                                       â”‚
  â”‚ (ç­‰å¾…2MSL)                           â”‚
CLOSED                                    â”‚
```

**ä¸ºä»€ä¹ˆæ˜¯å››æ¬¡ï¼Ÿ**
- TCPæ˜¯å…¨åŒå·¥ï¼ŒåŒæ–¹éƒ½éœ€è¦å…³é—­
- **ç¬¬ä¸€æ¬¡**ï¼šå®¢æˆ·ç«¯è¯´"æˆ‘å‘å®Œäº†"ï¼ˆFINï¼‰
- **ç¬¬äºŒæ¬¡**ï¼šæœåŠ¡å™¨è¯´"æˆ‘çŸ¥é“äº†"ï¼ˆACKï¼‰
- **ç¬¬ä¸‰æ¬¡**ï¼šæœåŠ¡å™¨è¯´"æˆ‘ä¹Ÿå‘å®Œäº†"ï¼ˆFINï¼‰
- **ç¬¬å››æ¬¡**ï¼šå®¢æˆ·ç«¯è¯´"æˆ‘çŸ¥é“äº†"ï¼ˆACKï¼‰

**TIME_WAITçŠ¶æ€**ï¼š
- æŒç»­æ—¶é—´ï¼š2MSLï¼ˆMaximum Segment Lifetimeï¼Œé€šå¸¸60ç§’ï¼‰
- ç›®çš„ï¼š
  1. ç¡®ä¿æœ€åçš„ACKåˆ°è¾¾å¯¹æ–¹
  2. è®©æ—§è¿æ¥çš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­æ¶ˆå¤±

**ä»£ç ç¤ºä¾‹**ï¼š
```c
// å…³é—­è¿æ¥
close(sockfd);  // è§¦å‘å››æ¬¡æŒ¥æ‰‹

// é¿å…TIME_WAITçš„socketå¤ç”¨
int reuse = 1;
setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse));
```

### 2.4 å¯é ä¼ è¾“

**åºåˆ—å·å’Œç¡®è®¤å·**ï¼š
```
å‘é€æ–¹: seq=100, å‘é€100å­—èŠ‚
æ¥æ”¶æ–¹: ack=200 (æœŸæœ›æ¥æ”¶ç¬¬200å­—èŠ‚)

å‘é€æ–¹: seq=200, å‘é€50å­—èŠ‚
æ¥æ”¶æ–¹: ack=250

åºåˆ—å·æ ‡è¯†æ•°æ®ä½ç½®ï¼Œç¡®è®¤å·ç¡®è®¤æ”¶åˆ°
```

**è¶…æ—¶é‡ä¼ **ï¼š
```c
// ç®€åŒ–çš„é‡ä¼ æœºåˆ¶
struct retransmit {
    uint32_t seq;
    uint8_t* data;
    int len;
    struct timeval send_time;
    int retries;
};

void check_timeout() {
    struct timeval now;
    gettimeofday(&now, NULL);
    
    for (packet in sent_queue) {
        if (now - packet.send_time > RTO) {
            // è¶…æ—¶ï¼Œé‡ä¼ 
            send_packet(packet);
            packet.retries++;
            packet.send_time = now;
        }
    }
}
```

**å¿«é€Ÿé‡ä¼ **ï¼š
```
æ¥æ”¶æ–¹æ”¶åˆ°ä¹±åºåŒ…æ—¶ï¼Œç«‹å³å‘é€é‡å¤ACK

å‘é€æ–¹æ”¶åˆ°3ä¸ªé‡å¤ACKï¼Œç«‹å³é‡ä¼ 
ï¼ˆä¸ç­‰è¶…æ—¶ï¼‰

seq=100 â”€â”€â”€â†’ âœ“ ack=200
seq=200 â”€â”€â”€â†’ âœ— ä¸¢å¤±
seq=300 â”€â”€â”€â†’ âœ“ ack=200 (é‡å¤1)
seq=400 â”€â”€â”€â†’ âœ“ ack=200 (é‡å¤2)
seq=500 â”€â”€â”€â†’ âœ“ ack=200 (é‡å¤3)
seq=200 â”€â”€â”€â†’ âœ“ å¿«é€Ÿé‡ä¼ ï¼
```

### 2.5 æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰

**åŸç†**ï¼šæ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹è‡ªå·±çš„ç¼“å†²åŒºå¤§å°

```c
æ¥æ”¶æ–¹:
recv_window = BUFFER_SIZE - (next_seq - acked_seq)
åœ¨TCPå¤´éƒ¨çš„windowå­—æ®µé€šçŸ¥å‘é€æ–¹

å‘é€æ–¹:
send_window = min(recv_window, cwnd)  // cwndæ˜¯æ‹¥å¡çª—å£
åªèƒ½å‘é€send_windowå¤§å°çš„æ•°æ®

ç¤ºä¾‹:
æ¥æ”¶æ–¹ç¼“å†²åŒº: 4KB
å·²æ¥æ”¶æœªå¤„ç†: 2KB
â†’ é€šå‘Šçª—å£: 2KB

å‘é€æ–¹æœ€å¤šå†å‘2KBæ•°æ®
```

**é›¶çª—å£æ¢æµ‹**ï¼š
```c
// æ¥æ”¶æ–¹çª—å£ä¸º0
while (recv_window == 0) {
    // å‘é€æ–¹å®šæœŸå‘é€1å­—èŠ‚æ¢æµ‹åŒ…
    send_probe();
    sleep(probe_interval);
}
```

### 2.6 æ‹¥å¡æ§åˆ¶

**å››ä¸ªç®—æ³•**ï¼š

**1. æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰**
```
åˆå§‹cwnd = 1 MSS
æ¯æ”¶åˆ°ä¸€ä¸ªACKï¼Œcwnd += 1
æŒ‡æ•°å¢é•¿: 1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 ...

åˆ°è¾¾ssthreshï¼ˆæ…¢å¯åŠ¨é˜ˆå€¼ï¼‰åï¼Œè¿›å…¥æ‹¥å¡é¿å…
```

**2. æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰**
```
çº¿æ€§å¢é•¿: cwnd += 1/cwnd (æ¯RTTå¢åŠ 1)
16 â†’ 17 â†’ 18 â†’ 19 ...

å¦‚æœå‘ç”Ÿè¶…æ—¶:
  ssthresh = cwnd / 2
  cwnd = 1
  é‡æ–°æ…¢å¯åŠ¨
```

**3. å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰**
```
æ”¶åˆ°3ä¸ªé‡å¤ACK:
  ç«‹å³é‡ä¼ ä¸¢å¤±çš„åŒ…
  è¿›å…¥å¿«é€Ÿæ¢å¤
```

**4. å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰**
```
æ”¶åˆ°3ä¸ªé‡å¤ACKå:
  ssthresh = cwnd / 2
  cwnd = ssthresh + 3
  çº¿æ€§å¢é•¿

æ”¶åˆ°æ–°ACK:
  cwnd = ssthresh
  è¿›å…¥æ‹¥å¡é¿å…
```

**æ‹¥å¡æ§åˆ¶å›¾ç¤º**ï¼š
```
cwnd
 â”‚     æ…¢å¯åŠ¨    â”‚  æ‹¥å¡é¿å…  â”‚å¿«é€Ÿæ¢å¤â”‚æ‹¥å¡é¿å…
 â”‚    /          â”‚  /         â”‚/       â”‚ /
 â”‚   /           â”‚ /          â”‚        â”‚/
 â”‚  /            â”‚/           â”‚        â”‚
 â”‚ /             â†“ 3ä¸ªé‡å¤ACK â”‚        â”‚
 â”‚/              â”‚            â†“        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
```

---

## 3. UDPåè®®

### 3.1 UDPå¤´éƒ¨æ ¼å¼

```c
struct udp_header {
    uint16_t source_port;   // æºç«¯å£ (2å­—èŠ‚)
    uint16_t dest_port;     // ç›®æ ‡ç«¯å£ (2å­—èŠ‚)
    uint16_t length;        // UDPé•¿åº¦ (2å­—èŠ‚)
    uint16_t checksum;      // æ ¡éªŒå’Œ (2å­—èŠ‚)
    // æ•°æ®éƒ¨åˆ†...
};
// æ€»å…±åªæœ‰8å­—èŠ‚ï¼
```

### 3.2 UDPç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… æ— è¿æ¥ï¼Œæ— æ¡æ‰‹å¼€é”€
- âœ… ä½å»¶è¿Ÿï¼ˆæ— é‡ä¼ ç­‰å¾…ï¼‰
- âœ… å¤´éƒ¨ç®€å•ï¼ˆåªæœ‰8å­—èŠ‚ï¼‰
- âœ… æ”¯æŒå¹¿æ’­å’Œå¤šæ’­

**ç¼ºç‚¹**ï¼š
- âŒ ä¸å¯é ï¼ˆå¯èƒ½ä¸¢åŒ…ã€ä¹±åºã€é‡å¤ï¼‰
- âŒ æ— æµé‡æ§åˆ¶
- âŒ æ— æ‹¥å¡æ§åˆ¶

### 3.3 UDP vs TCP

| ç‰¹æ€§ | TCP | UDP |
|------|-----|-----|
| è¿æ¥ | é¢å‘è¿æ¥ | æ— è¿æ¥ |
| å¯é æ€§ | å¯é  | ä¸å¯é  |
| é¡ºåº | æœ‰åº | å¯èƒ½ä¹±åº |
| é€Ÿåº¦ | æ…¢ï¼ˆå¤´éƒ¨20-60å­—èŠ‚ï¼‰ | å¿«ï¼ˆå¤´éƒ¨8å­—èŠ‚ï¼‰ |
| åº”ç”¨ | HTTP, FTP, SSH | DNS, è§†é¢‘, æ¸¸æˆ |

### 3.4 UDPåº”ç”¨åœºæ™¯

```
âœ… DNSæŸ¥è¯¢ï¼šå•ä¸ªæ•°æ®åŒ…ï¼Œä¸¢åŒ…é‡æŸ¥å³å¯
âœ… è§†é¢‘ç›´æ’­ï¼šå®æ—¶æ€§ä¼˜å…ˆï¼Œä¸¢å‡ å¸§æ— æ‰€è°“
âœ… åœ¨çº¿æ¸¸æˆï¼šä½å»¶è¿Ÿä¼˜å…ˆï¼Œä¸¢åŒ…æ’å€¼
âœ… VoIPï¼šå®æ—¶è¯­éŸ³ï¼Œå»¶è¿Ÿ>å¯é æ€§
âœ… DHCPï¼šç®€å•è¯·æ±‚-å“åº”

âŒ æ–‡ä»¶ä¼ è¾“ï¼šéœ€è¦å¯é æ€§
âŒ ç½‘é¡µæµè§ˆï¼šéœ€è¦å®Œæ•´æ•°æ®
âŒ é‚®ä»¶ï¼šéœ€è¦å¯é æ€§
```

### 3.5 UDPç¼–ç¨‹ç¤ºä¾‹

```c
// UDPæœåŠ¡å™¨
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);

struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(8080);
server_addr.sin_addr.s_addr = INADDR_ANY;

bind(sockfd, (struct sockaddr*)&server_addr, sizeof(server_addr));

char buffer[1024];
struct sockaddr_in client_addr;
socklen_t addr_len = sizeof(client_addr);

while (1) {
    int n = recvfrom(sockfd, buffer, sizeof(buffer), 0,
                    (struct sockaddr*)&client_addr, &addr_len);
    
    printf("Received: %s\n", buffer);
    
    sendto(sockfd, buffer, n, 0,
           (struct sockaddr*)&client_addr, addr_len);
}

// UDPå®¢æˆ·ç«¯
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);

struct sockaddr_in server_addr;
server_addr.sin_family = AF_INET;
server_addr.sin_port = htons(8080);
inet_pton(AF_INET, "127.0.0.1", &server_addr.sin_addr);

const char* message = "Hello UDP";
sendto(sockfd, message, strlen(message), 0,
       (struct sockaddr*)&server_addr, sizeof(server_addr));

char buffer[1024];
int n = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);
printf("Response: %s\n", buffer);
```

---

## 4. IPåè®®

### 4.1 IPåœ°å€

**IPv4**ï¼š
```
32ä½ï¼Œ4ä¸ªå­—èŠ‚
ç‚¹åˆ†åè¿›åˆ¶ï¼š192.168.1.1

ç½‘ç»œéƒ¨åˆ† + ä¸»æœºéƒ¨åˆ†
Aç±»ï¼š0.0.0.0 - 127.255.255.255
Bç±»ï¼š128.0.0.0 - 191.255.255.255
Cç±»ï¼š192.0.0.0 - 223.255.255.255

å­ç½‘æ©ç ï¼š255.255.255.0 (/24)
ç½‘ç»œåœ°å€ï¼š192.168.1.0
å¹¿æ’­åœ°å€ï¼š192.168.1.255
å¯ç”¨ä¸»æœºï¼š192.168.1.1 - 192.168.1.254
```

**IPv6**ï¼š
```
128ä½ï¼Œ16ä¸ªå­—èŠ‚
å†’å·åå…­è¿›åˆ¶ï¼š2001:0db8:85a3:0000:0000:8a2e:0370:7334

ç®€åŒ–ï¼š
2001:db8:85a3::8a2e:370:7334
ï¼ˆè¿ç»­çš„0å¯çœç•¥ï¼‰
```

### 4.2 IPæ•°æ®åŒ…æ ¼å¼

```c
struct ip_header {
    uint8_t  version : 4;       // ç‰ˆæœ¬å· (4)
    uint8_t  ihl : 4;           // å¤´éƒ¨é•¿åº¦
    uint8_t  tos;               // æœåŠ¡ç±»å‹
    uint16_t total_length;      // æ€»é•¿åº¦
    uint16_t identification;    // æ ‡è¯†
    uint16_t flags : 3;         // æ ‡å¿—
    uint16_t fragment_offset : 13; // ç‰‡åç§»
    uint8_t  ttl;               // ç”Ÿå­˜æ—¶é—´
    uint8_t  protocol;          // åè®® (TCP=6, UDP=17)
    uint16_t checksum;          // æ ¡éªŒå’Œ
    uint32_t source_ip;         // æºIP
    uint32_t dest_ip;           // ç›®æ ‡IP
    // å¯é€‰é¡¹...
};
```

### 4.3 IPè·¯ç”±

**è·¯ç”±è¡¨**ï¼š
```bash
# æŸ¥çœ‹è·¯ç”±è¡¨
$ route -n
Destination     Gateway         Genmask         Flags Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     eth0

# è·¯ç”±é€‰æ‹©ï¼šæœ€é•¿å‰ç¼€åŒ¹é…
ç›®æ ‡: 192.168.1.100
åŒ¹é…: 192.168.1.0/24ï¼ˆæ›´å…·ä½“ï¼‰â†’ ç›´æ¥æŠ•é€’
ä¸åŒ¹é…: 0.0.0.0/0 â†’ é»˜è®¤ç½‘å…³
```

### 4.4 NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰

```
å†…ç½‘ â†’ å¤–ç½‘
æºIP: 192.168.1.100:5000
NATè½¬æ¢: 203.0.113.5:60000
ç›®æ ‡IP: 8.8.8.8:53

å¤–ç½‘ â†’ å†…ç½‘
æºIP: 8.8.8.8:53
ç›®æ ‡IP: 203.0.113.5:60000
NATè½¬æ¢: 192.168.1.100:5000

NATè¡¨:
å†…éƒ¨åœ°å€:ç«¯å£         å¤–éƒ¨åœ°å€:ç«¯å£
192.168.1.100:5000 â†” 203.0.113.5:60000
192.168.1.101:6000 â†” 203.0.113.5:60001
```

---

## 5. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆTIME_WAITè¦ç­‰2MSLï¼Ÿ
**A**:
1. ç¡®ä¿æœ€åçš„ACKåˆ°è¾¾ï¼ˆå¦‚æœä¸¢å¤±ï¼Œå¯¹æ–¹ä¼šé‡å‘FINï¼Œéœ€è¦èƒ½æ¥æ”¶å¹¶å›å¤ï¼‰
2. è®©æ—§è¿æ¥çš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­æ¶ˆå¤±

### Q2: å¦‚ä½•å‡å°‘TIME_WAITï¼Ÿ
**A**:
- è°ƒæ•´`tcp_tw_reuse`å’Œ`tcp_tw_recycle`ï¼ˆéœ€è°¨æ…ï¼‰
- ä½¿ç”¨SO_REUSEADDR
- å®¢æˆ·ç«¯ä½¿ç”¨çŸ­è¿æ¥ï¼Œç”±å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­

### Q3: TCPä¸ºä»€ä¹ˆéœ€è¦Nagleç®—æ³•ï¼Ÿ
**A**:
- åˆå¹¶å°åŒ…ï¼Œå‡å°‘ç½‘ç»œæ‹¥å¡
- ä½†å¢åŠ å»¶è¿Ÿï¼Œäº¤äº’å¼åº”ç”¨éœ€ç¦ç”¨ï¼ˆTCP_NODELAYï¼‰

### Q4: ä¸ºä»€ä¹ˆUDPä¸å¯é ä½†è¿˜è¦ç”¨ï¼Ÿ
**A**:
- ä½å»¶è¿Ÿä¼˜å…ˆçº§é«˜äºå¯é æ€§ï¼ˆå®æ—¶åº”ç”¨ï¼‰
- å¯ä»¥åœ¨åº”ç”¨å±‚å®ç°å¯é æ€§ï¼ˆå¦‚QUICï¼‰

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 TCPä¼˜åŒ–

```bash
# å¢å¤§ç¼“å†²åŒº
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216

# TCPçª—å£ç¼©æ”¾
sysctl -w net.ipv4.tcp_window_scaling=1

# å¿«é€Ÿå›æ”¶TIME_WAIT
sysctl -w net.ipv4.tcp_tw_reuse=1

# SYNé˜Ÿåˆ—å¤§å°
sysctl -w net.ipv4.tcp_max_syn_backlog=8192

# è¿æ¥é˜Ÿåˆ—å¤§å°
sysctl -w net.core.somaxconn=1024
```

### 6.2 åº”ç”¨å±‚ä¼˜åŒ–

```c
// TCP_NODELAY: ç¦ç”¨Nagleç®—æ³•
int flag = 1;
setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, &flag, sizeof(flag));

// SO_KEEPALIVE: ä¿æ´»æœºåˆ¶
int keepalive = 1;
setsockopt(sockfd, SOL_SOCKET, SO_KEEPALIVE, &keepalive, sizeof(keepalive));

// SO_RCVBUF: æ¥æ”¶ç¼“å†²åŒº
int bufsize = 8192;
setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, &bufsize, sizeof(bufsize));
```

---

## å‚è€ƒèµ„æº

- ã€ŠTCP/IPè¯¦è§£ å·1ï¼šåè®®ã€‹
- RFC 793 (TCP)
- RFC 768 (UDP)
- Linuxæºç ï¼š`net/ipv4/tcp.c`
- Wiresharkå®æˆ˜æ•™ç¨‹

