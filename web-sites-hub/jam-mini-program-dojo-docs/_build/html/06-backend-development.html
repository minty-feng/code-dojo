

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åç«¯å¼€å‘ä¸é›†æˆ &mdash; Mini Program Tutorial 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d25bc049" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=af2ce170"></script>
      <script src="_static/doctools.js?v=888ff710"></script>
      <script src="_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="_static/copy-code.js?v=caf91246"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="æµ‹è¯•ä¸è°ƒè¯•" href="05-testing-and-debugging.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #07c160" >

          
          
          <a href="index.html" class="icon icon-home">
            Mini Program Tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ç›®å½•</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">WeChat Mini Program Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="01-wechat-miniprogram-basics.html">åŸºç¡€</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-network-request-and-cloud.html">ç½‘ç»œè¯·æ±‚ä¸äº‘å¼€å‘</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-performance-optimization.html">æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-deployment-and-release.html">éƒ¨ç½²ä¸å‘å¸ƒ</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-testing-and-debugging.html">æµ‹è¯•ä¸è°ƒè¯•</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">åç«¯å¼€å‘ä¸é›†æˆ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">ğŸ’¡ æ ¸å¿ƒç»“è®º</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">1. åç«¯æ¶æ„è®¾è®¡</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">1.1 æŠ€æœ¯é€‰å‹</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">1.2 é¡¹ç›®ç»“æ„</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">2. ç”¨æˆ·ç™»å½•ä¸è®¤è¯</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">2.1 å¾®ä¿¡ç™»å½•æµç¨‹</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jwt">2.2 JWTè®¤è¯ä¸­é—´ä»¶</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">2.3 è·¯ç”±é…ç½®</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#api">3. APIè®¾è®¡</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#restful">3.1 RESTfulè§„èŒƒ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">3.2 ç»Ÿä¸€å“åº”æ ¼å¼</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.3 å•†å“APIç¤ºä¾‹</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">4. æ•°æ®åº“è®¾è®¡</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mongodb">4.1 MongoDBæ¨¡å‹è®¾è®¡</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">4.2 æ•°æ®åº“è¿æ¥</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id13">5. ä¸šåŠ¡é€»è¾‘</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">5.1 è®¢å•æœåŠ¡</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id15">6. å®‰å…¨æªæ–½</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id16">6.1 å‚æ•°æ ¡éªŒ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sql">6.2 SQLæ³¨å…¥é˜²æŠ¤</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xss">6.3 XSSé˜²æŠ¤</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">6.4 é™æµ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#https">6.5 HTTPS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id18">7. é”™è¯¯å¤„ç†</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id19">7.1 å…¨å±€é”™è¯¯å¤„ç†</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">7.2 å¼‚æ­¥é”™è¯¯å¤„ç†</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id21">8. éƒ¨ç½²</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker">8.1 Dockeréƒ¨ç½²</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pm2">8.2 PM2éƒ¨ç½²</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id22">9. å¸¸è§é—®é¢˜</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#q1">Q1: å¦‚ä½•å¤„ç†é«˜å¹¶å‘ï¼Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q2">Q2: å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q3-api">Q3: å¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id23">å‚è€ƒèµ„æº</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #07c160" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Mini Program Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">åç«¯å¼€å‘ä¸é›†æˆ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/06-backend-development.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>åç«¯å¼€å‘ä¸é›†æˆ<a class="headerlink" href="#id1" title="Permalink to this heading">ïƒ</a></h1>
<section id="id2">
<h2>ğŸ’¡ æ ¸å¿ƒç»“è®º<a class="headerlink" href="#id2" title="Permalink to this heading">ïƒ</a></h2>
<ol class="arabic simple">
<li><p><strong>å°ç¨‹åºåç«¯éœ€è¦å¤„ç†ç”¨æˆ·ç™»å½•ã€æ•°æ®å­˜å‚¨ã€ä¸šåŠ¡é€»è¾‘ç­‰</strong></p></li>
<li><p><strong>RESTful APIè®¾è®¡è¦éµå¾ªRESTè§„èŒƒï¼Œè¿”å›ç»Ÿä¸€æ ¼å¼</strong></p></li>
<li><p><strong>JWT Tokenæ˜¯å¸¸ç”¨çš„èº«ä»½è®¤è¯æ–¹æ¡ˆ</strong></p></li>
<li><p><strong>æ•°æ®åº“è®¾è®¡è¦è€ƒè™‘æ€§èƒ½ã€æ‰©å±•æ€§å’Œæ•°æ®ä¸€è‡´æ€§</strong></p></li>
<li><p><strong>å®‰å…¨æªæ–½åŒ…æ‹¬HTTPSã€å‚æ•°æ ¡éªŒã€SQLæ³¨å…¥é˜²æŠ¤ç­‰</strong></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="id3">
<h2>1. åç«¯æ¶æ„è®¾è®¡<a class="headerlink" href="#id3" title="Permalink to this heading">ïƒ</a></h2>
<section id="id4">
<h3>1.1 æŠ€æœ¯é€‰å‹<a class="headerlink" href="#id4" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>Node.js + Express</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// é€‚åˆå¿«é€Ÿå¼€å‘ï¼Œç”Ÿæ€ä¸°å¯Œ</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Node.js + Koa</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// æ›´è½»é‡ï¼Œæ”¯æŒasync/await</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Koa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Koa</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Hello World&#39;</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Python + Flask</strong>ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ç®€æ´æ˜“ç”¨</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="p">[]}</span>
</pre></div>
</div>
<p><strong>Go + Gin</strong>ï¼š</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// é«˜æ€§èƒ½ï¼Œé€‚åˆé«˜å¹¶å‘</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;github.com/gin-gonic/gin&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">Default</span><span class="p">()</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/api/products&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">)</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>1.2 é¡¹ç›®ç»“æ„<a class="headerlink" href="#id5" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/     # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ user.js
â”‚   â”‚   â””â”€â”€ product.js
â”‚   â”œâ”€â”€ models/          # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.js
â”‚   â”‚   â””â”€â”€ product.js
â”‚   â”œâ”€â”€ services/        # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â””â”€â”€ order.js
â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â””â”€â”€ error.js
â”‚   â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ response.js
â”‚   â”‚   â””â”€â”€ validator.js
â”‚   â”œâ”€â”€ routes/          # è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â””â”€â”€ api.js
â”‚   â””â”€â”€ app.js           # å…¥å£æ–‡ä»¶
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ database.js
â”œâ”€â”€ tests/               # æµ‹è¯•
â””â”€â”€ package.json
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2>2. ç”¨æˆ·ç™»å½•ä¸è®¤è¯<a class="headerlink" href="#id6" title="Permalink to this heading">ïƒ</a></h2>
<section id="id7">
<h3>2.1 å¾®ä¿¡ç™»å½•æµç¨‹<a class="headerlink" href="#id7" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// controllers/auth.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsonwebtoken&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">AuthController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// å¾®ä¿¡ç™»å½•</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">wechatLogin</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;codeä¸èƒ½ä¸ºç©º&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 1. ç”¨codeæ¢å–openidå’Œsession_key</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">wechatRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;https://api.weixin.qq.com/sns/jscode2session&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">appid</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">WECHAT_APPID</span><span class="p">,</span>
<span class="w">          </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">WECHAT_SECRET</span><span class="p">,</span>
<span class="w">          </span><span class="nx">js_code</span><span class="o">:</span><span class="w"> </span><span class="nx">code</span><span class="p">,</span>
<span class="w">          </span><span class="nx">grant_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;authorization_code&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">openid</span><span class="p">,</span><span class="w"> </span><span class="nx">session_key</span><span class="p">,</span><span class="w"> </span><span class="nx">errcode</span><span class="p">,</span><span class="w"> </span><span class="nx">errmsg</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wechatRes</span><span class="p">.</span><span class="nx">data</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">          </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">errmsg</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;ç™»å½•å¤±è´¥&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">openid</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">          </span><span class="nx">openid</span><span class="p">,</span>
<span class="w">          </span><span class="nx">sessionKey</span><span class="o">:</span><span class="w"> </span><span class="nx">session_key</span><span class="p">,</span>
<span class="w">          </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ›´æ–°session_key</span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">sessionKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">session_key</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 3. ç”ŸæˆJWT token</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span><span class="w"> </span><span class="nx">openid</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;7d&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">token</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userInfo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">nickname</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">nickname</span><span class="p">,</span>
<span class="w">            </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ç™»å½•å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// è·å–ç”¨æˆ·ä¿¡æ¯</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getUserInfo</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">          </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">404</span><span class="p">,</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç”¨æˆ·ä¸å­˜åœ¨&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">nickname</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">nickname</span><span class="p">,</span>
<span class="w">          </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="p">,</span>
<span class="w">          </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">phone</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ›´æ–°ç”¨æˆ·ä¿¡æ¯</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateUserInfo</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">nickname</span><span class="p">,</span><span class="w"> </span><span class="nx">avatar</span><span class="p">,</span><span class="w"> </span><span class="nx">phone</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickname</span><span class="p">)</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">nickname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickname</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">avatar</span><span class="p">)</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">avatar</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">phone</span><span class="p">)</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">phone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">phone</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°æˆåŠŸ&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°å¤±è´¥&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AuthController</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="jwt">
<h3>2.2 JWTè®¤è¯ä¸­é—´ä»¶<a class="headerlink" href="#jwt" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// middleware/auth.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsonwebtoken&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/user&#39;</span><span class="p">)</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä»headerè·å–token</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">401</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æœªç™»å½•&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// éªŒè¯token</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">decoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æŸ¥è¯¢ç”¨æˆ·</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">decoded</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">401</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç”¨æˆ·ä¸å­˜åœ¨&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// å°†ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ°request</span>
<span class="w">    </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">openid</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">openid</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">next</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;TokenExpiredError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">401</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tokenå·²è¿‡æœŸ&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">401</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tokenæ— æ•ˆ&#39;</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authMiddleware</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>2.3 è·¯ç”±é…ç½®<a class="headerlink" href="#id8" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// routes/api.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">()</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/auth&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/auth&#39;</span><span class="p">)</span>

<span class="c1">// ç™»å½•ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/auth/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authController</span><span class="p">.</span><span class="nx">wechatLogin</span><span class="p">)</span>

<span class="c1">// éœ€è¦è®¤è¯çš„è·¯ç”±</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/user&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">,</span><span class="w"> </span><span class="nx">authController</span><span class="p">.</span><span class="nx">getUserInfo</span><span class="p">)</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/auth/user&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">,</span><span class="w"> </span><span class="nx">authController</span><span class="p">.</span><span class="nx">updateUserInfo</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">router</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="api">
<h2>3. APIè®¾è®¡<a class="headerlink" href="#api" title="Permalink to this heading">ïƒ</a></h2>
<section id="restful">
<h3>3.1 RESTfulè§„èŒƒ<a class="headerlink" href="#restful" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// GET    /api/products          # è·å–å•†å“åˆ—è¡¨</span>
<span class="c1">// GET    /api/products/:id      # è·å–å•†å“è¯¦æƒ…</span>
<span class="c1">// POST   /api/products          # åˆ›å»ºå•†å“</span>
<span class="c1">// PUT    /api/products/:id      # æ›´æ–°å•†å“</span>
<span class="c1">// DELETE /api/products/:id     # åˆ é™¤å•†å“</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>3.2 ç»Ÿä¸€å“åº”æ ¼å¼<a class="headerlink" href="#id9" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// utils/response.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">success</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;æˆåŠŸ&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">pagination</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æˆåŠŸ&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">list</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pagination</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">total</span><span class="p">,</span>
<span class="w">          </span><span class="nx">page</span><span class="p">,</span>
<span class="w">          </span><span class="nx">size</span><span class="p">,</span>
<span class="w">          </span><span class="nx">totalPages</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Response</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>3.3 å•†å“APIç¤ºä¾‹<a class="headerlink" href="#id10" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// controllers/product.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/product&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/response&#39;</span><span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ProductController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// è·å–å•†å“åˆ—è¡¨</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getList</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="p">,</span><span class="w"> </span><span class="nx">keyword</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">category</span><span class="p">)</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">category</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">keyword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">query</span><span class="p">.</span><span class="nx">$or</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">keyword</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">keyword</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">size</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">        </span><span class="nx">Product</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
<span class="w">          </span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">skip</span><span class="p">)</span>
<span class="w">          </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span>
<span class="w">          </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}),</span>
<span class="w">        </span><span class="nx">Product</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
<span class="w">      </span><span class="p">])</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">pagination</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">page</span><span class="p">),</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">size</span><span class="p">)))</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;è·å–å•†å“åˆ—è¡¨å¤±è´¥&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// è·å–å•†å“è¯¦æƒ…</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getDetail</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">404</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;å•†å“ä¸å­˜åœ¨&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">product</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;è·å–å•†å“è¯¦æƒ…å¤±è´¥&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// åˆ›å»ºå•†å“</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºæˆåŠŸ&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;åˆ›å»ºå¤±è´¥&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ›´æ–°å•†å“</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">update</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span>
<span class="w">        </span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="ow">new</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">404</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;å•†å“ä¸å­˜åœ¨&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°æˆåŠŸ&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°å¤±è´¥&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// åˆ é™¤å•†å“</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="ow">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">404</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;å•†å“ä¸å­˜åœ¨&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;åˆ é™¤æˆåŠŸ&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;åˆ é™¤å¤±è´¥&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ProductController</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id11">
<h2>4. æ•°æ®åº“è®¾è®¡<a class="headerlink" href="#id11" title="Permalink to this heading">ïƒ</a></h2>
<section id="mongodb">
<h3>4.1 MongoDBæ¨¡å‹è®¾è®¡<a class="headerlink" href="#mongodb" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// models/user.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">userSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
<span class="w">  </span><span class="nx">openid</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">sessionKey</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">nickname</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">  </span><span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">userSchema</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// models/product.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">productSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">originalPrice</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">}],</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">sales</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="kr">enum</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;on_sale&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;off_sale&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;deleted&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;on_sale&#39;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>

<span class="c1">// ç´¢å¼•</span>
<span class="nx">productSchema</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">productSchema</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">productSchema</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// models/order.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">orderSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
<span class="w">  </span><span class="nx">orderNo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ref</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;User&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">ref</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">}],</span>
<span class="w">  </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span>
<span class="w">    </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="kr">enum</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;paid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">province</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">city</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">district</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="nx">detail</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">,</span>
<span class="w">    </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Order&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">orderSchema</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3>4.2 æ•°æ®åº“è¿æ¥<a class="headerlink" href="#id12" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// config/database.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">connectDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">useNewUrlParser</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">useUnifiedTopology</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;MongoDBè¿æ¥æˆåŠŸ&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;MongoDBè¿æ¥å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectDB</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id13">
<h2>5. ä¸šåŠ¡é€»è¾‘<a class="headerlink" href="#id13" title="Permalink to this heading">ïƒ</a></h2>
<section id="id14">
<h3>5.1 è®¢å•æœåŠ¡<a class="headerlink" href="#id14" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// services/order.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/order&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/product&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/response&#39;</span><span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">OrderService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// åˆ›å»ºè®¢å•</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createOrder</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. éªŒè¯å•†å“åº“å­˜</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`å•†å“</span><span class="si">${</span><span class="nx">product</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="si">}</span><span class="sb">åº“å­˜ä¸è¶³`</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. è®¡ç®—æ€»ä»·</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">orderItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">itemTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span>
<span class="w">      </span><span class="nx">totalAmount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">itemTotal</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">orderItems</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span>
<span class="w">        </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span>
<span class="w">        </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. ç”Ÿæˆè®¢å•å·</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">orderNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateOrderNo</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 4. åˆ›å»ºè®¢å•</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Order</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">orderNo</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="nx">orderItems</span><span class="p">,</span>
<span class="w">      </span><span class="nx">totalAmount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">address</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 5. æ‰£å‡åº“å­˜</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">$inc</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">order</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ç”Ÿæˆè®¢å•å·</span>
<span class="w">  </span><span class="nx">generateOrderNo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10000</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`ORDER</span><span class="si">${</span><span class="nx">timestamp</span><span class="si">}${</span><span class="nx">random</span><span class="si">}</span><span class="sb">`</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ”¯ä»˜è®¢å•</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">payOrder</span><span class="p">(</span><span class="nx">orderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Order</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">orderId</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;è®¢å•ä¸å­˜åœ¨&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;è®¢å•çŠ¶æ€ä¸æ­£ç¡®&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ›´æ–°è®¢å•çŠ¶æ€</span>
<span class="w">    </span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;paid&#39;</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// å¢åŠ å•†å“é”€é‡</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">$inc</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sales</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">order</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å–æ¶ˆè®¢å•</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">cancelOrder</span><span class="p">(</span><span class="nx">orderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Order</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">orderId</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;è®¢å•ä¸å­˜åœ¨&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;è®¢å•æ— æ³•å–æ¶ˆ&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ¢å¤åº“å­˜</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;paid&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span>
<span class="w">          </span><span class="nx">item</span><span class="p">.</span><span class="nx">productId</span><span class="p">,</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">$inc</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">order</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OrderService</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id15">
<h2>6. å®‰å…¨æªæ–½<a class="headerlink" href="#id15" title="Permalink to this heading">ïƒ</a></h2>
<section id="id16">
<h3>6.1 å‚æ•°æ ¡éªŒ<a class="headerlink" href="#id16" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// utils/validator.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Validator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">validateRequired</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">field</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">field</span><span class="si">}</span><span class="sb">ä¸èƒ½ä¸ºç©º`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">validateNumber</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">field</span><span class="p">,</span><span class="w"> </span><span class="nx">min</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">num</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">field</span><span class="si">}</span><span class="sb">å¿…é¡»æ˜¯æ•°å­—`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">min</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">min</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">field</span><span class="si">}</span><span class="sb">ä¸èƒ½å°äº</span><span class="si">${</span><span class="nx">min</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">max</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">field</span><span class="si">}</span><span class="sb">ä¸èƒ½å¤§äº</span><span class="si">${</span><span class="nx">max</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">num</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">validateEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">validatePhone</span><span class="p">(</span><span class="nx">phone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^1[3-9]\d{9}$/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">phone</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Validator</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// middleware/validator.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/validator&#39;</span><span class="p">)</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">validate</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">field</span><span class="p">,</span><span class="w"> </span><span class="nx">rules</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">schema</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">required</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Validator</span><span class="p">.</span><span class="nx">validateRequired</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">field</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Validator</span><span class="p">.</span><span class="nx">validateNumber</span><span class="p">(</span>
<span class="w">            </span><span class="nx">value</span><span class="p">,</span>
<span class="w">            </span><span class="nx">field</span><span class="p">,</span>
<span class="w">            </span><span class="nx">rules</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span>
<span class="w">            </span><span class="nx">rules</span><span class="p">.</span><span class="nx">max</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;email&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Validator</span><span class="p">.</span><span class="nx">validateEmail</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rules</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;phone&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">Validator</span><span class="p">.</span><span class="nx">validatePhone</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">next</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validate</span>
</pre></div>
</div>
</section>
<section id="sql">
<h3>6.2 SQLæ³¨å…¥é˜²æŠ¤<a class="headerlink" href="#sql" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆMongoDBå¤©ç„¶é˜²æŠ¤ï¼‰</span>
<span class="c1">// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`SELECT * FROM users WHERE name = &#39;</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#39;`</span>

<span class="c1">// âœ… æ­£ç¡®ï¼šå‚æ•°åŒ–æŸ¥è¯¢</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// å¯¹äºMySQLï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SELECT * FROM users WHERE name = ?&#39;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="xss">
<h3>6.3 XSSé˜²æŠ¤<a class="headerlink" href="#xss" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// ä½¿ç”¨xssåº“è¿‡æ»¤ç”¨æˆ·è¾“å…¥</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">xss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;xss&#39;</span><span class="p">)</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">sanitizeInput</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">xss</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">whiteList</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="c1">// ä¸å…è®¸ä»»ä½•HTMLæ ‡ç­¾</span>
<span class="w">    </span><span class="nx">stripIgnoreTag</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">safeContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sanitizeInput</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3>6.4 é™æµ<a class="headerlink" href="#id17" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// middleware/rateLimit.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">rateLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-rate-limit&#39;</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">limiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rateLimit</span><span class="p">({</span>
<span class="w">  </span><span class="nx">windowMs</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 15åˆ†é’Ÿ</span>
<span class="w">  </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="c1">// æœ€å¤š100æ¬¡è¯·æ±‚</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">429</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•&#39;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limiter</span>
</pre></div>
</div>
</section>
<section id="https">
<h3>6.5 HTTPS<a class="headerlink" href="#https" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS</span>
<span class="c1">// å°ç¨‹åºè¦æ±‚æ‰€æœ‰è¯·æ±‚å¿…é¡»ä½¿ç”¨HTTPS</span>

<span class="c1">// ä½¿ç”¨Nginxåå‘ä»£ç†</span>
<span class="c1">// server {</span>
<span class="c1">//   listen 443 ssl;</span>
<span class="c1">//   ssl_certificate /path/to/cert.pem;</span>
<span class="c1">//   ssl_certificate_key /path/to/key.pem;</span>
<span class="c1">//   </span>
<span class="c1">//   location / {</span>
<span class="c1">//     proxy_pass http://localhost:3000;</span>
<span class="c1">//   }</span>
<span class="c1">// }</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id18">
<h2>7. é”™è¯¯å¤„ç†<a class="headerlink" href="#id18" title="Permalink to this heading">ïƒ</a></h2>
<section id="id19">
<h3>7.1 å…¨å±€é”™è¯¯å¤„ç†<a class="headerlink" href="#id19" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// middleware/error.js</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">errorHandler</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;é”™è¯¯:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å¼€å‘ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ç”Ÿäº§ç¯å¢ƒè¿”å›é€šç”¨é”™è¯¯</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•&#39;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorHandler</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// app.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./middleware/error&#39;</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">errorHandler</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id20">
<h3>7.2 å¼‚æ­¥é”™è¯¯å¤„ç†<a class="headerlink" href="#id20" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// ä½¿ç”¨async/await</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">products</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="c1">// ä¼ é€’ç»™é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>

<span class="c1">// æˆ–ä½¿ç”¨express-async-errors</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-async-errors&#39;</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Product</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">products</span><span class="p">))</span>
<span class="w">  </span><span class="c1">// é”™è¯¯ä¼šè‡ªåŠ¨ä¼ é€’ç»™é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id21">
<h2>8. éƒ¨ç½²<a class="headerlink" href="#id21" title="Permalink to this heading">ïƒ</a></h2>
<section id="docker">
<h3>8.1 Dockeréƒ¨ç½²<a class="headerlink" href="#docker" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:16-alpine</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>--production

<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">3000</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src/app.js&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3&#39;</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3000:3000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_ENV=production</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_URI=mongodb://mongo:27017/miniprogram</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span>
<span class="w">  </span>
<span class="w">  </span><span class="nt">mongo</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:5</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-data:/data/db</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mongo-data</span><span class="p">:</span>
</pre></div>
</div>
</section>
<section id="pm2">
<h3>8.2 PM2éƒ¨ç½²<a class="headerlink" href="#pm2" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// ecosystem.config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">apps</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;miniprogram-api&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./src/app.js&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">instances</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">exec_mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">NODE_ENV</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">PORT</span><span class="o">:</span><span class="w"> </span><span class="mf">3000</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">error_file</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./logs/err.log&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">out_file</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./logs/out.log&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">log_date_format</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;YYYY-MM-DD HH:mm:ss&#39;</span>
<span class="w">  </span><span class="p">}]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># å¯åŠ¨</span>
pm2<span class="w"> </span>start<span class="w"> </span>ecosystem.config.js

<span class="c1"># æŸ¥çœ‹çŠ¶æ€</span>
pm2<span class="w"> </span>status

<span class="c1"># æŸ¥çœ‹æ—¥å¿—</span>
pm2<span class="w"> </span>logs

<span class="c1"># é‡å¯</span>
pm2<span class="w"> </span>restart<span class="w"> </span>miniprogram-api
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id22">
<h2>9. å¸¸è§é—®é¢˜<a class="headerlink" href="#id22" title="Permalink to this heading">ïƒ</a></h2>
<section id="q1">
<h3>Q1: å¦‚ä½•å¤„ç†é«˜å¹¶å‘ï¼Ÿ<a class="headerlink" href="#q1" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®</p></li>
<li><p>æ•°æ®åº“è¯»å†™åˆ†ç¦»</p></li>
<li><p>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡</p></li>
<li><p>è´Ÿè½½å‡è¡¡</p></li>
</ol>
</section>
<section id="q2">
<h3>Q2: å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ<a class="headerlink" href="#q2" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡</p></li>
<li><p>åˆ†å¸ƒå¼é”</p></li>
<li><p>æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ</p></li>
</ol>
</section>
<section id="q3-api">
<h3>Q3: å¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ<a class="headerlink" href="#q3-api" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–</p></li>
<li><p>æŸ¥è¯¢ç»“æœç¼“å­˜</p></li>
<li><p>åˆ†é¡µæŸ¥è¯¢</p></li>
<li><p>å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="id23">
<h2>å‚è€ƒèµ„æº<a class="headerlink" href="#id23" title="Permalink to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>Node.jsæœ€ä½³å®è·µ</p></li>
<li><p>RESTful APIè®¾è®¡æŒ‡å—</p></li>
<li><p>MongoDBå®˜æ–¹æ–‡æ¡£</p></li>
<li><p>å°ç¨‹åºåç«¯å¼€å‘è§„èŒƒ</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="05-testing-and-debugging.html" class="btn btn-neutral float-left" title="æµ‹è¯•ä¸è°ƒè¯•" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Code Dojo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>