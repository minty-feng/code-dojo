

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç½‘ç»œè¯·æ±‚ä¸äº‘å¼€å‘ &mdash; Mini Program Tutorial 1.0.0 æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d25bc049" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=34088549"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=beaddf03"></script>
      <script src="_static/copy-code.js?v=37526288"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="genindex.html" />
    <link rel="search" title="æœç´¢" href="search.html" />
    <link rel="next" title="æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ" href="03-performance-optimization.html" />
    <link rel="prev" title="åŸºç¡€" href="01-wechat-miniprogram-basics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #07c160" >

          
          
          <a href="index.html" class="icon icon-home">
            Mini Program Tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ç›®å½•</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">WeChat Mini Program Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="01-wechat-miniprogram-basics.html">åŸºç¡€</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">ç½‘ç»œè¯·æ±‚ä¸äº‘å¼€å‘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">ğŸ’¡ æ ¸å¿ƒç»“è®º</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">1. ç½‘ç»œè¯·æ±‚</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#wx-request">1.1 wx.requeståŸºç¡€</a></li>
<li class="toctree-l3"><a class="reference internal" href="#promise">1.2 Promiseå°è£…</a></li>
<li class="toctree-l3"><a class="reference internal" href="#async-await">1.3 ä½¿ç”¨async/await</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">1.4 è¯·æ±‚æ‹¦æˆªå™¨</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">1.5 é”™è¯¯å¤„ç†</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api">1.6 APIæ¥å£ç®¡ç†</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">2. ç”¨æˆ·ç™»å½•</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">2.1 å¾®ä¿¡ç™»å½•æµç¨‹</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-js">2.2 åç«¯æ¥å£ï¼ˆNode.jsç¤ºä¾‹ï¼‰</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">3. äº‘å¼€å‘</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">3.1 åˆå§‹åŒ–äº‘å¼€å‘</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.2 äº‘æ•°æ®åº“</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3.3 äº‘å­˜å‚¨</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.4 äº‘å‡½æ•°</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#websocket">4. WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id13">5. æ–‡ä»¶æ“ä½œ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">5.1 å›¾ç‰‡é€‰æ‹©å’Œä¸Šä¼ </a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">5.2 å›¾ç‰‡é¢„è§ˆ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id16">6. å¸¸è§é—®é¢˜</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#q1">Q1: å¦‚ä½•é…ç½®åˆæ³•åŸŸåï¼Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q2">Q2: äº‘å¼€å‘å’Œä¼ ç»Ÿåç«¯çš„åŒºåˆ«ï¼Ÿ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q3">Q3: å¦‚ä½•å¤„ç†å¹¶å‘è¯·æ±‚ï¼Ÿ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id17">å‚è€ƒèµ„æº</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="03-performance-optimization.html">æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-deployment-and-release.html">éƒ¨ç½²ä¸å‘å¸ƒ</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-testing-and-debugging.html">æµ‹è¯•ä¸è°ƒè¯•</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-backend-development.html">åç«¯å¼€å‘ä¸é›†æˆ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•"  style="background: #07c160" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Mini Program Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">ç½‘ç»œè¯·æ±‚ä¸äº‘å¼€å‘</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/02-network-request-and-cloud.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>ç½‘ç»œè¯·æ±‚ä¸äº‘å¼€å‘<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<section id="id2">
<h2>ğŸ’¡ æ ¸å¿ƒç»“è®º<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<ol class="arabic simple">
<li><p><strong>wx.requestå‘é€HTTPè¯·æ±‚ï¼ŒåŸŸåéœ€è¦åœ¨åå°é…ç½®ç™½åå•</strong></p></li>
<li><p><strong>Promiseå°è£…wx.requestå¯ä»¥ä½¿ç”¨async/awaitç®€åŒ–å¼‚æ­¥ä»£ç </strong></p></li>
<li><p><strong>äº‘å¼€å‘æä¾›æ•°æ®åº“ã€å­˜å‚¨ã€äº‘å‡½æ•°ï¼Œæ— éœ€æ­å»ºæœåŠ¡å™¨</strong></p></li>
<li><p><strong>äº‘æ•°æ®åº“æ”¯æŒæƒé™æ§åˆ¶å’Œå®æ—¶æ¨é€</strong></p></li>
<li><p><strong>å°ç¨‹åºç™»å½•é€šè¿‡codeæ¢å–openidå’Œsession_key</strong></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="id3">
<h2>1. ç½‘ç»œè¯·æ±‚<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<section id="wx-request">
<h3>1.1 wx.requeståŸºç¡€<a class="headerlink" href="#wx-request" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">//pages/index/index.js</span>
<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">list</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">onLoad</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loadData</span><span class="p">()</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">loadData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åŠ è½½ä¸­&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://api.example.com/products&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;content-type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">            </span><span class="nx">list</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span>
<span class="w">          </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">            </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;è¯·æ±‚å¤±è´¥&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">          </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">fail</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;è¯·æ±‚å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç½‘ç»œé”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">complete</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="promise">
<h3>1.2 Promiseå°è£…<a class="headerlink" href="#promise" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// utils/request.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">baseURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;https://api.example.com&#39;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">baseURL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;content-type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">header</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">300</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">reject</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">fail</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1">// å°è£…å¸¸ç”¨æ–¹æ³•</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="ow">delete</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="async-await">
<h3>1.3 ä½¿ç”¨async/await<a class="headerlink" href="#async-await" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// pages/index/index.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../utils/request.js&#39;</span>

<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">onLoad</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">loadProducts</span><span class="p">()</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">loadProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åŠ è½½ä¸­&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">page</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">        </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åŠ è½½å¤±è´¥&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ä¸Šæ‹‰åŠ è½½æ›´å¤š</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">onReachBottom</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">      </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">page</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">        </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3>1.4 è¯·æ±‚æ‹¦æˆªå™¨<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// utils/request.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">baseURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;https://api.example.com&#39;</span>

<span class="c1">// è¯·æ±‚æ‹¦æˆªå™¨</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">requestInterceptor</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// æ·»åŠ token</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">options</span><span class="p">.</span><span class="nx">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">header</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">token</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ·»åŠ æ—¶é—´æˆ³ï¼ˆé˜²æ­¢ç¼“å­˜ï¼‰</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
<span class="w">      </span><span class="nx">_t</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">options</span>
<span class="p">}</span>

<span class="c1">// å“åº”æ‹¦æˆªå™¨</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">responseInterceptor</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ç»Ÿä¸€å¤„ç†å“åº”</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä¸šåŠ¡æˆåŠŸ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ä¸šåŠ¡å¤±è´¥</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// tokenè¿‡æœŸï¼Œé‡æ–°ç™»å½•</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">401</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">removeStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
<span class="w">          </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/pages/login/login&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;ç™»å½•å·²è¿‡æœŸ&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// å…¶ä»–ä¸šåŠ¡é”™è¯¯</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;è¯·æ±‚å¤±è´¥&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// HTTPé”™è¯¯</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">      </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç½‘ç»œé”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;ç½‘ç»œé”™è¯¯&#39;</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// åº”ç”¨è¯·æ±‚æ‹¦æˆªå™¨</span>
<span class="w">  </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requestInterceptor</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">baseURL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;content-type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">...</span><span class="nx">options</span><span class="p">.</span><span class="nx">header</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åº”ç”¨å“åº”æ‹¦æˆªå™¨</span>
<span class="w">        </span><span class="nx">responseInterceptor</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="w">          </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span>
<span class="w">          </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">reject</span><span class="p">)</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">fail</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç½‘ç»œé”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">request</span><span class="p">({</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>1.5 é”™è¯¯å¤„ç†<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// utils/errorHandler.js</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// å¤„ç†ç½‘ç»œé”™è¯¯</span>
<span class="w">  </span><span class="nx">handleNetworkError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;è¯·æ±‚è¶…æ—¶&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç½‘ç»œè¿æ¥å¤±è´¥&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç½‘ç»œé”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å¤„ç†ä¸šåŠ¡é”™è¯¯</span>
<span class="w">  </span><span class="nx">handleBusinessError</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mf">400</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;è¯·æ±‚å‚æ•°é”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mf">401</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">wx</span><span class="p">.</span><span class="nx">reLaunch</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/pages/login/login&#39;</span>
<span class="w">          </span><span class="p">})</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="mf">1500</span><span class="p">)</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mf">403</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æ²¡æœ‰æƒé™&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mf">404</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;èµ„æºä¸å­˜åœ¨&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mf">500</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æœåŠ¡å™¨é”™è¯¯&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;æ“ä½œå¤±è´¥&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../utils/errorHandler.js&#39;</span>

<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">loadData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorHandler</span><span class="p">.</span><span class="nx">handleNetworkError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorHandler</span><span class="p">.</span><span class="nx">handleBusinessError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="api">
<h3>1.6 APIæ¥å£ç®¡ç†<a class="headerlink" href="#api" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// api/product.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/request.js&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">productAPI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// è·å–å•†å“åˆ—è¡¨</span>
<span class="w">  </span><span class="nx">getList</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// è·å–å•†å“è¯¦æƒ…</span>
<span class="w">  </span><span class="nx">getDetail</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// åˆ›å»ºå•†å“</span>
<span class="w">  </span><span class="nx">create</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ›´æ–°å•†å“</span>
<span class="w">  </span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// åˆ é™¤å•†å“</span>
<span class="w">  </span><span class="ow">delete</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productAPI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../../api/product.js&#39;</span>

<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">loadProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">productAPI</span><span class="p">.</span><span class="nx">getList</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">list</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;åŠ è½½å•†å“å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2>2. ç”¨æˆ·ç™»å½•<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h2>
<section id="id7">
<h3>2.1 å¾®ä¿¡ç™»å½•æµç¨‹<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// app.js</span>
<span class="nx">App</span><span class="p">({</span>
<span class="w">  </span><span class="nx">globalData</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">userInfo</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">onLaunch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">login</span><span class="p">()</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ç™»å½•</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">login</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 1. è·å–code</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">loginRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">login</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loginRes</span><span class="p">.</span><span class="nx">code</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 2. å‘é€codeåˆ°åç«¯</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
<span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://api.example.com/login&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 3. ä¿å­˜token</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">globalData</span><span class="p">.</span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">setStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 4. è·å–ç”¨æˆ·ä¿¡æ¯</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getUserProfile</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ç™»å½•å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getUserProfile</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getUserProfile</span><span class="p">({</span>
<span class="w">        </span><span class="nx">desc</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">globalData</span><span class="p">.</span><span class="nx">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">userInfo</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">setStorageSync</span><span class="p">(</span><span class="s1">&#39;userInfo&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">userInfo</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// å‘é€åˆ°åç«¯</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
<span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://api.example.com/user/profile&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">userInfo</span><span class="p">,</span>
<span class="w">        </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">globalData</span><span class="p">.</span><span class="nx">token</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="node-js">
<h3>2.2 åç«¯æ¥å£ï¼ˆNode.jsç¤ºä¾‹ï¼‰<a class="headerlink" href="#node-js" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// åç«¯ï¼šloginæ¥å£</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsonwebtoken&#39;</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 1. ç”¨codeæ¢å–openidå’Œsession_key</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">wechatRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;https://api.weixin.qq.com/sns/jscode2session&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">appid</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your_appid&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your_secret&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">js_code</span><span class="o">:</span><span class="w"> </span><span class="nx">code</span><span class="p">,</span>
<span class="w">      </span><span class="nx">grant_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;authorization_code&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">openid</span><span class="p">,</span><span class="w"> </span><span class="nx">session_key</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wechatRes</span><span class="p">.</span><span class="nx">data</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">openid</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="w"> </span><span class="nx">openid</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// 3. ç”ŸæˆJWT token</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">openid</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="s1">&#39;your_secret_key&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;7d&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id8">
<h2>3. äº‘å¼€å‘<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h2>
<section id="id9">
<h3>3.1 åˆå§‹åŒ–äº‘å¼€å‘<a class="headerlink" href="#id9" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// app.js</span>
<span class="nx">App</span><span class="p">({</span>
<span class="w">  </span><span class="nx">onLaunch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆå§‹åŒ–äº‘å¼€å‘</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
<span class="w">      </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your-env-id&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// äº‘å¼€å‘ç¯å¢ƒID</span>
<span class="w">      </span><span class="nx">traceUser</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>3.2 äº‘æ•°æ®åº“<a class="headerlink" href="#id10" title="Link to this heading">ïƒ</a></h3>
<p><strong>åˆ›å»ºæ•°æ®</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// pages/add/add.js</span>
<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">onAdd</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">({</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;å­¦ä¹ å°ç¨‹åº&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">          </span><span class="nx">createTime</span><span class="o">:</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">serverDate</span><span class="p">()</span><span class="w">  </span><span class="c1">// æœåŠ¡å™¨æ—¶é—´</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;æ·»åŠ æˆåŠŸ&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æ·»åŠ æˆåŠŸ&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;æ·»åŠ å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>æŸ¥è¯¢æ•°æ®</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">loadTodos</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">command</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ç®€å•æŸ¥è¯¢</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">where</span><span class="p">({</span>
<span class="w">          </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">&#39;createTime&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mf">20</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">        </span><span class="nx">todos</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// æ¡ä»¶æŸ¥è¯¢</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">where</span><span class="p">({</span>
<span class="w">          </span><span class="c1">// ç­‰äº</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="c1">// å¤§äº</span>
<span class="w">          </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="nx">gt</span><span class="p">(</span><span class="mf">60</span><span class="p">),</span>
<span class="w">          </span><span class="c1">// åŒ…å«</span>
<span class="w">          </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="ow">in</span><span class="p">([</span><span class="s1">&#39;work&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;study&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// æ­£åˆ™åŒ¹é…</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">where</span><span class="p">({</span>
<span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nb">RegExp</span><span class="p">({</span>
<span class="w">            </span><span class="nx">regexp</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;å­¦ä¹ &#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="w">  </span><span class="c1">// ä¸åŒºåˆ†å¤§å°å†™</span>
<span class="w">          </span><span class="p">})</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;æŸ¥è¯¢å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>æ›´æ–°æ•°æ®</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">          </span><span class="nx">updateTime</span><span class="o">:</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">serverDate</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;æ›´æ–°æˆåŠŸ&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;æ›´æ–°å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// æ•°ç»„æ“ä½œ</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">addTag</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">command</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">&#39;new-tag&#39;</span><span class="p">])</span><span class="w">  </span><span class="c1">// æ·»åŠ åˆ°æ•°ç»„</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p><strong>åˆ é™¤æ•°æ®</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åˆ é™¤æˆåŠŸ&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;åˆ é™¤å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3>3.3 äº‘å­˜å‚¨<a class="headerlink" href="#id11" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="c1">// ä¸Šä¼ å›¾ç‰‡</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">uploadImage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// é€‰æ‹©å›¾ç‰‡</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chooseRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">chooseImage</span><span class="p">({</span>
<span class="w">        </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizeType</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;compressed&#39;</span><span class="p">],</span>
<span class="w">        </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;album&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;camera&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chooseRes</span><span class="p">.</span><span class="nx">tempFilePaths</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// ä¸Šä¼ åˆ°äº‘å­˜å‚¨</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">uploadRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">({</span>
<span class="w">        </span><span class="nx">cloudPath</span><span class="o">:</span><span class="w"> </span><span class="sb">`images/</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="si">}</span><span class="sb">.png`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">filePath</span><span class="o">:</span><span class="w"> </span><span class="nx">filePath</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ä¸Šä¼ æˆåŠŸ&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadRes</span><span class="p">.</span><span class="nx">fileID</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// è·å–ä¸´æ—¶é“¾æ¥</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">tempURLRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">getTempFileURL</span><span class="p">({</span>
<span class="w">        </span><span class="nx">fileList</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">uploadRes</span><span class="p">.</span><span class="nx">fileID</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tempURLRes</span><span class="p">.</span><span class="nx">fileList</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">tempFileURL</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">imageURL</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ä¸Šä¼ å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// ä¸‹è½½æ–‡ä»¶</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">downloadFile</span><span class="p">(</span><span class="nx">fileID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">downloadFile</span><span class="p">({</span>
<span class="w">        </span><span class="nx">fileID</span><span class="o">:</span><span class="w"> </span><span class="nx">fileID</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ä¸´æ—¶æ–‡ä»¶è·¯å¾„&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">tempFilePath</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ä¸‹è½½å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// åˆ é™¤æ–‡ä»¶</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteFile</span><span class="p">(</span><span class="nx">fileID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">deleteFile</span><span class="p">({</span>
<span class="w">        </span><span class="nx">fileList</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">fileID</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åˆ é™¤æˆåŠŸ&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;åˆ é™¤å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3>3.4 äº‘å‡½æ•°<a class="headerlink" href="#id12" title="Link to this heading">ïƒ</a></h3>
<p><strong>åˆ›å»ºäº‘å‡½æ•°</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cloudfunctions/getProducts/index.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cloud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;wx-server-sdk&#39;</span><span class="p">)</span>
<span class="nx">cloud</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span><span class="w"> </span><span class="nx">env</span><span class="o">:</span><span class="w"> </span><span class="nx">cloud</span><span class="p">.</span><span class="nx">DYNAMIC_CURRENT_ENV</span><span class="w"> </span><span class="p">})</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cloud</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¯ä»¥çªç ´å°ç¨‹åºç«¯20æ¡çš„é™åˆ¶</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;products&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">&#39;createTime&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
<span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>è°ƒç”¨äº‘å‡½æ•°</strong>ï¼š</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// pages/index/index.js</span>
<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">loadProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showLoading</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;åŠ è½½ä¸­&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">callFunction</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;getProducts&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">          </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;è°ƒç”¨å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">hideLoading</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="websocket">
<h2>4. WebSocket<a class="headerlink" href="#websocket" title="Link to this heading">ïƒ</a></h2>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// pages/chat/chat.js</span>
<span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nx">socketOpen</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">onLoad</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">connectWebSocket</span><span class="p">()</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="nx">onUnload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">closeWebSocket</span><span class="p">()</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// è¿æ¥WebSocket</span>
<span class="w">  </span><span class="nx">connectWebSocket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">connectSocket</span><span class="p">({</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;wss://example.com/ws&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// è¿æ¥æˆåŠŸ</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">onSocketOpen</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocketè¿æ¥å·²æ‰“å¼€&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">socketOpen</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// å‘é€å¿ƒè·³</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">startHeartbeat</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ¥æ”¶æ¶ˆæ¯</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">onSocketMessage</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span>
<span class="w">        </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[...</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// è¿æ¥å…³é—­</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">onSocketClose</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocketè¿æ¥å·²å…³é—­&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">socketOpen</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// é‡è¿</span>
<span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">connectWebSocket</span><span class="p">()</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">3000</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// é”™è¯¯</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">onSocketError</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;WebSocketé”™è¯¯&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å‘é€æ¶ˆæ¯</span>
<span class="w">  </span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">socketOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;è¿æ¥å·²æ–­å¼€&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">icon</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">sendSocketMessage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="nx">content</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å¿ƒè·³</span>
<span class="w">  </span><span class="nx">startHeartbeat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">socketOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wx</span><span class="p">.</span><span class="nx">sendSocketMessage</span><span class="p">({</span>
<span class="w">          </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ping&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">30000</span><span class="p">)</span><span class="w">  </span><span class="c1">// 30ç§’</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// å…³é—­è¿æ¥</span>
<span class="w">  </span><span class="nx">closeWebSocket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">heartbeatTimer</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">closeSocket</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="id13">
<h2>5. æ–‡ä»¶æ“ä½œ<a class="headerlink" href="#id13" title="Link to this heading">ïƒ</a></h2>
<section id="id14">
<h3>5.1 å›¾ç‰‡é€‰æ‹©å’Œä¸Šä¼ <a class="headerlink" href="#id14" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">chooseAndUpload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// é€‰æ‹©å›¾ç‰‡</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chooseRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">chooseImage</span><span class="p">({</span>
<span class="w">        </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizeType</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;compressed&#39;</span><span class="p">],</span>
<span class="w">        </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;album&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;camera&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">tempFilePaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chooseRes</span><span class="p">.</span><span class="nx">tempFilePaths</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// æ‰¹é‡ä¸Šä¼ </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">uploadPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tempFilePaths</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">filePath</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">({</span>
<span class="w">          </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://api.example.com/upload&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">filePath</span><span class="o">:</span><span class="w"> </span><span class="nx">filePath</span><span class="p">,</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">header</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">wx</span><span class="p">.</span><span class="nx">getStorageSync</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">uploadPromises</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageUrls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">({</span><span class="w"> </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="nx">imageUrls</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ä¸Šä¼ æˆåŠŸ&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;ä¸Šä¼ å¤±è´¥&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="id15">
<h3>5.2 å›¾ç‰‡é¢„è§ˆ<a class="headerlink" href="#id15" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="nx">previewImage</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wx</span><span class="p">.</span><span class="nx">previewImage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">current</span><span class="o">:</span><span class="w"> </span><span class="nx">current</span><span class="p">,</span>
<span class="w">      </span><span class="nx">urls</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id16">
<h2>6. å¸¸è§é—®é¢˜<a class="headerlink" href="#id16" title="Link to this heading">ïƒ</a></h2>
<section id="q1">
<h3>Q1: å¦‚ä½•é…ç½®åˆæ³•åŸŸåï¼Ÿ<a class="headerlink" href="#q1" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>ç™»å½•å°ç¨‹åºåå°</p></li>
<li><p>å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸå</p></li>
<li><p>é…ç½®requestã€uploadFileã€downloadFileã€socketåŸŸå</p></li>
</ol>
</section>
<section id="q2">
<h3>Q2: äº‘å¼€å‘å’Œä¼ ç»Ÿåç«¯çš„åŒºåˆ«ï¼Ÿ<a class="headerlink" href="#q2" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p><strong>äº‘å¼€å‘</strong>ï¼šæ— éœ€æ­å»ºæœåŠ¡å™¨ï¼ŒæŒ‰é‡ä»˜è´¹ï¼Œå¿«é€Ÿå¼€å‘</p></li>
<li><p><strong>ä¼ ç»Ÿåç«¯</strong>ï¼šè‡ªå·±æ­å»ºï¼Œæˆæœ¬é«˜ï¼Œçµæ´»æ€§å¼º</p></li>
</ul>
</section>
<section id="q3">
<h3>Q3: å¦‚ä½•å¤„ç†å¹¶å‘è¯·æ±‚ï¼Ÿ<a class="headerlink" href="#q3" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">  </span><span class="nx">request1</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">request2</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">request3</span><span class="p">()</span>
<span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">results</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// æ‰€æœ‰è¯·æ±‚å®Œæˆ</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id17">
<h2>å‚è€ƒèµ„æº<a class="headerlink" href="#id17" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>å¾®ä¿¡å°ç¨‹åºç½‘ç»œAPIæ–‡æ¡£</p></li>
<li><p>äº‘å¼€å‘å®˜æ–¹æ–‡æ¡£</p></li>
<li><p>WebSocketåè®®è§„èŒƒ</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="é¡µè„š">
        <a href="01-wechat-miniprogram-basics.html" class="btn btn-neutral float-left" title="åŸºç¡€" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> ä¸Šä¸€é¡µ</a>
        <a href="03-performance-optimization.html" class="btn btn-neutral float-right" title="æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ" accesskey="n" rel="next">ä¸‹ä¸€é¡µ <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2025, Code Dojoã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>