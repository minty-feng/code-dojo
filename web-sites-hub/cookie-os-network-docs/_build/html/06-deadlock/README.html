

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ­»é”å¤„ç† &mdash; OS &amp; Network Core 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d0851c8" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/copy-code.js?v=caf91246"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="TCP-IPåè®®è¯¦è§£" href="../07-tcp-ip/index.html" />
    <link rel="prev" title="æ­»é”å¤„ç†" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            OS & Network Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ç›®å½•</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">OS &amp; Network Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-process-thread/index.html">è¿›ç¨‹ä¸çº¿ç¨‹</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-process-scheduling/index.html">è¿›ç¨‹è°ƒåº¦</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03-memory-management/index.html">å†…å­˜ç®¡ç†</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04-file-system/index.html">æ–‡ä»¶ç³»ç»Ÿ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05-concurrency-sync/index.html">å¹¶å‘ä¸åŒæ­¥</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">æ­»é”å¤„ç†</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">æ­»é”å¤„ç†</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">ğŸ’¡ æ ¸å¿ƒç»“è®º</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1. æ­»é”å®šä¹‰</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.1 ç»å…¸ä¾‹å­</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">2. æ­»é”å››å¤§æ¡ä»¶</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mutual-exclusion">2.1 äº’æ–¥ï¼ˆMutual Exclusionï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hold-and-wait">2.2 å æœ‰å¹¶ç­‰å¾…ï¼ˆHold and Waitï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#no-preemption">2.3 éæŠ¢å ï¼ˆNo Preemptionï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#circular-wait">2.4 å¾ªç¯ç­‰å¾…ï¼ˆCircular Waitï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">3. æ­»é”é¢„é˜²</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">3.1 ç ´åäº’æ–¥æ¡ä»¶</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">3.2 ç ´åå æœ‰å¹¶ç­‰å¾…</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.3 ç ´åéæŠ¢å æ¡ä»¶</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">3.4 ç ´åå¾ªç¯ç­‰å¾…ï¼ˆæœ€å¸¸ç”¨ï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">4. æ­»é”é¿å…</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id12">4.1 é“¶è¡Œå®¶ç®—æ³•</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">5. æ­»é”æ£€æµ‹</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">5.1 èµ„æºåˆ†é…å›¾</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">5.2 æ£€æµ‹ç®—æ³•</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id16">6. æ­»é”æ¢å¤</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">6.1 è¿›ç¨‹ç»ˆæ­¢</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">6.2 èµ„æºæŠ¢å </a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id19">7. å®é™…ç³»ç»Ÿç­–ç•¥</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id20">7.1 é¸µé¸Ÿç­–ç•¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">7.2 è¶…æ—¶æœºåˆ¶</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id22">8. å®æˆ˜æ¡ˆä¾‹</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id23">8.1 å“²å­¦å®¶å°±é¤é—®é¢˜</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">8.2 æ•°æ®åº“æ­»é”</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id25">9. å¸¸è§é—®é¢˜</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#q1">Q1: æ­»é”å’Œé¥¥é¥¿çš„åŒºåˆ«ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q2">Q2: å¦‚ä½•è°ƒè¯•æ­»é”ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q3">Q3: ä¸ºä»€ä¹ˆæ•°æ®åº“èƒ½è‡ªåŠ¨å¤„ç†æ­»é”ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q4">Q4: å¤šçº¿ç¨‹ç¨‹åºå¦‚ä½•é¿å…æ­»é”ï¼Ÿ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id26">10. è°ƒè¯•å·¥å…·</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linux">10.1 Linuxå·¥å…·</a></li>
<li class="toctree-l4"><a class="reference internal" href="#valgrind-helgrind">10.2 Valgrind Helgrind</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">10.3 æ­»é”æ£€æµ‹ä»£ç </a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id28">å‚è€ƒèµ„æº</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../07-tcp-ip/index.html">TCP-IPåè®®è¯¦è§£</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08-http/index.html">HTTPåè®®ä¸å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-socket/index.html">Socketç¼–ç¨‹å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10-network-tools/index.html">ç½‘ç»œå·¥å…·å¤§å…¨</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-network-security/index.html">ç½‘ç»œå®‰å…¨åŸºç¡€</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OS & Network Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">æ­»é”å¤„ç†</a></li>
      <li class="breadcrumb-item active">æ­»é”å¤„ç†</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/06-deadlock/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>æ­»é”å¤„ç†<a class="headerlink" href="#id1" title="Permalink to this heading">ïƒ</a></h1>
<section id="id2">
<h2>ğŸ’¡ æ ¸å¿ƒç»“è®º<a class="headerlink" href="#id2" title="Permalink to this heading">ïƒ</a></h2>
<ol class="arabic simple">
<li><p><strong>æ­»é”å››å¤§å¿…è¦æ¡ä»¶ï¼šäº’æ–¥ã€å æœ‰å¹¶ç­‰å¾…ã€éæŠ¢å ã€å¾ªç¯ç­‰å¾…</strong></p></li>
<li><p><strong>ç ´åä»»æ„ä¸€ä¸ªæ¡ä»¶å³å¯é¢„é˜²æ­»é”</strong></p></li>
<li><p><strong>é“¶è¡Œå®¶ç®—æ³•æ˜¯å®‰å…¨æ€§æ£€æŸ¥çš„ç»å…¸ç®—æ³•</strong></p></li>
<li><p><strong>æ­»é”æ£€æµ‹éœ€è¦èµ„æºåˆ†é…å›¾ï¼ŒæŸ¥æ‰¾ç¯</strong></p></li>
<li><p><strong>å®é™…ç³»ç»Ÿå¤šé‡‡ç”¨é¸µé¸Ÿç­–ç•¥ï¼ˆå¿½ç•¥æ­»é”ï¼‰</strong></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="id3">
<h2>1. æ­»é”å®šä¹‰<a class="headerlink" href="#id3" title="Permalink to this heading">ïƒ</a></h2>
<p><strong>æ­»é”ï¼ˆDeadlockï¼‰</strong>ï¼šå¤šä¸ªè¿›ç¨‹æ°¸ä¹…ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æº</p>
<section id="id4">
<h3>1.1 ç»å…¸ä¾‹å­<a class="headerlink" href="#id4" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mutex_t</span><span class="w"> </span><span class="n">lock_A</span><span class="p">,</span><span class="w"> </span><span class="n">lock_B</span><span class="p">;</span>

<span class="c1">// è¿›ç¨‹1</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">         </span><span class="c1">// ç­‰å¾…ï¼Œè®©è¿›ç¨‹2è·å¾—lock_B</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span><span class="w">     </span><span class="c1">// æ­»é”ï¼šç­‰å¾…è¿›ç¨‹2é‡Šæ”¾lock_B</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è¿›ç¨‹2</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">         </span><span class="c1">// ç­‰å¾…ï¼Œè®©è¿›ç¨‹1è·å¾—lock_A</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span><span class="w">     </span><span class="c1">// æ­»é”ï¼šç­‰å¾…è¿›ç¨‹1é‡Šæ”¾lock_A</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç»“æœ</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>è¿›ç¨‹1æŒæœ‰Aï¼Œç­‰å¾…B
è¿›ç¨‹2æŒæœ‰Bï¼Œç­‰å¾…A
â†“
æ­»é”ï¼
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id5">
<h2>2. æ­»é”å››å¤§æ¡ä»¶<a class="headerlink" href="#id5" title="Permalink to this heading">ïƒ</a></h2>
<section id="mutual-exclusion">
<h3>2.1 äº’æ–¥ï¼ˆMutual Exclusionï¼‰<a class="headerlink" href="#mutual-exclusion" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>å®šä¹‰</strong>ï¼šèµ„æºåŒæ—¶åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mutex_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>

<span class="c1">// äº’æ–¥è®¿é—®ä¸´ç•ŒåŒº</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">critical_section</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è¿›å…¥</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="hold-and-wait">
<h3>2.2 å æœ‰å¹¶ç­‰å¾…ï¼ˆHold and Waitï¼‰<a class="headerlink" href="#hold-and-wait" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>å®šä¹‰</strong>ï¼šè¿›ç¨‹æŒæœ‰èµ„æºçš„åŒæ—¶ç­‰å¾…å…¶ä»–èµ„æº</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">resource1</span><span class="p">);</span><span class="w">    </span><span class="c1">// æŒæœ‰resource1</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">resource2</span><span class="p">);</span><span class="w">    </span><span class="c1">// ç­‰å¾…resource2</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="no-preemption">
<h3>2.3 éæŠ¢å ï¼ˆNo Preemptionï¼‰<a class="headerlink" href="#no-preemption" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>å®šä¹‰</strong>ï¼šèµ„æºä¸èƒ½è¢«å¼ºåˆ¶æŠ¢å ï¼Œåªèƒ½ä¸»åŠ¨é‡Šæ”¾</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// è¿›ç¨‹æŒæœ‰é”åï¼Œå…¶ä»–è¿›ç¨‹ä¸èƒ½å¼ºåˆ¶å¤ºèµ°</span>
<span class="n">lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="c1">// å¿…é¡»ç”±è¿›ç¨‹è‡ªå·±é‡Šæ”¾</span>
<span class="n">unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="circular-wait">
<h3>2.4 å¾ªç¯ç­‰å¾…ï¼ˆCircular Waitï¼‰<a class="headerlink" href="#circular-wait" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>å®šä¹‰</strong>ï¼šå­˜åœ¨è¿›ç¨‹ç¯è·¯ï¼Œæ¯ä¸ªè¿›ç¨‹ç­‰å¾…ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„èµ„æº</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>P1 â†’ R1 â†’ P2 â†’ R2 â†’ P3 â†’ R3 â†’ P1
(P1ç­‰R1ï¼ŒR1è¢«P2æŒæœ‰ï¼ŒP2ç­‰R2ï¼ŒR2è¢«P3æŒæœ‰ï¼ŒP3ç­‰R3ï¼ŒR3è¢«P1æŒæœ‰)
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2>3. æ­»é”é¢„é˜²<a class="headerlink" href="#id6" title="Permalink to this heading">ïƒ</a></h2>
<p><strong>åŸç†</strong>ï¼šç ´åå››å¤§æ¡ä»¶ä¹‹ä¸€</p>
<section id="id7">
<h3>3.1 ç ´åäº’æ–¥æ¡ä»¶<a class="headerlink" href="#id7" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ–¹æ³•</strong>ï¼šèµ„æºå…±äº«ï¼ˆä¸ç°å®ï¼‰</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// åªè¯»èµ„æºå¯ä»¥å…±äº«</span>
<span class="kt">int</span><span class="w"> </span><span class="n">shared_data</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¤šä¸ªè¿›ç¨‹å¯åŒæ—¶è¯»å–</span>

<span class="c1">// ä½†æŸäº›èµ„æºå¿…é¡»äº’æ–¥</span>
<span class="n">mutex_t</span><span class="w"> </span><span class="n">printer</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ‰“å°æœºä¸èƒ½å…±äº«</span>
</pre></div>
</div>
<p><strong>ç»“è®º</strong>ï¼šé€šå¸¸æ— æ³•ç ´åï¼ˆèµ„æºæœ¬è´¨å†³å®šï¼‰</p>
</section>
<section id="id8">
<h3>3.2 ç ´åå æœ‰å¹¶ç­‰å¾…<a class="headerlink" href="#id8" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ–¹æ³•1</strong>ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æº</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„é”</span>
<span class="w">    </span><span class="n">lock_all</span><span class="p">(</span><span class="n">lock_A</span><span class="p">,</span><span class="w"> </span><span class="n">lock_B</span><span class="p">,</span><span class="w"> </span><span class="n">lock_C</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨èµ„æº</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">unlock_all</span><span class="p">(</span><span class="n">lock_A</span><span class="p">,</span><span class="w"> </span><span class="n">lock_B</span><span class="p">,</span><span class="w"> </span><span class="n">lock_C</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul class="simple">
<li><p>èµ„æºåˆ©ç”¨ç‡ä½</p></li>
<li><p>å¯èƒ½å¯¼è‡´é¥¥é¥¿</p></li>
<li><p>éš¾ä»¥é¢„çŸ¥æ‰€æœ‰éœ€è¦çš„èµ„æº</p></li>
</ul>
<p><strong>æ–¹æ³•2</strong>ï¼šç”³è¯·èµ„æºå‰é‡Šæ”¾å·²æŒæœ‰çš„èµ„æº</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trylock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æˆåŠŸè·å–ä¸¤ä¸ªé”</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¤±è´¥ï¼Œé‡Šæ”¾å·²æŒæœ‰çš„é”</span>
<span class="w">            </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// ç­‰å¾…åé‡è¯•</span>
<span class="w">            </span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨èµ„æº</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>3.3 ç ´åéæŠ¢å æ¡ä»¶<a class="headerlink" href="#id9" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ–¹æ³•</strong>ï¼šå…è®¸æŠ¢å </p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trylock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// lock_Bè¢«å ç”¨ï¼Œé‡Šæ”¾lock_A</span>
<span class="w">        </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ç­‰å¾…åé‡è¯•</span>
<span class="w">        </span><span class="n">wait_and_retry</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨èµ„æº</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<ul class="simple">
<li><p>å®ç°å¤æ‚</p></li>
<li><p>å¯èƒ½å¯¼è‡´æ´»é”</p></li>
<li><p>æŸäº›èµ„æºä¸èƒ½æŠ¢å ï¼ˆå¦‚æ‰“å°æœºï¼‰</p></li>
</ul>
</section>
<section id="id10">
<h3>3.4 ç ´åå¾ªç¯ç­‰å¾…ï¼ˆæœ€å¸¸ç”¨ï¼‰<a class="headerlink" href="#id10" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ–¹æ³•</strong>ï¼šèµ„æºæ’åºï¼ŒæŒ‰åºç”³è¯·</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç»™é”åˆ†é…å…¨å±€é¡ºåº</span>
<span class="cp">#define LOCK_A_ID 1</span>
<span class="cp">#define LOCK_B_ID 2</span>
<span class="cp">#define LOCK_C_ID 3</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">lock_in_order</span><span class="p">(</span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id1</span><span class="p">,</span><span class="w"> </span>
<span class="w">                  </span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">id2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock</span><span class="p">(</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">        </span><span class="n">lock</span><span class="p">(</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock</span><span class="p">(</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">        </span><span class="n">lock</span><span class="p">(</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock_in_order</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_A</span><span class="p">,</span><span class="w"> </span><span class="n">LOCK_A_ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lock_B</span><span class="p">,</span><span class="w"> </span><span class="n">LOCK_B_ID</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Linuxå†…æ ¸ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ä¸¤ä¸ªinodeé”ï¼ŒæŒ‰åœ°å€æ’åº</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inode1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">inode2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode2</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode1</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id11">
<h2>4. æ­»é”é¿å…<a class="headerlink" href="#id11" title="Permalink to this heading">ïƒ</a></h2>
<p><strong>åŸç†</strong>ï¼šåŠ¨æ€æ£€æŸ¥èµ„æºåˆ†é…å®‰å…¨æ€§</p>
<section id="id12">
<h3>4.1 é“¶è¡Œå®¶ç®—æ³•<a class="headerlink" href="#id12" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ¦‚å¿µ</strong>ï¼šç±»æ¯”é“¶è¡Œè´·æ¬¾ï¼Œç¡®ä¿ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç³»ç»ŸçŠ¶æ€</span>
<span class="kt">int</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">M</span><span class="p">];</span><span class="w">           </span><span class="c1">// å¯ç”¨èµ„æº</span>
<span class="kt">int</span><span class="w"> </span><span class="n">max</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">M</span><span class="p">];</span><span class="w">             </span><span class="c1">// æœ€å¤§éœ€æ±‚</span>
<span class="kt">int</span><span class="w"> </span><span class="n">allocation</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">M</span><span class="p">];</span><span class="w">      </span><span class="c1">// å·²åˆ†é…</span>
<span class="kt">int</span><span class="w"> </span><span class="n">need</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="n">M</span><span class="p">];</span><span class="w">            </span><span class="c1">// è¿˜éœ€è¦ = max - allocation</span>

<span class="c1">// å®‰å…¨æ€§æ£€æŸ¥</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">is_safe</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">work</span><span class="p">[</span><span class="n">M</span><span class="p">];</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">finish</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// åˆå§‹åŒ–</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">work</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æŸ¥æ‰¾å®‰å…¨åºåˆ—</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">need</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">work</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// è¿›ç¨‹iå¯ä»¥å®Œæˆ</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">work</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">allocation</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½å®Œæˆ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// èµ„æºè¯·æ±‚</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">request_resources</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">process</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">request</span><span class="p">[</span><span class="n">M</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¶…è¿‡éœ€æ±‚</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">need</span><span class="p">[</span><span class="n">process</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç­‰å¾…</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. è¯•æ¢æ€§åˆ†é…</span>
<span class="w">    </span><span class="n">available</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">    </span><span class="n">allocation</span><span class="p">[</span><span class="n">process</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">    </span><span class="n">need</span><span class="p">[</span><span class="n">process</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 4. å®‰å…¨æ€§æ£€æŸ¥</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_safe</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// å®‰å…¨ï¼Œåˆ†é…æˆåŠŸ</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä¸å®‰å…¨ï¼Œå›æ»š</span>
<span class="w">        </span><span class="n">available</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">        </span><span class="n">allocation</span><span class="p">[</span><span class="n">process</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">        </span><span class="n">need</span><span class="p">[</span><span class="n">process</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>3ä¸ªè¿›ç¨‹ï¼Œ3ç§èµ„æº(A=10, B=5, C=7)

è¿›ç¨‹  Max      Allocation  Need      Available
     A B C     A B C       A B C     A B C
P0   7 5 3     0 1 0       7 4 3     3 3 2
P1   3 2 2     2 0 0       1 2 2
P2   9 0 2     3 0 2       6 0 0

å®‰å…¨åºåˆ—ï¼šP1 â†’ P0 â†’ P2
1. P1å®Œæˆï¼Œé‡Šæ”¾(2,0,0)ï¼Œå¯ç”¨(5,3,2)
2. P0å®Œæˆï¼Œé‡Šæ”¾(0,1,0)ï¼Œå¯ç”¨(5,4,2)
3. P2å®Œæˆï¼Œé‡Šæ”¾(3,0,2)ï¼Œå¯ç”¨(8,4,4)
</pre></div>
</div>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul class="simple">
<li><p>è¿›ç¨‹æ•°å’Œèµ„æºç±»å‹å›ºå®š</p></li>
<li><p>éœ€è¦é¢„çŸ¥æœ€å¤§éœ€æ±‚</p></li>
<li><p>å®ç°å¤æ‚</p></li>
<li><p>å¾ˆå°‘ä½¿ç”¨</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id13">
<h2>5. æ­»é”æ£€æµ‹<a class="headerlink" href="#id13" title="Permalink to this heading">ïƒ</a></h2>
<p><strong>åŸç†</strong>ï¼šå…è®¸æ­»é”å‘ç”Ÿï¼Œå®šæœŸæ£€æµ‹å¹¶æ¢å¤</p>
<section id="id14">
<h3>5.1 èµ„æºåˆ†é…å›¾<a class="headerlink" href="#id14" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>è¿›ç¨‹ â†’ èµ„æºï¼šè¯·æ±‚è¾¹
èµ„æº â†’ è¿›ç¨‹ï¼šåˆ†é…è¾¹

æ­»é” â‡” å›¾ä¸­æœ‰ç¯
</pre></div>
</div>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>P1 â†’ R1 â†’ P2 â†’ R2 â†’ P1
(æœ‰ç¯ï¼Œæ­»é”)

P1 â†’ R1 â†’ P2 â†’ R2
          â†“
         P3
(æ— ç¯ï¼Œæ— æ­»é”)
</pre></div>
</div>
</section>
<section id="id15">
<h3>5.2 æ£€æµ‹ç®—æ³•<a class="headerlink" href="#id15" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">process</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">request</span><span class="p">[</span><span class="n">M</span><span class="p">];</span><span class="w">    </span><span class="c1">// è¯·æ±‚çš„èµ„æº</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">allocation</span><span class="p">[</span><span class="n">M</span><span class="p">];</span><span class="w"> </span><span class="c1">// å·²åˆ†é…çš„èµ„æº</span>
<span class="p">};</span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">detect_deadlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">available</span><span class="p">[</span><span class="n">M</span><span class="p">];</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">finish</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">calculate_available</span><span class="p">(</span><span class="n">available</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">allocation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ— èµ„æºçš„è¿›ç¨‹å·²å®Œæˆ</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æŸ¥æ‰¾å¯å®Œæˆçš„è¿›ç¨‹</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// è¿›ç¨‹iå¯ä»¥å®Œæˆ</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">available</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">allocation</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹æœªå®Œæˆ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">finish</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ£€æµ‹åˆ°æ­»é”</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>æ£€æµ‹é¢‘ç‡</strong>ï¼š</p>
<ul class="simple">
<li><p>æ¯æ¬¡èµ„æºè¯·æ±‚æ—¶æ£€æµ‹ï¼ˆå¼€é”€å¤§ï¼‰</p></li>
<li><p>å®šæœŸæ£€æµ‹ï¼ˆå¦‚æ¯å°æ—¶ï¼‰</p></li>
<li><p>CPUåˆ©ç”¨ç‡ä½æ—¶æ£€æµ‹</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id16">
<h2>6. æ­»é”æ¢å¤<a class="headerlink" href="#id16" title="Permalink to this heading">ïƒ</a></h2>
<section id="id17">
<h3>6.1 è¿›ç¨‹ç»ˆæ­¢<a class="headerlink" href="#id17" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>æ–¹æ³•1</strong>ï¼šç»ˆæ­¢æ‰€æœ‰æ­»é”è¿›ç¨‹</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">recover_terminate_all</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Process</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">deadlocked_processes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kill</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>æ–¹æ³•2</strong>ï¼šé€ä¸ªç»ˆæ­¢ç›´åˆ°è§£é™¤æ­»é”</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">recover_terminate_one</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">detect_deadlock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Process</span><span class="w"> </span><span class="o">*</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_victim</span><span class="p">();</span>
<span class="w">        </span><span class="n">kill</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>é€‰æ‹©å—å®³è€…</strong>ï¼š</p>
<ul class="simple">
<li><p>ä¼˜å…ˆçº§æœ€ä½</p></li>
<li><p>æ‰§è¡Œæ—¶é—´æœ€çŸ­</p></li>
<li><p>æŒæœ‰èµ„æºæœ€å°‘</p></li>
<li><p>å·²ä½¿ç”¨CPUæ—¶é—´æœ€å°‘</p></li>
</ul>
</section>
<section id="id18">
<h3>6.2 èµ„æºæŠ¢å <a class="headerlink" href="#id18" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">recover_preempt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">detect_deadlock</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. é€‰æ‹©å—å®³è€…</span>
<span class="w">        </span><span class="n">Process</span><span class="w"> </span><span class="o">*</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_victim</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 2. å›æ»šåˆ°å®‰å…¨çŠ¶æ€</span>
<span class="w">        </span><span class="n">rollback</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 3. æŠ¢å èµ„æº</span>
<span class="w">        </span><span class="n">Resource</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preempt_resource</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 4. åˆ†é…ç»™ç­‰å¾…çš„è¿›ç¨‹</span>
<span class="w">        </span><span class="n">allocate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">waiting_process</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>å›æ»šç­–ç•¥</strong>ï¼š</p>
<ul class="simple">
<li><p>å®Œå…¨å›æ»šï¼šå›åˆ°åˆå§‹çŠ¶æ€</p></li>
<li><p>éƒ¨åˆ†å›æ»šï¼šå›åˆ°æŸä¸ªæ£€æŸ¥ç‚¹</p></li>
<li><p>é¥¥é¥¿é—®é¢˜ï¼šåŒä¸€è¿›ç¨‹å¤šæ¬¡è¢«é€‰ä¸ºå—å®³è€…</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id19">
<h2>7. å®é™…ç³»ç»Ÿç­–ç•¥<a class="headerlink" href="#id19" title="Permalink to this heading">ïƒ</a></h2>
<section id="id20">
<h3>7.1 é¸µé¸Ÿç­–ç•¥<a class="headerlink" href="#id20" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå¿½ç•¥æ­»é”ï¼ˆå‡è£…ä¸å­˜åœ¨ï¼‰</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// å¤§å¤šæ•°æ“ä½œç³»ç»Ÿçš„åšæ³•</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">system_hang</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">reboot</span><span class="p">();</span><span class="w">  </span><span class="c1">// é‡å¯è§£å†³ä¸€åˆ‡é—®é¢˜</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç†ç”±</strong>ï¼š</p>
<ul class="simple">
<li><p>æ­»é”å¾ˆå°‘å‘ç”Ÿ</p></li>
<li><p>é¢„é˜²å’Œæ£€æµ‹å¼€é”€å¤§</p></li>
<li><p>æ€§èƒ½ä¼˜å…ˆäºç»å¯¹æ­£ç¡®æ€§</p></li>
</ul>
<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>
<ul class="simple">
<li><p>Linuxã€Windowsæ¡Œé¢ç³»ç»Ÿ</p></li>
<li><p>UNIXç³»ç»Ÿ</p></li>
</ul>
</section>
<section id="id21">
<h3>7.2 è¶…æ—¶æœºåˆ¶<a class="headerlink" href="#id21" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">lock_with_timeout</span><span class="p">(</span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">trylock</span><span class="p">(</span><span class="n">lock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="n">elapsed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¶…æ—¶ï¼Œå¯èƒ½æ­»é”</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">safe_operation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock_with_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_A</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock_with_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_B</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æˆåŠŸè·å–ä¸¤ä¸ªé”</span>
<span class="w">            </span><span class="n">critical_section</span><span class="p">();</span>
<span class="w">            </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_B</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">unlock</span><span class="p">(</span><span class="n">lock_A</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è¶…æ—¶ï¼Œæ”¾å¼ƒæ“ä½œ</span>
<span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;å¯èƒ½å‘ç”Ÿæ­»é”&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id22">
<h2>8. å®æˆ˜æ¡ˆä¾‹<a class="headerlink" href="#id22" title="Permalink to this heading">ïƒ</a></h2>
<section id="id23">
<h3>8.1 å“²å­¦å®¶å°±é¤é—®é¢˜<a class="headerlink" href="#id23" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>é—®é¢˜</strong>ï¼š5ä¸ªå“²å­¦å®¶ï¼Œ5æ ¹ç­·å­ï¼Œéœ€è¦ä¸¤æ ¹ç­·å­æ‰èƒ½åƒé¥­</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// æ­»é”ç‰ˆæœ¬</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">philosopher</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">think</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w">       </span><span class="c1">// æ‹¿èµ·å·¦è¾¹ç­·å­</span>
<span class="w">        </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span><span class="w"> </span><span class="c1">// æ‹¿èµ·å³è¾¹ç­·å­</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">eat</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">// å¦‚æœæ‰€æœ‰äººåŒæ—¶æ‹¿èµ·å·¦è¾¹ç­·å­ â†’ æ­»é”</span>
</pre></div>
</div>
<p><strong>è§£å†³æ–¹æ¡ˆ1</strong>ï¼šæœ€å¤š4äººåŒæ—¶æ‹¿ç­·å­</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">semaphore_t</span><span class="w"> </span><span class="n">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="c1">// æœ€å¤š4äºº</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">philosopher</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">think</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">room</span><span class="p">);</span><span class="w">  </span><span class="c1">// è¿›å…¥æˆ¿é—´</span>
<span class="w">        </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">eat</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">room</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç¦»å¼€æˆ¿é—´</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>è§£å†³æ–¹æ¡ˆ2</strong>ï¼šå¥‡æ•°å…ˆå·¦åå³ï¼Œå¶æ•°å…ˆå³åå·¦</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">philosopher</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">think</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">            </span><span class="n">pick_up</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">eat</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">        </span><span class="n">put_down</span><span class="p">(</span><span class="n">chopstick</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id24">
<h3>8.2 æ•°æ®åº“æ­»é”<a class="headerlink" href="#id24" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- äº‹åŠ¡1</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">-- é”å®šè´¦æˆ·1</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">  </span><span class="c1">-- ç­‰å¾…è´¦æˆ·2</span>
<span class="k">COMMIT</span><span class="p">;</span>

<span class="c1">-- äº‹åŠ¡2</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">   </span><span class="c1">-- é”å®šè´¦æˆ·2</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="c1">-- ç­‰å¾…è´¦æˆ·1</span>
<span class="k">COMMIT</span><span class="p">;</span>

<span class="c1">-- æ­»é”ï¼</span>
</pre></div>
</div>
<p><strong>MySQLæ­»é”æ£€æµ‹</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// MySQLè‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">detect_and_recover</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">detect_cycle_in_wait_graph</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Transaction</span><span class="w"> </span><span class="o">*</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_victim</span><span class="p">();</span>
<span class="w">        </span><span class="n">rollback</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERROR_DEADLOCK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id25">
<h2>9. å¸¸è§é—®é¢˜<a class="headerlink" href="#id25" title="Permalink to this heading">ïƒ</a></h2>
<section id="q1">
<h3>Q1: æ­»é”å’Œé¥¥é¥¿çš„åŒºåˆ«ï¼Ÿ<a class="headerlink" href="#q1" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p><strong>æ­»é”</strong>ï¼šäº’ç›¸ç­‰å¾…ï¼Œæ°¸è¿œæ— æ³•ç»§ç»­</p></li>
<li><p><strong>é¥¥é¥¿</strong>ï¼šä¸€ç›´å¾—ä¸åˆ°èµ„æºï¼Œä½†ç³»ç»Ÿä»åœ¨è¿è¡Œ</p></li>
</ul>
</section>
<section id="q2">
<h3>Q2: å¦‚ä½•è°ƒè¯•æ­»é”ï¼Ÿ<a class="headerlink" href="#q2" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">aux</span></code> æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ï¼ˆDçŠ¶æ€ï¼‰</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pstack</span></code> æŸ¥çœ‹è°ƒç”¨æ ˆ</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gdb</span></code> é™„åŠ è¿›ç¨‹æŸ¥çœ‹é”çŠ¶æ€</p></li>
<li><p>ä½¿ç”¨æ­»é”æ£€æµ‹å·¥å…·ï¼ˆå¦‚Helgrindï¼‰</p></li>
</ol>
</section>
<section id="q3">
<h3>Q3: ä¸ºä»€ä¹ˆæ•°æ®åº“èƒ½è‡ªåŠ¨å¤„ç†æ­»é”ï¼Ÿ<a class="headerlink" href="#q3" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p>æ•°æ®åº“ç»´æŠ¤ç­‰å¾…å›¾</p></li>
<li><p>å®šæœŸæ£€æµ‹ç¯</p></li>
<li><p>é€‰æ‹©ä»£ä»·å°çš„äº‹åŠ¡å›æ»š</p></li>
<li><p>åº”ç”¨å±‚å¯ä»¥é‡è¯•</p></li>
</ul>
</section>
<section id="q4">
<h3>Q4: å¤šçº¿ç¨‹ç¨‹åºå¦‚ä½•é¿å…æ­»é”ï¼Ÿ<a class="headerlink" href="#q4" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>é”æ’åºï¼ˆæœ€é‡è¦ï¼‰</p></li>
<li><p>ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">trylock</span></code></p></li>
<li><p>è¶…æ—¶æœºåˆ¶</p></li>
<li><p>å‡å°‘é”çš„æŒæœ‰æ—¶é—´</p></li>
<li><p>ä½¿ç”¨æ— é”æ•°æ®ç»“æ„</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="id26">
<h2>10. è°ƒè¯•å·¥å…·<a class="headerlink" href="#id26" title="Permalink to this heading">ïƒ</a></h2>
<section id="linux">
<h3>10.1 Linuxå·¥å…·<a class="headerlink" href="#linux" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>D<span class="w">  </span><span class="c1"># DçŠ¶æ€å¯èƒ½æ˜¯æ­»é”</span>

<span class="c1"># æŸ¥çœ‹çº¿ç¨‹æ ˆ</span>
pstack<span class="w"> </span>&lt;pid&gt;

<span class="c1"># æŸ¥çœ‹é”ä¿¡æ¯</span>
cat<span class="w"> </span>/proc/&lt;pid&gt;/status

<span class="c1"># ä½¿ç”¨gdb</span>
gdb<span class="w"> </span>-p<span class="w"> </span>&lt;pid&gt;
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>threads
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>thread<span class="w"> </span>apply<span class="w"> </span>all<span class="w"> </span>bt
</pre></div>
</div>
</section>
<section id="valgrind-helgrind">
<h3>10.2 Valgrind Helgrind<a class="headerlink" href="#valgrind-helgrind" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ­»é”æ£€æµ‹</span>
valgrind<span class="w"> </span>--tool<span class="o">=</span>helgrind<span class="w"> </span>./program

<span class="c1"># è¾“å‡ºç¤ºä¾‹</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span>Thread<span class="w"> </span><span class="c1">#1: lock order &quot;0x12345 before 0x67890&quot; violated</span>
<span class="o">==</span><span class="nv">12345</span><span class="o">==</span><span class="w"> </span>Thread<span class="w"> </span><span class="c1">#2: lock order &quot;0x67890 before 0x12345&quot;</span>
</pre></div>
</div>
</section>
<section id="id27">
<h3>10.3 æ­»é”æ£€æµ‹ä»£ç <a class="headerlink" href="#id27" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MAX_LOCKS 100</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">lock_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">lock_addr</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">lock_info</span><span class="w"> </span><span class="n">held_locks</span><span class="p">[</span><span class="n">MAX_LOCKS</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">lock_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">record_lock</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">held_locks</span><span class="p">[</span><span class="n">lock_count</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ£€æµ‹ç¯</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">detect_cycle</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Deadlock detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">print_lock_graph</span><span class="p">();</span>
<span class="w">        </span><span class="n">abort</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id28">
<h2>å‚è€ƒèµ„æº<a class="headerlink" href="#id28" title="Permalink to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>ã€ŠOperating Systems: Three Easy Piecesã€‹- Deadlockç« èŠ‚</p></li>
<li><p>ã€ŠDatabase System Conceptsã€‹- äº‹åŠ¡å’Œå¹¶å‘æ§åˆ¶</p></li>
<li><p>Linuxæºç ï¼š<code class="docutils literal notranslate"><span class="pre">kernel/locking/lockdep.c</span></code>ï¼ˆæ­»é”æ£€æµ‹ï¼‰</p></li>
<li><p>ã€ŠArt of Multiprocessor Programmingã€‹</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="æ­»é”å¤„ç†" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../07-tcp-ip/index.html" class="btn btn-neutral float-right" title="TCP-IPåè®®è¯¦è§£" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Code Dojo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>