

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–‡ä»¶ç³»ç»Ÿ &mdash; OS &amp; Network Core 1.0.0 æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=f07cb45e" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=34088549"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=beaddf03"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../genindex.html" />
    <link rel="search" title="æœç´¢" href="../search.html" />
    <link rel="next" title="å¹¶å‘ä¸åŒæ­¥" href="../05-concurrency-sync/index.html" />
    <link rel="prev" title="æ–‡ä»¶ç³»ç»Ÿ" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            OS & Network Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ç›®å½•</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">OS &amp; Network Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-process-thread/index.html">è¿›ç¨‹ä¸çº¿ç¨‹</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-process-scheduling/index.html">è¿›ç¨‹è°ƒåº¦</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03-memory-management/index.html">å†…å­˜ç®¡ç†</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">æ–‡ä»¶ç³»ç»Ÿ</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">æ–‡ä»¶ç³»ç»Ÿ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">ğŸ’¡ æ ¸å¿ƒç»“è®º</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1. æ–‡ä»¶ç³»ç»Ÿç»“æ„</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.1 ç£ç›˜å¸ƒå±€</a></li>
<li class="toctree-l4"><a class="reference internal" href="#super-block">1.2 è¶…çº§å—ï¼ˆSuper Blockï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#inode">2. inodeç»“æ„</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">2.1 inodeå®šä¹‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">2.2 æ•°æ®å—ç´¢å¼•</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3. ç›®å½•ç»“æ„</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">3.1 ç›®å½•é¡¹</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.2 è·¯å¾„è§£æ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vs">4. ç¡¬é“¾æ¥ vs è½¯é“¾æ¥</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">4.1 ç¡¬é“¾æ¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">4.2 è½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">4.3 å¯¹æ¯”</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">5. æ–‡ä»¶æ“ä½œ</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">5.1 æ–‡ä»¶åˆ›å»º</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">5.2 æ–‡ä»¶è¯»å–</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">5.3 æ–‡ä»¶å†™å…¥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">5.4 æ–‡ä»¶åˆ é™¤</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id18">6. ç¼“å­˜æœºåˆ¶</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#page-cache">6.1 é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-ahead">6.2 é¢„è¯»ï¼ˆRead-aheadï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">6.3 è„é¡µå›å†™</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id20">7. æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id21">7.1 ä¸€è‡´æ€§é—®é¢˜</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">7.2 æ—¥å¿—æœºåˆ¶</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id23">8. ç£ç›˜è°ƒåº¦</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fcfs">8.1 FCFSï¼ˆå…ˆæ¥å…ˆæœåŠ¡ï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sstf">8.2 SSTFï¼ˆæœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scan">8.3 SCANï¼ˆç”µæ¢¯ç®—æ³•ï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id24">9. å¸¸è§é—®é¢˜</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#q1-inode">Q1: ä¸ºä»€ä¹ˆéœ€è¦inodeï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q2">Q2: ç›®å½•å¯ä»¥æœ‰ç¡¬é“¾æ¥å—ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q3">Q3: å¦‚ä½•æé«˜æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q4-ext4ext3">Q4: ext4æ¯”ext3å¥½åœ¨å“ªé‡Œï¼Ÿ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id25">å‚è€ƒèµ„æº</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../05-concurrency-sync/index.html">å¹¶å‘ä¸åŒæ­¥</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06-deadlock/index.html">æ­»é”å¤„ç†</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07-tcp-ip/index.html">TCP-IPåè®®è¯¦è§£</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08-http/index.html">HTTPåè®®ä¸å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-socket/index.html">Socketç¼–ç¨‹å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10-network-tools/index.html">ç½‘ç»œå·¥å…·å¤§å…¨</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-network-security/index.html">ç½‘ç»œå®‰å…¨åŸºç¡€</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OS & Network Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">æ–‡ä»¶ç³»ç»Ÿ</a></li>
      <li class="breadcrumb-item active">æ–‡ä»¶ç³»ç»Ÿ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/04-file-system/README.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>æ–‡ä»¶ç³»ç»Ÿ<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<section id="id2">
<h2>ğŸ’¡ æ ¸å¿ƒç»“è®º<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<ol class="arabic simple">
<li><p><strong>inodeå­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®ï¼Œæ•°æ®å—å­˜å‚¨æ–‡ä»¶å†…å®¹</strong></p></li>
<li><p><strong>ç›®å½•æ˜¯ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå­˜å‚¨æ–‡ä»¶ååˆ°inodeçš„æ˜ å°„</strong></p></li>
<li><p><strong>ç¡¬é“¾æ¥å…±äº«inodeï¼Œè½¯é“¾æ¥æ˜¯ç‹¬ç«‹æ–‡ä»¶å­˜å‚¨è·¯å¾„</strong></p></li>
<li><p><strong>æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿé€šè¿‡é¢„å†™æ—¥å¿—ä¿è¯ä¸€è‡´æ€§</strong></p></li>
<li><p><strong>ç¼“å­˜å’Œé¢„è¯»æ˜¯æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½çš„å…³é”®</strong></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="id3">
<h2>1. æ–‡ä»¶ç³»ç»Ÿç»“æ„<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<section id="id4">
<h3>1.1 ç£ç›˜å¸ƒå±€<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>å…¸å‹æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€ï¼ˆå¦‚ext2/3/4ï¼‰:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Boot Block  â”‚  Super   â”‚  inode   â”‚  Data    â”‚  Data    â”‚
â”‚   (1 block)  â”‚  Block   â”‚  Bitmap  â”‚  Bitmap  â”‚  Blocks  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Boot Block:  å¯åŠ¨ä¿¡æ¯
Super Block: æ–‡ä»¶ç³»ç»Ÿå…ƒä¿¡æ¯
inode Bitmap: inodeä½¿ç”¨æƒ…å†µ
Data Bitmap:  æ•°æ®å—ä½¿ç”¨æƒ…å†µ
Data Blocks:  å®é™…æ•°æ®
</pre></div>
</div>
</section>
<section id="super-block">
<h3>1.2 è¶…çº§å—ï¼ˆSuper Blockï¼‰<a class="headerlink" href="#super-block" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">ext2_super_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_inodes_count</span><span class="p">;</span><span class="w">      </span><span class="c1">// inodeæ€»æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_blocks_count</span><span class="p">;</span><span class="w">      </span><span class="c1">// å—æ€»æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_free_blocks_count</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç©ºé—²å—æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_free_inodes_count</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç©ºé—²inodeæ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_first_data_block</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç¬¬ä¸€ä¸ªæ•°æ®å—</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_log_block_size</span><span class="p">;</span><span class="w">    </span><span class="c1">// å—å¤§å°ï¼ˆ1024 &lt;&lt; s_log_block_sizeï¼‰</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_blocks_per_group</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ¯ç»„å—æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_inodes_per_group</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ¯ç»„inodeæ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_mtime</span><span class="p">;</span><span class="w">             </span><span class="c1">// æŒ‚è½½æ—¶é—´</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">s_wtime</span><span class="p">;</span><span class="w">             </span><span class="c1">// å†™å…¥æ—¶é—´</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">s_magic</span><span class="p">;</span><span class="w">             </span><span class="c1">// é­”æ•°ï¼ˆ0xEF53ï¼‰</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">s_state</span><span class="p">;</span><span class="w">             </span><span class="c1">// æ–‡ä»¶ç³»ç»ŸçŠ¶æ€</span>
<span class="w">    </span><span class="c1">// ... æ›´å¤šå­—æ®µ</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="inode">
<h2>2. inodeç»“æ„<a class="headerlink" href="#inode" title="Link to this heading">ïƒ</a></h2>
<section id="id5">
<h3>2.1 inodeå®šä¹‰<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<p><strong>inodeï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰</strong>ï¼šå­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">ext2_inode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">i_mode</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ–‡ä»¶ç±»å‹å’Œæƒé™</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">i_uid</span><span class="p">;</span><span class="w">         </span><span class="c1">// æ‰€æœ‰è€…ç”¨æˆ·ID</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_size</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_atime</span><span class="p">;</span><span class="w">       </span><span class="c1">// è®¿é—®æ—¶é—´</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_ctime</span><span class="p">;</span><span class="w">       </span><span class="c1">// åˆ›å»ºæ—¶é—´</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_mtime</span><span class="p">;</span><span class="w">       </span><span class="c1">// ä¿®æ”¹æ—¶é—´</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_dtime</span><span class="p">;</span><span class="w">       </span><span class="c1">// åˆ é™¤æ—¶é—´</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">i_gid</span><span class="p">;</span><span class="w">         </span><span class="c1">// ç»„ID</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">i_links_count</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç¡¬é“¾æ¥è®¡æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_blocks</span><span class="p">;</span><span class="w">      </span><span class="c1">// å—æ•°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_flags</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ ‡å¿—</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// æ•°æ®å—æŒ‡é’ˆï¼ˆå…³é”®ï¼ï¼‰</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">i_block</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span><span class="w">   </span><span class="c1">// å—æŒ‡é’ˆæ•°ç»„</span>
<span class="w">    </span><span class="c1">// [0-11]: ç›´æ¥æŒ‡é’ˆ</span>
<span class="w">    </span><span class="c1">// [12]:   ä¸€çº§é—´æ¥æŒ‡é’ˆ</span>
<span class="w">    </span><span class="c1">// [13]:   äºŒçº§é—´æ¥æŒ‡é’ˆ</span>
<span class="w">    </span><span class="c1">// [14]:   ä¸‰çº§é—´æ¥æŒ‡é’ˆ</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>2.2 æ•°æ®å—ç´¢å¼•<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>i_block[15]æ•°ç»„ï¼š

[0-11]: ç›´æ¥æŒ‡é’ˆ â†’ æ•°æ®å—
        12ä¸ªå— Ã— 4KB = 48KB

[12]: ä¸€çº§é—´æ¥æŒ‡é’ˆ â†’ æŒ‡é’ˆå— â†’ æ•°æ®å—
      1024ä¸ªæŒ‡é’ˆ Ã— 4KB = 4MB

[13]: äºŒçº§é—´æ¥æŒ‡é’ˆ â†’ æŒ‡é’ˆå— â†’ æŒ‡é’ˆå— â†’ æ•°æ®å—
      1024 Ã— 1024 Ã— 4KB = 4GB

[14]: ä¸‰çº§é—´æ¥æŒ‡é’ˆ
      1024 Ã— 1024 Ã— 1024 Ã— 4KB = 4TB

æœ€å¤§æ–‡ä»¶å¤§å° â‰ˆ 4TB
</pre></div>
</div>
<p><strong>æŸ¥æ‰¾æ•°æ®å—ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// è¯»å–æ–‡ä»¶åç§»offsetå¤„çš„æ•°æ®</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">get_block_num</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">block_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">block_size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ¯å—1024ä¸ªæŒ‡é’ˆ</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç›´æ¥å—</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_block</span><span class="p">[</span><span class="n">block_index</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">block_index</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä¸€çº§é—´æ¥å—</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">indirect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_block</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">indirect</span><span class="p">[</span><span class="n">block_index</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">block_index</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// äºŒçº§é—´æ¥å—</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">level1_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block_index</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">level2_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block_index</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">ptrs_per_block</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">indirect1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_block</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">indirect2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">indirect1</span><span class="p">[</span><span class="n">level1_index</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">indirect2</span><span class="p">[</span><span class="n">level2_index</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// ä¸‰çº§é—´æ¥å—...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id7">
<h2>3. ç›®å½•ç»“æ„<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h2>
<section id="id8">
<h3>3.1 ç›®å½•é¡¹<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h3>
<p><strong>ç›®å½•ä¹Ÿæ˜¯æ–‡ä»¶</strong>ï¼Œå†…å®¹æ˜¯ç›®å½•é¡¹åˆ—è¡¨</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">ext2_dir_entry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">inode</span><span class="p">;</span><span class="w">          </span><span class="c1">// inodeå·</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">rec_len</span><span class="p">;</span><span class="w">        </span><span class="c1">// è®°å½•é•¿åº¦</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">name_len</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ–‡ä»¶åé•¿åº¦</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">file_type</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ–‡ä»¶ç±»å‹</span>
<span class="w">    </span><span class="kt">char</span><span class="w">  </span><span class="n">name</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span><span class="w">      </span><span class="c1">// æ–‡ä»¶å</span>
<span class="p">};</span>
</pre></div>
</div>
<p><strong>ç›®å½•ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ç›®å½•inode</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">æ•°æ®å—å†…å®¹</span><span class="p">:</span>
  <span class="p">[</span><span class="n">inode</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;file1.txt&quot;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">inode</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;file2.txt&quot;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">inode</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subdir&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>3.2 è·¯å¾„è§£æ<a class="headerlink" href="#id9" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">path_lookup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">current_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root_inode</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä»æ ¹ç›®å½•å¼€å§‹</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. è¯»å–å½“å‰ç›®å½•çš„æ•°æ®å—</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ext2_inode</span><span class="w"> </span><span class="o">*</span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_inode</span><span class="p">(</span><span class="n">current_inode</span><span class="p">);</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dir_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 2. æŸ¥æ‰¾ç›®å½•é¡¹</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ext2_dir_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_entry</span><span class="p">(</span><span class="n">dir_data</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ–‡ä»¶ä¸å­˜åœ¨</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 3. è¿›å…¥ä¸‹ä¸€çº§</span>
<span class="w">        </span><span class="n">current_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">;</span>
<span class="w">        </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">current_inode</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>è·¯å¾„æŸ¥æ‰¾ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>æŸ¥æ‰¾è·¯å¾„: /home/user/file.txt

1. ä»æ ¹inode (2) å¼€å§‹
2. è¯»å–æ ¹ç›®å½•ï¼ŒæŸ¥æ‰¾&quot;home&quot; â†’ inode 100
3. è¯»å–inode 100ï¼ŒæŸ¥æ‰¾&quot;user&quot; â†’ inode 200
4. è¯»å–inode 200ï¼ŒæŸ¥æ‰¾&quot;file.txt&quot; â†’ inode 300
5. è¿”å›inode 300
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="vs">
<h2>4. ç¡¬é“¾æ¥ vs è½¯é“¾æ¥<a class="headerlink" href="#vs" title="Link to this heading">ïƒ</a></h2>
<section id="id10">
<h3>4.1 ç¡¬é“¾æ¥<a class="headerlink" href="#id10" title="Link to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå¤šä¸ªç›®å½•é¡¹æŒ‡å‘åŒä¸€ä¸ªinode</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºç¡¬é“¾æ¥</span>
$<span class="w"> </span>ln<span class="w"> </span>file.txt<span class="w"> </span>hardlink.txt

<span class="c1"># inodeç›¸åŒ</span>
$<span class="w"> </span>ls<span class="w"> </span>-i
<span class="m">12345</span><span class="w"> </span>file.txt
<span class="m">12345</span><span class="w"> </span>hardlink.txt
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">create_hard_link</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">oldpath</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">newpath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. è·å–åŸæ–‡ä»¶inode</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inode_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">oldpath</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. åœ¨æ–°ç›®å½•ä¸­åˆ›å»ºç›®å½•é¡¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dir_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">newpath</span><span class="p">));</span>
<span class="w">    </span><span class="n">add_dir_entry</span><span class="p">(</span><span class="n">dir_inode</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">(</span><span class="n">newpath</span><span class="p">),</span><span class="w"> </span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. å¢åŠ ç¡¬é“¾æ¥è®¡æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_inode</span><span class="p">(</span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_links_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">write_inode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul class="simple">
<li><p>å…±äº«inodeå’Œæ•°æ®</p></li>
<li><p>åˆ é™¤ä¸€ä¸ªé“¾æ¥ï¼Œæ–‡ä»¶ä»å­˜åœ¨</p></li>
<li><p>ä¸èƒ½è·¨æ–‡ä»¶ç³»ç»Ÿ</p></li>
<li><p>ä¸èƒ½é“¾æ¥ç›®å½•</p></li>
</ul>
</section>
<section id="id11">
<h3>4.2 è½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰<a class="headerlink" href="#id11" title="Link to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå†…å®¹æ˜¯ç›®æ ‡è·¯å¾„</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºè½¯é“¾æ¥</span>
$<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>file.txt<span class="w"> </span>symlink.txt

<span class="c1"># inodeä¸åŒ</span>
$<span class="w"> </span>ls<span class="w"> </span>-i
<span class="m">12345</span><span class="w"> </span>file.txt
<span class="m">67890</span><span class="w"> </span>symlink.txt
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">create_symlink</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">linkpath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. åˆ›å»ºæ–°inode</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inode_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_inode</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_inode</span><span class="p">(</span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. è®¾ç½®ç±»å‹ä¸ºç¬¦å·é“¾æ¥</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFLNK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0777</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. å­˜å‚¨ç›®æ ‡è·¯å¾„</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_block</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="w">  </span><span class="c1">// è·¯å¾„å­˜åœ¨i_blockä¸­</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 4. åœ¨ç›®å½•ä¸­æ·»åŠ ç›®å½•é¡¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dir_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">linkpath</span><span class="p">));</span>
<span class="w">    </span><span class="n">add_dir_entry</span><span class="p">(</span><span class="n">dir_inode</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">(</span><span class="n">linkpath</span><span class="p">),</span><span class="w"> </span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul class="simple">
<li><p>ç‹¬ç«‹æ–‡ä»¶</p></li>
<li><p>å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿ</p></li>
<li><p>å¯ä»¥é“¾æ¥ç›®å½•</p></li>
<li><p>ç›®æ ‡åˆ é™¤åå˜æˆæ‚¬ç©ºé“¾æ¥</p></li>
</ul>
</section>
<section id="id12">
<h3>4.3 å¯¹æ¯”<a class="headerlink" href="#id12" title="Link to this heading">ïƒ</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ç‰¹æ€§</p></th>
<th class="head"><p>ç¡¬é“¾æ¥</p></th>
<th class="head"><p>è½¯é“¾æ¥</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>inode</p></td>
<td><p>ç›¸åŒ</p></td>
<td><p>ä¸åŒ</p></td>
</tr>
<tr class="row-odd"><td><p>è·¨æ–‡ä»¶ç³»ç»Ÿ</p></td>
<td><p>å¦</p></td>
<td><p>æ˜¯</p></td>
</tr>
<tr class="row-even"><td><p>é“¾æ¥ç›®å½•</p></td>
<td><p>å¦</p></td>
<td><p>æ˜¯</p></td>
</tr>
<tr class="row-odd"><td><p>åŸæ–‡ä»¶åˆ é™¤</p></td>
<td><p>ä»å¯è®¿é—®</p></td>
<td><p>æ‚¬ç©º</p></td>
</tr>
<tr class="row-even"><td><p>ç£ç›˜ç©ºé—´</p></td>
<td><p>å…±äº«</p></td>
<td><p>ç‹¬ç«‹ï¼ˆè·¯å¾„ï¼‰</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<hr class="docutils" />
<section id="id13">
<h2>5. æ–‡ä»¶æ“ä½œ<a class="headerlink" href="#id13" title="Link to this heading">ïƒ</a></h2>
<section id="id14">
<h3>5.1 æ–‡ä»¶åˆ›å»º<a class="headerlink" href="#id14" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">create_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. åˆ†é…inode</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inode_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_inode</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_inode</span><span class="p">(</span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. åˆå§‹åŒ–inode</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_uid</span><span class="p">();</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_gid</span><span class="p">();</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_links_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. åœ¨çˆ¶ç›®å½•æ·»åŠ ç›®å½•é¡¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dir_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
<span class="w">    </span><span class="n">add_dir_entry</span><span class="p">(</span><span class="n">dir_inode</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="w"> </span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inode_num</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id15">
<h3>5.2 æ–‡ä»¶è¯»å–<a class="headerlink" href="#id15" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">file_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_file</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_inode</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 1. è®¡ç®—è¯»å–èŒƒå›´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// EOF</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">to_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. é€å—è¯»å–</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">bytes_read</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">to_read</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">block_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_block_num</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">);</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">block_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">block_num</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">block_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">copy_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">block_offset</span><span class="p">,</span><span class="w"> </span><span class="n">to_read</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">,</span><span class="w"> </span><span class="n">block_data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_offset</span><span class="p">,</span><span class="w"> </span><span class="n">copy_len</span><span class="p">);</span>
<span class="w">        </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">copy_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. æ›´æ–°è®¿é—®æ—¶é—´</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_atime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3>5.3 æ–‡ä»¶å†™å…¥<a class="headerlink" href="#id16" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">file_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_file</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_inode</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes_written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">bytes_written</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. è·å–æˆ–åˆ†é…æ•°æ®å—</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">block_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_block_num</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">block_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_block</span><span class="p">();</span>
<span class="w">            </span><span class="n">set_block_num</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">,</span><span class="w"> </span><span class="n">block_num</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// 2. å†™å…¥æ•°æ®</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">block_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_block</span><span class="p">(</span><span class="n">block_num</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">block_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">copy_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">block_offset</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">block_data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_offset</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">,</span><span class="w"> </span><span class="n">copy_len</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_block</span><span class="p">(</span><span class="n">block_num</span><span class="p">,</span><span class="w"> </span><span class="n">block_data</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">bytes_written</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">copy_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. æ›´æ–°inode</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_written</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3>5.4 æ–‡ä»¶åˆ é™¤<a class="headerlink" href="#id17" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. è·å–inode</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inode_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_inode</span><span class="p">(</span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. ä»çˆ¶ç›®å½•åˆ é™¤ç›®å½•é¡¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dir_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_lookup</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
<span class="w">    </span><span class="n">remove_dir_entry</span><span class="p">(</span><span class="n">dir_inode</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. å‡å°‘ç¡¬é“¾æ¥è®¡æ•°</span>
<span class="w">    </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_links_count</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 4. å¦‚æœæ²¡æœ‰é“¾æ¥äº†ï¼Œé‡Šæ”¾èµ„æº</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_links_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é‡Šæ”¾æ•°æ®å—</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_blocks</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">block_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_block_num</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">);</span>
<span class="w">            </span><span class="n">free_block</span><span class="p">(</span><span class="n">block_num</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// é‡Šæ”¾inode</span>
<span class="w">        </span><span class="n">free_inode</span><span class="p">(</span><span class="n">inode_num</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id18">
<h2>6. ç¼“å­˜æœºåˆ¶<a class="headerlink" href="#id18" title="Link to this heading">ïƒ</a></h2>
<section id="page-cache">
<h3>6.1 é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰<a class="headerlink" href="#page-cache" title="Link to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå°†ç£ç›˜æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">page_cache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span><span class="w">      </span><span class="c1">// çº¢é»‘æ ‘ç´¢å¼•</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">cached_page</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w">       </span><span class="c1">// é¡µç´¢å¼•</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">;</span><span class="w">         </span><span class="c1">// ç‰©ç†é¡µ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dirty</span><span class="p">;</span><span class="w">                 </span><span class="c1">// æ˜¯å¦ä¿®æ”¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">rb_node</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">read_with_cache</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">page_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 1. æŸ¥æ‰¾ç¼“å­˜</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cached_page</span><span class="w"> </span><span class="o">*</span><span class="n">cp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_cached_page</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">page_index</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç¼“å­˜å‘½ä¸­</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»ç£ç›˜è¯»å–</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
<span class="w">    </span><span class="n">read_from_disk</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">page_index</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. åŠ å…¥ç¼“å­˜</span>
<span class="w">    </span><span class="n">add_to_cache</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">page_index</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="read-ahead">
<h3>6.2 é¢„è¯»ï¼ˆRead-aheadï¼‰<a class="headerlink" href="#read-ahead" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">readahead</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// é¢„è¯»åç»­Nä¸ªé¡µé¢</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ra_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w">  </span><span class="c1">// é¢„è¯»16ä¸ªé¡µé¢</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ra_pages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">off_t</span><span class="w"> </span><span class="n">ra_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ra_offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// å¼‚æ­¥è¯»å–åˆ°ç¼“å­˜</span>
<span class="w">        </span><span class="n">async_read_to_cache</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_inode</span><span class="p">,</span><span class="w"> </span><span class="n">ra_offset</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id19">
<h3>6.3 è„é¡µå›å†™<a class="headerlink" href="#id19" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">flush_dirty_pages</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">dirty_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_dirty_pages</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">dirty_list</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å†™å›ç£ç›˜</span>
<span class="w">        </span><span class="n">write_to_disk</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// æ ‡è®°ä¸ºå¹²å‡€</span>
<span class="w">        </span><span class="n">page</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å®šæœŸåˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">pdflush_thread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="w">        </span><span class="n">flush_dirty_pages</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id20">
<h2>7. æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ<a class="headerlink" href="#id20" title="Link to this heading">ïƒ</a></h2>
<section id="id21">
<h3>7.1 ä¸€è‡´æ€§é—®é¢˜<a class="headerlink" href="#id21" title="Link to this heading">ïƒ</a></h3>
<p><strong>é—®é¢˜</strong>ï¼šç³»ç»Ÿå´©æºƒå¯èƒ½å¯¼è‡´æ–‡ä»¶ç³»ç»Ÿä¸ä¸€è‡´</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>åœºæ™¯ï¼šåˆ›å»ºæ–‡ä»¶
1. åœ¨ç›®å½•ä¸­æ·»åŠ ç›®å½•é¡¹
2. åˆ†é…inode
3. å†™å…¥æ•°æ®

å¦‚æœåœ¨æ­¥éª¤2åå´©æºƒï¼š
- ç›®å½•é¡¹å­˜åœ¨ï¼Œä½†inodeæœªåˆ†é…
- æ–‡ä»¶ç³»ç»Ÿä¸ä¸€è‡´ï¼
</pre></div>
</div>
</section>
<section id="id22">
<h3>7.2 æ—¥å¿—æœºåˆ¶<a class="headerlink" href="#id22" title="Link to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">journal_entry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">  </span><span class="c1">// BEGIN, COMMIT, ABORT</span>
<span class="w">    </span><span class="c1">// æ“ä½œå†…å®¹</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">journaled_create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">begin_transaction</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 1. å†™æ—¥å¿—</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">BEGIN</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;allocate inode&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;add dir entry&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;write data&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">COMMIT</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. æ‰§è¡Œå®é™…æ“ä½œ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_inode</span><span class="p">();</span>
<span class="w">    </span><span class="n">add_dir_entry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_data</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. æ ‡è®°æ—¥å¿—å®Œæˆ</span>
<span class="w">    </span><span class="n">write_journal</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">DONE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>æ¢å¤è¿‡ç¨‹</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">recover</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">transaction</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">COMMIT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">            </span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é‡åšæœªå®Œæˆçš„äº‹åŠ¡</span>
<span class="w">            </span><span class="n">redo_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                   </span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">COMMIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å›æ»šæœªæäº¤çš„äº‹åŠ¡</span>
<span class="w">            </span><span class="n">undo_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id23">
<h2>8. ç£ç›˜è°ƒåº¦<a class="headerlink" href="#id23" title="Link to this heading">ïƒ</a></h2>
<section id="fcfs">
<h3>8.1 FCFSï¼ˆå…ˆæ¥å…ˆæœåŠ¡ï¼‰<a class="headerlink" href="#fcfs" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">fcfs_schedule</span><span class="p">(</span><span class="n">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_empty</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">request</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
<span class="w">        </span><span class="n">seek_to</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
<span class="w">        </span><span class="n">read_or_write</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sstf">
<h3>8.2 SSTFï¼ˆæœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼‰<a class="headerlink" href="#sstf" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">sstf_schedule</span><span class="p">(</span><span class="n">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">current_pos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_empty</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é€‰æ‹©è·ç¦»å½“å‰ä½ç½®æœ€è¿‘çš„è¯·æ±‚</span>
<span class="w">        </span><span class="n">request</span><span class="w"> </span><span class="o">*</span><span class="n">closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_closest</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">current_pos</span><span class="p">);</span>
<span class="w">        </span><span class="n">seek_to</span><span class="p">(</span><span class="n">closest</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
<span class="w">        </span><span class="n">read_or_write</span><span class="p">(</span><span class="n">closest</span><span class="p">);</span>
<span class="w">        </span><span class="n">current_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closest</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="scan">
<h3>8.3 SCANï¼ˆç”µæ¢¯ç®—æ³•ï¼‰<a class="headerlink" href="#scan" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">scan_schedule</span><span class="p">(</span><span class="n">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UP</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘ä¸Šæ‰«æ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_empty</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">request</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_next_higher</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">seek_to</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
<span class="w">                </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DOWN</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ°è¾¾é¡¶ç«¯ï¼Œåå‘</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">request</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_next_lower</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">seek_to</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
<span class="w">                </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UP</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ°è¾¾åº•ç«¯ï¼Œåå‘</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id24">
<h2>9. å¸¸è§é—®é¢˜<a class="headerlink" href="#id24" title="Link to this heading">ïƒ</a></h2>
<section id="q1-inode">
<h3>Q1: ä¸ºä»€ä¹ˆéœ€è¦inodeï¼Ÿ<a class="headerlink" href="#q1-inode" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p>åˆ†ç¦»æ–‡ä»¶åå’Œå…ƒæ•°æ®</p></li>
<li><p>æ”¯æŒç¡¬é“¾æ¥</p></li>
<li><p>å¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶å±æ€§</p></li>
<li><p>çµæ´»çš„æƒé™ç®¡ç†</p></li>
</ul>
</section>
<section id="q2">
<h3>Q2: ç›®å½•å¯ä»¥æœ‰ç¡¬é“¾æ¥å—ï¼Ÿ<a class="headerlink" href="#q2" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p>ä¸å¯ä»¥ï¼ˆä¼šå¯¼è‡´å¾ªç¯ï¼‰</p></li>
<li><p>åªæœ‰<code class="docutils literal notranslate"><span class="pre">.</span></code>å’Œ<code class="docutils literal notranslate"><span class="pre">..</span></code>æ˜¯ç‰¹æ®Šçš„ç¡¬é“¾æ¥</p></li>
<li><p>å¯ä»¥åˆ›å»ºç›®å½•çš„è½¯é“¾æ¥</p></li>
</ul>
</section>
<section id="q3">
<h3>Q3: å¦‚ä½•æé«˜æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ï¼Ÿ<a class="headerlink" href="#q3" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>é¡µç¼“å­˜</p></li>
<li><p>é¢„è¯»</p></li>
<li><p>å»¶è¿Ÿå†™å…¥</p></li>
<li><p>inodeç¼“å­˜</p></li>
<li><p>ç›®å½•ç¼“å­˜</p></li>
</ol>
</section>
<section id="q4-ext4ext3">
<h3>Q4: ext4æ¯”ext3å¥½åœ¨å“ªé‡Œï¼Ÿ<a class="headerlink" href="#q4-ext4ext3" title="Link to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p>æ›´å¤§æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ</p></li>
<li><p>Extentä»£æ›¿é—´æ¥å—ï¼ˆè¿ç»­åˆ†é…ï¼‰</p></li>
<li><p>å»¶è¿Ÿåˆ†é…</p></li>
<li><p>æ—¥å¿—æ ¡éªŒå’Œ</p></li>
<li><p>åœ¨çº¿ç¢ç‰‡æ•´ç†</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id25">
<h2>å‚è€ƒèµ„æº<a class="headerlink" href="#id25" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>ã€ŠOperating Systems: Three Easy Piecesã€‹- File Systemsç« èŠ‚</p></li>
<li><p>Linuxæºç ï¼š<code class="docutils literal notranslate"><span class="pre">fs/ext4/</span></code>, <code class="docutils literal notranslate"><span class="pre">fs/inode.c</span></code></p></li>
<li><p>ext4æ–‡æ¡£ï¼šDocumentation/filesystems/ext4.txt</p></li>
<li><p>ã€ŠUnixæ–‡ä»¶ç³»ç»Ÿå‰–æã€‹</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="é¡µè„š">
        <a href="index.html" class="btn btn-neutral float-left" title="æ–‡ä»¶ç³»ç»Ÿ" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> ä¸Šä¸€é¡µ</a>
        <a href="../05-concurrency-sync/index.html" class="btn btn-neutral float-right" title="å¹¶å‘ä¸åŒæ­¥" accesskey="n" rel="next">ä¸‹ä¸€é¡µ <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2025, Code Dojoã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>