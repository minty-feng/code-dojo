

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¹¶å‘ä¸åŒæ­¥ &mdash; OS &amp; Network Core 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d0851c8" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/copy-code.js?v=caf91246"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="æ­»é”å¤„ç†" href="../06-deadlock/index.html" />
    <link rel="prev" title="å¹¶å‘ä¸åŒæ­¥" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            OS & Network Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ç›®å½•</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">OS &amp; Network Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-process-thread/index.html">è¿›ç¨‹ä¸çº¿ç¨‹</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-process-scheduling/index.html">è¿›ç¨‹è°ƒåº¦</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03-memory-management/index.html">å†…å­˜ç®¡ç†</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04-file-system/index.html">æ–‡ä»¶ç³»ç»Ÿ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">å¹¶å‘ä¸åŒæ­¥</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">å¹¶å‘ä¸åŒæ­¥</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">ğŸ’¡ æ ¸å¿ƒç»“è®º</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1. ä¸´ç•ŒåŒºé—®é¢˜</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#race-condition">1.1 ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.2 ä¸´ç•ŒåŒºè§£å†³æ–¹æ¡ˆè¦æ±‚</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">2. é”æœºåˆ¶</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spinlock">2.1 è‡ªæ—‹é”ï¼ˆSpinlockï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mutex">2.2 äº’æ–¥é”ï¼ˆMutexï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rwlock">2.3 è¯»å†™é”ï¼ˆRWLockï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#semaphore">3. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">3.1 äºŒå…ƒä¿¡å·é‡</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">3.2 è®¡æ•°ä¿¡å·é‡</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">3.3 ç»å…¸é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.4 ç»å…¸é—®é¢˜ï¼šè¯»è€…-å†™è€…</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#condition-variable">4. æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">4.1 åŸºæœ¬æ“ä½œ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">4.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆæ¡ä»¶å˜é‡ç‰ˆï¼‰</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#monitor">5. ç®¡ç¨‹ï¼ˆMonitorï¼‰</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">6. æ— é”ç¼–ç¨‹</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">6.1 åŸå­æ“ä½œ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">6.2 æ— é”æ ˆ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bug">7. å¸¸è§å¹¶å‘bug</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id15">7.1 æ­»é”</a></li>
<li class="toctree-l4"><a class="reference internal" href="#livelock">7.2 æ´»é”ï¼ˆLivelockï¼‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">7.3 ä¼˜å…ˆçº§åè½¬</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">8. æ€§èƒ½ä¼˜åŒ–</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id18">8.1 å‡å°‘é”ç«äº‰</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">8.2 æ— é”æ•°æ®ç»“æ„</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id20">9. å¸¸è§é—®é¢˜</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#q1-vs">Q1: è‡ªæ—‹é” vs äº’æ–¥é”ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q2-vs">Q2: ä¿¡å·é‡ vs æ¡ä»¶å˜é‡ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q3">Q3: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#q4-volatile-vs-atomic">Q4: volatile vs atomicï¼Ÿ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#leetcode">LeetCodeç›¸å…³é¢˜ç›®</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">å‚è€ƒèµ„æº</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../06-deadlock/index.html">æ­»é”å¤„ç†</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07-tcp-ip/index.html">TCP-IPåè®®è¯¦è§£</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08-http/index.html">HTTPåè®®ä¸å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-socket/index.html">Socketç¼–ç¨‹å®æˆ˜</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10-network-tools/index.html">ç½‘ç»œå·¥å…·å¤§å…¨</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-network-security/index.html">ç½‘ç»œå®‰å…¨åŸºç¡€</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OS & Network Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">å¹¶å‘ä¸åŒæ­¥</a></li>
      <li class="breadcrumb-item active">å¹¶å‘ä¸åŒæ­¥</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/05-concurrency-sync/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>å¹¶å‘ä¸åŒæ­¥<a class="headerlink" href="#id1" title="Permalink to this heading">ïƒ</a></h1>
<section id="id2">
<h2>ğŸ’¡ æ ¸å¿ƒç»“è®º<a class="headerlink" href="#id2" title="Permalink to this heading">ïƒ</a></h2>
<ol class="arabic simple">
<li><p><strong>ä¸´ç•ŒåŒºé—®é¢˜çš„ä¸‰ä¸ªæ¡ä»¶ï¼šäº’æ–¥ã€è¿›æ­¥ã€æœ‰é™ç­‰å¾…</strong></p></li>
<li><p><strong>é”çš„å®ç°éœ€è¦ç¡¬ä»¶æ”¯æŒï¼ˆåŸå­æŒ‡ä»¤ï¼‰</strong></p></li>
<li><p><strong>ä¿¡å·é‡è§£å†³åŒæ­¥é—®é¢˜ï¼Œäº’æ–¥é”è§£å†³äº’æ–¥é—®é¢˜</strong></p></li>
<li><p><strong>æ¡ä»¶å˜é‡å¿…é¡»ä¸äº’æ–¥é”é…åˆä½¿ç”¨</strong></p></li>
<li><p><strong>é¿å…æ­»é”çš„å…³é”®æ˜¯ç ´åå…¶å››ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€</strong></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="id3">
<h2>1. ä¸´ç•ŒåŒºé—®é¢˜<a class="headerlink" href="#id3" title="Permalink to this heading">ïƒ</a></h2>
<section id="race-condition">
<h3>1.1 ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰<a class="headerlink" href="#race-condition" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>ç¤ºä¾‹</strong>ï¼šé“¶è¡Œè´¦æˆ·</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="c1">// çº¿ç¨‹1ï¼šå–æ¬¾500</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">withdraw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span><span class="w">    </span><span class="c1">// è¯»å–1000</span>
<span class="w">    </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w">     </span><span class="c1">// è®¡ç®—500</span>
<span class="w">    </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w">        </span><span class="c1">// å†™å›500</span>
<span class="p">}</span>

<span class="c1">// çº¿ç¨‹2ï¼šå–æ¬¾300</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">withdraw2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="p">;</span><span class="w">    </span><span class="c1">// è¯»å–1000ï¼ˆï¼ï¼‰</span>
<span class="w">    </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w">     </span><span class="c1">// è®¡ç®—700</span>
<span class="w">    </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w">        </span><span class="c1">// å†™å›700ï¼ˆï¼ï¼‰</span>
<span class="p">}</span>

<span class="c1">// ç»“æœï¼šbalance = 700 æˆ– 500ï¼ˆé”™è¯¯ï¼åº”è¯¥æ˜¯200ï¼‰</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3>1.2 ä¸´ç•ŒåŒºè§£å†³æ–¹æ¡ˆè¦æ±‚<a class="headerlink" href="#id4" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>ä¸‰ä¸ªæ¡ä»¶</strong>ï¼š</p>
<ol class="arabic simple">
<li><p><strong>äº’æ–¥ï¼ˆMutual Exclusionï¼‰</strong>ï¼šä¸€æ¬¡åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸´ç•ŒåŒº</p></li>
<li><p><strong>è¿›æ­¥ï¼ˆProgressï¼‰</strong>ï¼šä¸´ç•ŒåŒºå¤–çš„è¿›ç¨‹ä¸èƒ½é˜»æ­¢å…¶ä»–è¿›ç¨‹è¿›å…¥</p></li>
<li><p><strong>æœ‰é™ç­‰å¾…ï¼ˆBounded Waitingï¼‰</strong>ï¼šè¯·æ±‚è¿›å…¥çš„è¿›ç¨‹ä¸èƒ½æ— é™ç­‰å¾…</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="id5">
<h2>2. é”æœºåˆ¶<a class="headerlink" href="#id5" title="Permalink to this heading">ïƒ</a></h2>
<section id="spinlock">
<h3>2.1 è‡ªæ—‹é”ï¼ˆSpinlockï¼‰<a class="headerlink" href="#spinlock" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå¿™ç­‰å¾…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="p">;</span><span class="w">  </span><span class="c1">// 0=æœªé”ï¼Œ1=å·²é”</span>
<span class="p">}</span><span class="w"> </span><span class="n">spinlock_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">spin_lock</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¿™ç­‰å¾…ï¼ˆspinï¼‰</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">spin_unlock</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>test_and_setåŸå­æŒ‡ä»¤</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç¡¬ä»¶æä¾›çš„åŸå­æ“ä½œ</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_and_set</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// x86æ±‡ç¼–å®ç°</span>
<span class="nl">lock</span><span class="p">:</span>
<span class="w">    </span><span class="n">movl</span><span class="w"> </span><span class="n">$1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="w">    </span><span class="n">xchgl</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">)</span><span class="w">  </span><span class="c1">// åŸå­äº¤æ¢</span>
<span class="w">    </span><span class="n">ret</span>
</pre></div>
</div>
<p><strong>compare_and_swapï¼ˆCASï¼‰</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">compare_and_swap</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">new_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ç”¨CASå®ç°è‡ªæ—‹é”</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">spin_lock_cas</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">compare_and_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¿™ç­‰å¾…</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ä¼˜ç¼ºç‚¹</strong>ï¼š</p>
<ul class="simple">
<li><p>âœ… ç®€å•ã€å¿«é€Ÿï¼ˆä¸´ç•ŒåŒºçŸ­æ—¶ï¼‰</p></li>
<li><p>âœ… æ— ä¸Šä¸‹æ–‡åˆ‡æ¢</p></li>
<li><p>âŒ CPUæ—¶é—´æµªè´¹ï¼ˆå¿™ç­‰å¾…ï¼‰</p></li>
<li><p>âŒ ä¼˜å…ˆçº§åè½¬é—®é¢˜</p></li>
</ul>
</section>
<section id="mutex">
<h3>2.2 äº’æ–¥é”ï¼ˆMutexï¼‰<a class="headerlink" href="#mutex" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šé˜»å¡ç­‰å¾…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">locked</span><span class="p">;</span>
<span class="w">    </span><span class="n">queue_t</span><span class="w"> </span><span class="n">wait_queue</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">mutex_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mutex_lock</span><span class="p">(</span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">        </span><span class="n">enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span><span class="w"> </span><span class="n">current_thread</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ä¼‘çœ ï¼ˆé‡Šæ”¾CPUï¼‰</span>
<span class="w">        </span><span class="n">park</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">mutex_unlock</span><span class="p">(</span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
<span class="w">    </span><span class="n">thread_t</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">unpark</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>POSIXäº’æ–¥é”</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>

<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">safe_increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">count</span><span class="o">++</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¸´ç•ŒåŒº</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="rwlock">
<h3>2.3 è¯»å†™é”ï¼ˆRWLockï¼‰<a class="headerlink" href="#rwlock" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šå¤šä¸ªè¯»è€…ï¼Œä¸€ä¸ªå†™è€…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">readers</span><span class="p">;</span><span class="w">     </span><span class="c1">// å½“å‰è¯»è€…æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">writer</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ˜¯å¦æœ‰å†™è€…</span>
<span class="w">    </span><span class="n">queue_t</span><span class="w"> </span><span class="n">read_queue</span><span class="p">;</span>
<span class="w">    </span><span class="n">queue_t</span><span class="w"> </span><span class="n">write_queue</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">rwlock_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">read_lock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">read_unlock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é€šçŸ¥ç­‰å¾…çš„å†™è€…</span>
<span class="w">        </span><span class="n">signal_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">write_lock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">write_unlock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ä¼˜å…ˆå”¤é†’å†™è€…è¿˜æ˜¯è¯»è€…ï¼Ÿ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">signal_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">signal_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">read_queue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šè¯»å¤šå†™å°‘</p>
</section>
</section>
<hr class="docutils" />
<section id="semaphore">
<h2>3. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰<a class="headerlink" href="#semaphore" title="Permalink to this heading">ïƒ</a></h2>
<section id="id6">
<h3>3.1 äºŒå…ƒä¿¡å·é‡<a class="headerlink" href="#id6" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>åŸç†</strong>ï¼šè®¡æ•°å™¨ï¼ˆ0æˆ–1ï¼‰</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="n">queue_t</span><span class="w"> </span><span class="n">wait_queue</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">semaphore_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sem_wait</span><span class="p">(</span><span class="n">semaphore_t</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Pæ“ä½œ</span>
<span class="w">    </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é˜»å¡</span>
<span class="w">        </span><span class="n">enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span><span class="w"> </span><span class="n">current_thread</span><span class="p">);</span>
<span class="w">        </span><span class="n">park</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">sem_post</span><span class="p">(</span><span class="n">semaphore_t</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Væ“ä½œ</span>
<span class="w">    </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
<span class="w">        </span><span class="n">thread_t</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="w">        </span><span class="n">unpark</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ç”¨ä½œäº’æ–¥é”</strong>ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">semaphore_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// åˆå§‹å€¼1</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">critical_section</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ä¸´ç•ŒåŒº</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>3.2 è®¡æ•°ä¿¡å·é‡<a class="headerlink" href="#id7" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>ç”¨é€”</strong>ï¼šé™åˆ¶èµ„æºè®¿é—®æ•°é‡</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// é™åˆ¶æœ€å¤šNä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">sem</span><span class="p">;</span>
<span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">access_resource</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ä½¿ç”¨èµ„æº</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>3.3 ç»å…¸é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…<a class="headerlink" href="#id8" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BUFFER_SIZE 10</span>

<span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="n">semaphore_t</span><span class="w"> </span><span class="n">empty</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç©ºæ§½ä½æ•°</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">full</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ»¡æ§½ä½æ•°</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">  </span><span class="c1">// äº’æ–¥è®¿é—®buffer</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">producer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">produce_item</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span><span class="w">   </span><span class="c1">// ç­‰å¾…ç©ºæ§½ä½</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">   </span><span class="c1">// è¿›å…¥ä¸´ç•ŒåŒº</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">   </span><span class="c1">// ç¦»å¼€ä¸´ç•ŒåŒº</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span><span class="w">    </span><span class="c1">// å¢åŠ æ»¡æ§½ä½</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">consumer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">full</span><span class="p">);</span><span class="w">    </span><span class="c1">// ç­‰å¾…æ»¡æ§½ä½</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">   </span><span class="c1">// è¿›å…¥ä¸´ç•ŒåŒº</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">];</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">   </span><span class="c1">// ç¦»å¼€ä¸´ç•ŒåŒº</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span><span class="w">   </span><span class="c1">// å¢åŠ ç©ºæ§½ä½</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>3.4 ç»å…¸é—®é¢˜ï¼šè¯»è€…-å†™è€…<a class="headerlink" href="#id9" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">readers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">      </span><span class="c1">// ä¿æŠ¤readersè®¡æ•°</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">write_lock</span><span class="p">;</span><span class="w"> </span><span class="c1">// å†™é”</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">reader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="n">readers</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç¬¬ä¸€ä¸ªè¯»è€…è·å–å†™é”</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// è¯»å–æ•°æ®</span>
<span class="w">        </span><span class="n">read_data</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="n">readers</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span><span class="w">  </span><span class="c1">// æœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾å†™é”</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">writer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// å†™å…¥æ•°æ®</span>
<span class="w">        </span><span class="n">write_data</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>é—®é¢˜</strong>ï¼šå†™è€…å¯èƒ½é¥¥é¥¿ï¼ˆè¯»è€…ä¸æ–­ï¼‰</p>
<p><strong>è§£å†³</strong>ï¼šå¼•å…¥å†™è€…ä¼˜å…ˆ</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">readers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">writers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">semaphore_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="n">r_mutex</span><span class="p">,</span><span class="w"> </span><span class="n">w_mutex</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">reader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">readers</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_mutex</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">read_data</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">readers</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">writer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">writers</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_mutex</span><span class="p">);</span><span class="w">  </span><span class="c1">// é˜»æ­¢æ–°è¯»è€…</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_mutex</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">write_data</span><span class="p">();</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_lock</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">writers</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">writers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="condition-variable">
<h2>4. æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰<a class="headerlink" href="#condition-variable" title="Permalink to this heading">ïƒ</a></h2>
<section id="id10">
<h3>4.1 åŸºæœ¬æ“ä½œ<a class="headerlink" href="#id10" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">queue_t</span><span class="w"> </span><span class="n">wait_queue</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">cond_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">cond_wait</span><span class="p">(</span><span class="n">cond_t</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">mutex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. é‡Šæ”¾é”</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 2. åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶ä¼‘çœ </span>
<span class="w">    </span><span class="n">enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span><span class="w"> </span><span class="n">current_thread</span><span class="p">);</span>
<span class="w">    </span><span class="n">park</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 3. è¢«å”¤é†’åé‡æ–°è·å–é”</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">cond_signal</span><span class="p">(</span><span class="n">cond_t</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
<span class="w">    </span><span class="n">thread_t</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="n">unpark</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">cond_broadcast</span><span class="p">(</span><span class="n">cond_t</span><span class="w"> </span><span class="o">*</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">thread_t</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="w">        </span><span class="n">unpark</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3>4.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆæ¡ä»¶å˜é‡ç‰ˆï¼‰<a class="headerlink" href="#id11" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="n">cond_t</span><span class="w"> </span><span class="n">not_full</span><span class="p">,</span><span class="w"> </span><span class="n">not_empty</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">producer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">produce_item</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_full</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…éæ»¡</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">        </span><span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">);</span><span class="w">  </span><span class="c1">// é€šçŸ¥éç©º</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">consumer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…éç©º</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="o">--</span><span class="n">count</span><span class="p">];</span>
<span class="w">        </span><span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_full</span><span class="p">);</span><span class="w">  </span><span class="c1">// é€šçŸ¥éæ»¡</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ä¸ºä»€ä¹ˆç”¨whileè€Œä¸æ˜¯ifï¼Ÿ</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// é”™è¯¯ï¼šç”¨if</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// å”¤é†’åä¸æ£€æŸ¥ï¼Œå¯èƒ½countä»ä¸º0ï¼ˆè™šå‡å”¤é†’ï¼‰</span>

<span class="c1">// æ­£ç¡®ï¼šç”¨while</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="monitor">
<h2>5. ç®¡ç¨‹ï¼ˆMonitorï¼‰<a class="headerlink" href="#monitor" title="Permalink to this heading">ïƒ</a></h2>
<p><strong>æ¦‚å¿µ</strong>ï¼šå°è£…å…±äº«æ•°æ®å’ŒåŒæ­¥æ“ä½œ</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">class</span><span class="w"> </span><span class="n">BoundedBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="w">    </span><span class="n">cond_t</span><span class="w"> </span><span class="n">not_full</span><span class="p">,</span><span class="w"> </span><span class="n">not_empty</span><span class="p">;</span>
<span class="w">    </span>
<span class="n">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">put</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_full</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">        </span><span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_empty</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="o">--</span><span class="n">count</span><span class="p">];</span>
<span class="w">        </span><span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">not_full</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p><strong>Java synchronized</strong>ï¼š</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">BoundedBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">SIZE</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wait</span><span class="p">();</span><span class="w">  </span><span class="c1">// ç­‰å¾…éæ»¡</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">buffer</span><span class="o">[</span><span class="n">count</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">        </span><span class="n">notifyAll</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wait</span><span class="p">();</span><span class="w">  </span><span class="c1">// ç­‰å¾…éç©º</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[--</span><span class="n">count</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">notifyAll</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="id12">
<h2>6. æ— é”ç¼–ç¨‹<a class="headerlink" href="#id12" title="Permalink to this heading">ïƒ</a></h2>
<section id="id13">
<h3>6.1 åŸå­æ“ä½œ<a class="headerlink" href="#id13" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdatomic.h&gt;</span>

<span class="kt">atomic_int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// åŸå­åŠ </span>
<span class="p">}</span>

<span class="c1">// CASå¾ªç¯</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cas_increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">);</span>
<span class="w">        </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">atomic_compare_exchange_weak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3>6.2 æ— é”æ ˆ<a class="headerlink" href="#id14" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">node</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">node_t</span><span class="p">;</span>

<span class="n">atomic_ptr</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">node_t</span><span class="w"> </span><span class="o">*</span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">node_t</span><span class="p">));</span>
<span class="w">    </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">node_t</span><span class="w"> </span><span class="o">*</span><span class="n">old_top</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">);</span>
<span class="w">        </span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">atomic_compare_exchange_weak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">new_node</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">pop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">node_t</span><span class="w"> </span><span class="o">*</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">new_top</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_top</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç©ºæ ˆ</span>
<span class="w">        </span><span class="n">new_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">atomic_compare_exchange_weak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">new_top</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_top</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">old_top</span><span class="p">);</span><span class="w">  </span><span class="c1">// ABAé—®é¢˜ï¼</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>ABAé—®é¢˜</strong>ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>çº¿ç¨‹1ï¼šè¯»å–top=A
çº¿ç¨‹2ï¼špop A, pop B, push A
çº¿ç¨‹1ï¼šCASæˆåŠŸï¼ˆtopè¿˜æ˜¯Aï¼Œä½†å·²ç»ä¸æ˜¯åŸæ¥çš„Aï¼ï¼‰
</pre></div>
</div>
<p><strong>è§£å†³</strong>ï¼šç‰ˆæœ¬å·</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">node_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">versioned_ptr</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="bug">
<h2>7. å¸¸è§å¹¶å‘bug<a class="headerlink" href="#bug" title="Permalink to this heading">ïƒ</a></h2>
<section id="id15">
<h3>7.1 æ­»é”<a class="headerlink" href="#id15" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mutex_t</span><span class="w"> </span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="p">;</span>

<span class="c1">// çº¿ç¨‹1</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…çº¿ç¨‹2é‡Šæ”¾lock2</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// çº¿ç¨‹2</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">thread2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç­‰å¾…çº¿ç¨‹1é‡Šæ”¾lock1</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>è§£å†³</strong>ï¼šé”æ’åº</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">acquire_both_locks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock2</span><span class="p">);</span>
<span class="w">        </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="livelock">
<h3>7.2 æ´»é”ï¼ˆLivelockï¼‰<a class="headerlink" href="#livelock" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨å°è¯•è®©å¯¹æ–¹å…ˆæ‰§è¡Œ</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">other_is_waiting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">yield</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ— é™å¾ªç¯</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3>7.3 ä¼˜å…ˆçº§åè½¬<a class="headerlink" href="#id16" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>H: é«˜ä¼˜å…ˆçº§ï¼ˆç­‰å¾…é”ï¼‰
M: ä¸­ä¼˜å…ˆçº§ï¼ˆè¿è¡Œï¼‰
L: ä½ä¼˜å…ˆçº§ï¼ˆæŒæœ‰é”ï¼‰

Hç­‰å¾…Lï¼Œä½†MæŠ¢å Lï¼Œå¯¼è‡´Hé—´æ¥ç­‰å¾…M
</pre></div>
</div>
<p><strong>è§£å†³</strong>ï¼šä¼˜å…ˆçº§ç»§æ‰¿</p>
</section>
</section>
<hr class="docutils" />
<section id="id17">
<h2>8. æ€§èƒ½ä¼˜åŒ–<a class="headerlink" href="#id17" title="Permalink to this heading">ïƒ</a></h2>
<section id="id18">
<h3>8.1 å‡å°‘é”ç«äº‰<a class="headerlink" href="#id18" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç²—ç²’åº¦é”ï¼ˆé«˜ç«äº‰ï¼‰</span>
<span class="n">mutex_t</span><span class="w"> </span><span class="n">global_lock</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">increment_all</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">counters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ç»†ç²’åº¦é”ï¼ˆä½ç«äº‰ï¼‰</span>
<span class="n">mutex_t</span><span class="w"> </span><span class="n">locks</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">increment_one</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">counters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id19">
<h3>8.2 æ— é”æ•°æ®ç»“æ„<a class="headerlink" href="#id19" title="Permalink to this heading">ïƒ</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// ç”¨åŸå­æ“ä½œä»£æ›¿é”</span>
<span class="kt">atomic_int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">fast_increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_fetch_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ— é”</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id20">
<h2>9. å¸¸è§é—®é¢˜<a class="headerlink" href="#id20" title="Permalink to this heading">ïƒ</a></h2>
<section id="q1-vs">
<h3>Q1: è‡ªæ—‹é” vs äº’æ–¥é”ï¼Ÿ<a class="headerlink" href="#q1-vs" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p><strong>è‡ªæ—‹é”</strong>ï¼šä¸´ç•ŒåŒºçŸ­ï¼ˆ&lt;å¾®ç§’ï¼‰ã€å¤šæ ¸ã€ä¸èƒ½ä¼‘çœ </p></li>
<li><p><strong>äº’æ–¥é”</strong>ï¼šä¸´ç•ŒåŒºé•¿ã€å•æ ¸ã€å¯ä»¥ä¼‘çœ </p></li>
</ul>
</section>
<section id="q2-vs">
<h3>Q2: ä¿¡å·é‡ vs æ¡ä»¶å˜é‡ï¼Ÿ<a class="headerlink" href="#q2-vs" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p><strong>ä¿¡å·é‡</strong>ï¼šè®¡æ•°ã€ä¸éœ€è¦é”ã€P/Væ“ä½œå¯åˆ†ç¦»</p></li>
<li><p><strong>æ¡ä»¶å˜é‡</strong>ï¼šå¿…é¡»ä¸é”é…åˆã€ç­‰å¾…ç‰¹å®šæ¡ä»¶</p></li>
</ul>
</section>
<section id="q3">
<h3>Q3: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ<a class="headerlink" href="#q3" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ol class="arabic simple">
<li><p>é”æ’åº</p></li>
<li><p>è¶…æ—¶æœºåˆ¶</p></li>
<li><p>å°è¯•é”ï¼ˆtrylockï¼‰</p></li>
<li><p>é¿å…åµŒå¥—é”</p></li>
</ol>
</section>
<section id="q4-volatile-vs-atomic">
<h3>Q4: volatile vs atomicï¼Ÿ<a class="headerlink" href="#q4-volatile-vs-atomic" title="Permalink to this heading">ïƒ</a></h3>
<p><strong>A</strong>:</p>
<ul class="simple">
<li><p><strong>volatile</strong>ï¼šé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¸ä¿è¯åŸå­æ€§</p></li>
<li><p><strong>atomic</strong>ï¼šä¿è¯åŸå­æ€§å’Œå¯è§æ€§</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="leetcode">
<h2>LeetCodeç›¸å…³é¢˜ç›®<a class="headerlink" href="#leetcode" title="Permalink to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://leetcode.cn/problems/print-in-order/">1114. æŒ‰åºæ‰“å°</a></p></li>
<li><p><a class="reference external" href="https://leetcode.cn/problems/print-foobar-alternately/">1115. äº¤æ›¿æ‰“å°FooBar</a></p></li>
<li><p><a class="reference external" href="https://leetcode.cn/problems/print-zero-even-odd/">1116. æ‰“å°é›¶ä¸å¥‡å¶æ•°</a></p></li>
<li><p><a class="reference external" href="https://leetcode.cn/problems/building-h2o/">1117. H2Oç”Ÿæˆ</a></p></li>
<li><p><a class="reference external" href="https://leetcode.cn/problems/fizz-buzz-multithreaded/">1195. äº¤æ›¿æ‰“å°å­—ç¬¦ä¸²</a></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="id21">
<h2>å‚è€ƒèµ„æº<a class="headerlink" href="#id21" title="Permalink to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>ã€ŠOperating Systems: Three Easy Piecesã€‹- Concurrencyç« èŠ‚</p></li>
<li><p>ã€ŠThe Art of Multiprocessor Programmingã€‹</p></li>
<li><p>Linuxæºç ï¼š<code class="docutils literal notranslate"><span class="pre">kernel/locking/</span></code></p></li>
<li><p>POSIXçº¿ç¨‹ç¼–ç¨‹æŒ‡å—</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="å¹¶å‘ä¸åŒæ­¥" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../06-deadlock/index.html" class="btn btn-neutral float-right" title="æ­»é”å¤„ç†" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Code Dojo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>