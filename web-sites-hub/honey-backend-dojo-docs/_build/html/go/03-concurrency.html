

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>03-Go并发编程 &mdash; Backend Tutorial 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2d0851c8" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/copy-code.js?v=caf91246"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="04-Go Web开发" href="04-web-development.html" />
    <link rel="prev" title="02-Go基础语法" href="02-basic-syntax.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            Backend Tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Backend Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpp/index.html">C++ 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">Python 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../java/index.html">Java 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nodejs/index.html">Node.js 教程</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Golang 教程</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="README.html">Golang 开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="01-environment-setup.html">01-Go环境搭建</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-basic-syntax.html">02-Go基础语法</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">03-Go并发编程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#goroutine">goroutine深入</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">特性对比</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goroutine-gmp">goroutine调度模型（GMP）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">创建和控制</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#channel">channel详解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">无缓冲channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">缓冲channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">单向channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#select">select多路复用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sync">sync包</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mutex">Mutex（互斥锁）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rwmutex">RWMutex（读写锁）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#once">Once（单次执行）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pool">Pool（对象池）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#map-map">Map（并发安全map）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cond">Cond（条件变量）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#context">context包</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">context使用模式</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">并发模式</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#worker-pool">Worker Pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fan-out-fan-in">Fan-out/Fan-in</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pipeline">Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">超时和取消</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id9">原子操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">并发安全数据结构</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#map">线程安全Map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#slice">线程安全Slice</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">常见并发问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id12">竞态条件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">死锁</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">goroutine泄漏</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">并发工具</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#errgroup">errgroup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#singleflight">singleflight</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rate-limiting">限流（rate limiting）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id16">性能优化</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">减少锁竞争</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channel-vs-mutex">channel vs mutex</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id18">并发测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id19">竞态检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">压力测试</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id21">最佳实践</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="04-web-development.html">04-Go Web开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-microservices.html">05-Go微服务实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-performance.html">06-Go性能优化</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust 教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/index.html">Shell 教程</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Backend Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Golang 教程</a></li>
      <li class="breadcrumb-item active">03-Go并发编程</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/go/03-concurrency.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="go">
<h1>03-Go并发编程<a class="headerlink" href="#go" title="Permalink to this heading"></a></h1>
<p>并发是Go的杀手级特性。goroutine极轻量，channel类型安全，select优雅多路复用。</p>
<section id="goroutine">
<h2>goroutine深入<a class="headerlink" href="#goroutine" title="Permalink to this heading"></a></h2>
<section id="id1">
<h3>特性对比<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>线程（Thread）</p></th>
<th class="head"><p>goroutine</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>栈大小</p></td>
<td><p>1-2MB</p></td>
<td><p>2KB起步，动态扩展</p></td>
</tr>
<tr class="row-odd"><td><p>创建开销</p></td>
<td><p>~1-2ms</p></td>
<td><p>~1μs</p></td>
</tr>
<tr class="row-even"><td><p>调度</p></td>
<td><p>OS内核调度</p></td>
<td><p>Go运行时调度（M:N）</p></td>
</tr>
<tr class="row-odd"><td><p>切换成本</p></td>
<td><p>高（内核态切换）</p></td>
<td><p>低（用户态）</p></td>
</tr>
<tr class="row-even"><td><p>数量上限</p></td>
<td><p>几千</p></td>
<td><p>百万级</p></td>
</tr>
</tbody>
</table>
</section>
<section id="goroutine-gmp">
<h3>goroutine调度模型（GMP）<a class="headerlink" href="#goroutine-gmp" title="Permalink to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>G：goroutine
M：系统线程（Machine）
P：处理器（Processor），逻辑CPU

调度模型：M:N
- 多个goroutine（G）映射到少量线程（M）
- P控制G在M上执行
- 默认P数量=CPU核心数
</pre></div>
</div>
</section>
<section id="id2">
<h3>创建和控制<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 创建</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;goroutine&quot;</span><span class="p">)</span>
<span class="p">}()</span>

<span class="c1">// 等待（WaitGroup）</span>
<span class="kn">import</span><span class="w"> </span><span class="s">&quot;sync&quot;</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">        </span><span class="nx">process</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
<span class="w">    </span><span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>

<span class="c1">// 限制并发数（worker pool）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="nx">Pool</span><span class="p">(</span><span class="nx">tasks</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="nx">Task</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">Result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="channel">
<h2>channel详解<a class="headerlink" href="#channel" title="Permalink to this heading"></a></h2>
<section id="id3">
<h3>无缓冲channel<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<p>发送阻塞直到接收，接收阻塞直到发送。同步通信。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>

<span class="c1">// 发送（阻塞）</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">42</span>
<span class="p">}()</span>

<span class="c1">// 接收（阻塞）</span>
<span class="nx">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span>

<span class="c1">// 应用：同步点</span>
<span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">work</span><span class="p">()</span>
<span class="w">    </span><span class="nx">done</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}{}</span><span class="w">  </span><span class="c1">// 信号</span>
<span class="p">}()</span>
<span class="o">&lt;-</span><span class="nx">done</span><span class="w">  </span><span class="c1">// 等待完成</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3>缓冲channel<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<p>缓冲满才阻塞发送，缓冲空才阻塞接收。异步通信。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>

<span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1">// 不阻塞</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">2</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">3</span>
<span class="c1">// ch &lt;- 4  // 阻塞（缓冲满）</span>

<span class="o">&lt;-</span><span class="nx">ch</span><span class="w">     </span><span class="c1">// 1</span>
<span class="o">&lt;-</span><span class="nx">ch</span><span class="w">     </span><span class="c1">// 2</span>
<span class="c1">// 现在可以再发送2个</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>单向channel<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>限制channel操作方向，增强类型安全。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 只发送channel</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">send</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">42</span>
<span class="w">    </span><span class="c1">// &lt;-ch  // 编译错误</span>
<span class="p">}</span>

<span class="c1">// 只接收channel</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">receive</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span>
<span class="w">    </span><span class="c1">// ch &lt;- 42  // 编译错误</span>
<span class="p">}</span>

<span class="c1">// 函数参数自动转换</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="k">go</span><span class="w"> </span><span class="nx">send</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span><span class="w">     </span><span class="c1">// chan int → chan&lt;- int</span>
<span class="nx">receive</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span><span class="w">     </span><span class="c1">// chan int → &lt;-chan int</span>
</pre></div>
</div>
</section>
<section id="select">
<h3>select多路复用<a class="headerlink" href="#select" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch1</span><span class="p">:</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ch1:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch2</span><span class="p">:</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ch2:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="nx">ch3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">value</span><span class="p">:</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;sent to ch3&quot;</span><span class="p">)</span>
<span class="k">default</span><span class="p">:</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;no ready channel&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 超时模式</span>
<span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 取消模式</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
<span class="w">    </span><span class="c1">// 正常处理</span>
<span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cancelled&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// for-select循环</span>
<span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
<span class="w">        </span><span class="nx">process</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">quit</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="sync">
<h2>sync包<a class="headerlink" href="#sync" title="Permalink to this heading"></a></h2>
<section id="mutex">
<h3>Mutex（互斥锁）<a class="headerlink" href="#mutex" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;sync&quot;</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">SafeCounter</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeCounter</span><span class="p">)</span><span class="w"> </span><span class="nx">Inc</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeCounter</span><span class="p">)</span><span class="w"> </span><span class="nx">Value</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="rwmutex">
<h3>RWMutex（读写锁）<a class="headerlink" href="#rwmutex" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Cache</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">   </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">Cache</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span><span class="w">         </span><span class="c1">// 读锁（多个goroutine可同时读）</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">Cache</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span><span class="w">          </span><span class="c1">// 写锁（独占）</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">value</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="once">
<h3>Once（单次执行）<a class="headerlink" href="#once" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">once</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">instance</span><span class="w"> </span><span class="o">*</span><span class="nx">Singleton</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">GetInstance</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">Singleton</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">once</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">instance</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Singleton</span><span class="p">{}</span><span class="w">  </span><span class="c1">// 仅执行一次</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">instance</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="pool">
<h3>Pool（对象池）<a class="headerlink" href="#pool" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">bufferPool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span><span class="p">{</span>
<span class="w">    </span><span class="nx">New</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span><span class="w">  </span><span class="c1">// 创建新对象</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">buf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufferPool</span><span class="p">.</span><span class="nx">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span><span class="w">  </span><span class="c1">// 获取</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">bufferPool</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span><span class="w">                </span><span class="c1">// 归还</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">buf</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span><span class="w">  </span><span class="c1">// 重置</span>
<span class="w">    </span><span class="nx">buf</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 使用buf</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="map-map">
<h3>Map（并发安全map）<a class="headerlink" href="#map-map" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>

<span class="c1">// 操作</span>
<span class="nx">m</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">)</span><span class="w">          </span><span class="c1">// 存储</span>
<span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span><span class="w">       </span><span class="c1">// 读取</span>
<span class="nx">m</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span><span class="w">                  </span><span class="c1">// 删除</span>
<span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">loaded</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">LoadOrStore</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 读取或存储</span>
<span class="nx">m</span><span class="p">.</span><span class="nx">Range</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c1">// 继续遍历</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="cond">
<h3>Cond（条件变量）<a class="headerlink" href="#cond" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">cond</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">NewCond</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mu</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ready</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">)</span>

<span class="c1">// 等待</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cond</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">!</span><span class="nx">ready</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 循环检查（防止虚假唤醒）</span>
<span class="w">        </span><span class="nx">cond</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">cond</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// 开始工作</span>
<span class="p">}()</span>

<span class="c1">// 通知</span>
<span class="nx">cond</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="nx">ready</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="nx">cond</span><span class="p">.</span><span class="nx">Signal</span><span class="p">()</span><span class="w">     </span><span class="c1">// 唤醒一个</span>
<span class="c1">// cond.Broadcast()  // 唤醒所有</span>
<span class="nx">cond</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="context">
<h2>context包<a class="headerlink" href="#context" title="Permalink to this heading"></a></h2>
<p>传递截止时间、取消信号、请求作用域值。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;context&quot;</span>

<span class="c1">// 创建context</span>
<span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span><span class="w">           </span><span class="c1">// 根context</span>
<span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">()</span><span class="w">                 </span><span class="c1">// 临时context</span>

<span class="c1">// WithCancel：取消信号</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cancelled&quot;</span><span class="p">)</span>
<span class="p">}()</span>

<span class="nx">cancel</span><span class="p">()</span><span class="w">  </span><span class="c1">// 取消</span>

<span class="c1">// WithTimeout：超时</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;work done&quot;</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;timeout:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">())</span>
<span class="p">}</span>

<span class="c1">// WithDeadline：截止时间</span>
<span class="nx">deadline</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithDeadline</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">deadline</span><span class="p">)</span>

<span class="c1">// WithValue：传递值（少用，仅请求作用域数据）</span>
<span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;userID&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">)</span>
<span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">).(</span><span class="kt">int</span><span class="p">)</span>
</pre></div>
</div>
<section id="id6">
<h3>context使用模式<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// HTTP服务器</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">handler</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Context</span><span class="p">()</span><span class="w">  </span><span class="c1">// 请求的context</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 调用其他服务</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">callService</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 处理错误</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">callService</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">Data</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Result</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">doWork</span><span class="p">(</span><span class="nx">data</span><span class="p">):</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">Result</span><span class="p">{},</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w">  </span><span class="c1">// 请求取消或超时</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2>并发模式<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h2>
<section id="worker-pool">
<h3>Worker Pool<a class="headerlink" href="#worker-pool" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">workerPool</span><span class="p">(</span><span class="nx">jobs</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">jobs</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">jobs</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="kd">chan</span><span class="o">&lt;-</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">jobs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Worker %d processing job %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">)</span>
<span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">        </span><span class="nx">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用</span>
<span class="nx">jobs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>

<span class="k">go</span><span class="w"> </span><span class="nx">workerPool</span><span class="p">(</span><span class="nx">jobs</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span>

<span class="c1">// 发送任务</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">jobs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">i</span>
<span class="p">}</span>
<span class="nb">close</span><span class="p">(</span><span class="nx">jobs</span><span class="p">)</span>

<span class="c1">// 接收结果</span>
<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">&lt;-</span><span class="nx">results</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="fan-out-fan-in">
<h3>Fan-out/Fan-in<a class="headerlink" href="#fan-out-fan-in" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Fan-out：分发任务到多个goroutine</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">fanOut</span><span class="p">(</span><span class="nx">input</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWorkers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="nx">channels</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numWorkers</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">channels</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">channels</span>
<span class="p">}</span>

<span class="c1">// Fan-in：合并多个channel</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">fanIn</span><span class="p">(</span><span class="nx">channels</span><span class="w"> </span><span class="o">...&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">out</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">channels</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">val</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">ch</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">out</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="pipeline">
<h3>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 生成器</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">gen</span><span class="p">(</span><span class="nx">nums</span><span class="w"> </span><span class="o">...</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">out</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">nums</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">n</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">out</span>
<span class="p">}</span>

<span class="c1">// 平方</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">square</span><span class="p">(</span><span class="nx">in</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">out</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">n</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">out</span>
<span class="p">}</span>

<span class="c1">// 组合pipeline</span>
<span class="nx">nums</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="nx">squared</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">square</span><span class="p">(</span><span class="nx">nums</span><span class="p">)</span>

<span class="k">for</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">squared</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span><span class="w">  </span><span class="c1">// 1, 4, 9, 16, 25</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>超时和取消<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// 超时模式</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">doWithTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">work</span><span class="p">()</span>
<span class="w">        </span><span class="nx">done</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}{}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="nx">timeout</span><span class="p">):</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 取消模式</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">doWithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// 执行工作</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2>原子操作<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h2>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;sync/atomic&quot;</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="kt">int64</span>

<span class="c1">// 原子操作</span>
<span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">       </span><span class="c1">// 原子加</span>
<span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">)</span><span class="w">         </span><span class="c1">// 原子读</span>
<span class="nx">atomic</span><span class="p">.</span><span class="nx">StoreInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">   </span><span class="c1">// 原子写</span>
<span class="nx">atomic</span><span class="p">.</span><span class="nx">SwapInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w">    </span><span class="c1">// 原子交换</span>
<span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span><span class="w">  </span><span class="c1">// CAS</span>

<span class="c1">// Value（原子值）</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span>

<span class="c1">// 存储</span>
<span class="nx">config</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">})</span>

<span class="c1">// 读取</span>
<span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">().(</span><span class="nx">Config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id10">
<h2>并发安全数据结构<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h2>
<section id="map">
<h3>线程安全Map<a class="headerlink" href="#map" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SafeMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewSafeMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SafeMap</span><span class="p">{</span>
<span class="w">        </span><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">value</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span>
<span class="p">}</span>

<span class="c1">// 或使用sync.Map（高并发读多写少）</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="nx">m</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">)</span>
<span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="slice">
<h3>线程安全Slice<a class="headerlink" href="#slice" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">SafeSlice</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">   </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeSlice</span><span class="p">)</span><span class="w"> </span><span class="nx">Append</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeSlice</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id11">
<h2>常见并发问题<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h2>
<section id="id12">
<h3>竞态条件<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ❌ 竞态条件</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">count</span><span class="o">++</span><span class="w">  </span><span class="c1">// 非原子：读-改-写</span>
<span class="p">}</span>

<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">increment</span><span class="p">()</span>
<span class="p">}</span>
<span class="c1">// count结果不确定（&lt;1000）</span>

<span class="c1">// ✅ 使用互斥锁</span>
<span class="kd">var</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">count</span><span class="o">++</span>
<span class="w">    </span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// ✅ 使用原子操作</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="kt">int64</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ✅ 使用channel</span>
<span class="nx">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">count</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}()</span>

<span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3>死锁<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ❌ 死锁：互相等待</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">42</span><span class="w">  </span><span class="c1">// 阻塞（无接收者）</span>
<span class="o">&lt;-</span><span class="nx">ch</span>

<span class="c1">// ✅ 使用goroutine</span>
<span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">42</span>
<span class="p">}()</span>
<span class="o">&lt;-</span><span class="nx">ch</span>

<span class="c1">// ❌ 所有goroutine都sleep</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span><span class="w">  </span><span class="c1">// 等待自己（死锁）</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3>goroutine泄漏<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ❌ 泄漏：channel永远不关闭</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">leak</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 永远阻塞</span>
<span class="w">            </span><span class="nx">process</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span><span class="c1">// ch从未关闭，goroutine永远不退出</span>
<span class="p">}</span>

<span class="c1">// ✅ 使用done channel</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">noLeak</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span><span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
<span class="w">                </span><span class="nx">process</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w">  </span><span class="c1">// 退出goroutine</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 清理</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ✅ 使用context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">noLeak2</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
<span class="w">                </span><span class="nx">process</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id15">
<h2>并发工具<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h2>
<section id="errgroup">
<h3>errgroup<a class="headerlink" href="#errgroup" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;golang.org/x/sync/errgroup&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="nx">Files</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">errgroup</span><span class="p">.</span><span class="nx">WithContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">file</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">file</span><span class="w">  </span><span class="c1">// 捕获循环变量</span>
<span class="w">        </span><span class="nx">g</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">processFile</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 等待所有goroutine，返回第一个错误</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="singleflight">
<h3>singleflight<a class="headerlink" href="#singleflight" title="Permalink to this heading"></a></h3>
<p>防止缓存击穿，同时只执行一次。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;golang.org/x/sync/singleflight&quot;</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">g</span><span class="w"> </span><span class="nx">singleflight</span><span class="p">.</span><span class="nx">Group</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">getValue</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 耗时操作（如数据库查询）</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fetchFromDB</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">.(</span><span class="kt">string</span><span class="p">),</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// 多个goroutine同时调用getValue(&quot;同一key&quot;)</span>
<span class="c1">// 只有第一个真正执行，其他等待并共享结果</span>
</pre></div>
</div>
</section>
<section id="rate-limiting">
<h3>限流（rate limiting）<a class="headerlink" href="#rate-limiting" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="s">&quot;golang.org/x/time/rate&quot;</span>

<span class="c1">// 令牌桶算法</span>
<span class="nx">limiter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rate</span><span class="p">.</span><span class="nx">NewLimiter</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">  </span><span class="c1">// 每秒10个，桶容量100</span>

<span class="c1">// 等待许可</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">limiter</span><span class="p">.</span><span class="nx">Wait</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// 尝试获取（非阻塞）</span>
<span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">limiter</span><span class="p">.</span><span class="nx">Allow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;rate limit exceeded&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h2>性能优化<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h2>
<section id="id17">
<h3>减少锁竞争<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ❌ 粗粒度锁</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Counter</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">Counter</span><span class="p">)</span><span class="w"> </span><span class="nx">Inc</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">++</span>
<span class="p">}</span>

<span class="c1">// ✅ 细粒度锁（分段锁）</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ShardedCounter</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">shards</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mu</span><span class="w">    </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">        </span><span class="nx">count</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">ShardedCounter</span><span class="p">)</span><span class="w"> </span><span class="nx">Inc</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">shard</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">shards</span><span class="p">[</span><span class="nx">hash</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="o">%</span><span class="mi">16</span><span class="p">]</span>
<span class="w">    </span><span class="nx">shard</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">shard</span><span class="p">.</span><span class="nx">count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">++</span>
<span class="w">    </span><span class="nx">shard</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="channel-vs-mutex">
<h3>channel vs mutex<a class="headerlink" href="#channel-vs-mutex" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// channel：通信和同步</span>
<span class="c1">// mutex：保护共享数据</span>

<span class="c1">// CPU密集型：mutex（开销小）</span>
<span class="c1">// IO密集型：channel（清晰）</span>

<span class="c1">// 简单计数：atomic</span>
<span class="c1">// 复杂状态：mutex</span>
<span class="c1">// 消息传递：channel</span>
</pre></div>
</div>
</section>
</section>
<section id="id18">
<h2>并发测试<a class="headerlink" href="#id18" title="Permalink to this heading"></a></h2>
<section id="id19">
<h3>竞态检测<a class="headerlink" href="#id19" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 编译时启用竞态检测器</span>
go<span class="w"> </span>build<span class="w"> </span>-race

<span class="c1"># 测试时检测</span>
go<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-race

<span class="c1"># 运行时检测</span>
go<span class="w"> </span>run<span class="w"> </span>-race<span class="w"> </span>main.go
</pre></div>
</div>
</section>
<section id="id20">
<h3>压力测试<a class="headerlink" href="#id20" title="Permalink to this heading"></a></h3>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">TestConcurrent</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numGoroutines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numIterations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numGoroutines</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numIterations</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">operation</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id21">
<h2>最佳实践<a class="headerlink" href="#id21" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>channel传递所有权</strong>：发送后不再访问</p></li>
<li><p><strong>关闭channel的发送方关闭</strong>：接收方不关闭</p></li>
<li><p><strong>用select避免阻塞</strong>：加default或timeout</p></li>
<li><p><strong>context传递取消信号</strong>：优于done channel</p></li>
<li><p><strong>defer解锁</strong>：确保锁释放</p></li>
<li><p><strong>读多写少用RWMutex</strong>：提升性能</p></li>
<li><p><strong>原子操作简单计数</strong>：比mutex轻量</p></li>
<li><p><strong>避免goroutine泄漏</strong>：确保退出路径</p></li>
<li><p><strong>竞态检测常开</strong>：测试和开发环境</p></li>
<li><p><strong>小心闭包捕获变量</strong>：循环中传参</p></li>
</ol>
<p><strong>核心：</strong> Don’t communicate by sharing memory; share memory by communicating.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02-basic-syntax.html" class="btn btn-neutral float-left" title="02-Go基础语法" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="04-web-development.html" class="btn btn-neutral float-right" title="04-Go Web开发" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Code Dojo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>