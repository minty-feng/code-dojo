# 03-æ€§èƒ½ä¼˜åŒ–

## ğŸ“‹ å­¦ä¹ ç›®æ ‡
- æŒæ¡æ€§èƒ½åˆ†ææ–¹æ³•
- å­¦ä¹ ä»£ç å±‚é¢ä¼˜åŒ–
- ç†è§£èµ„æºåŠ è½½ä¼˜åŒ–
- æŒæ¡è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### Core Web Vitals
```javascript
// LCP (Largest Contentful Paint) - æœ€å¤§å†…å®¹ç»˜åˆ¶
// ç›®æ ‡ï¼š< 2.5s

// FID (First Input Delay) - é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ
// ç›®æ ‡ï¼š< 100ms

// CLS (Cumulative Layout Shift) - ç´¯è®¡å¸ƒå±€åç§»
// ç›®æ ‡ï¼š< 0.1

// æµ‹é‡æ€§èƒ½
const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        console.log('LCP:', entry.renderTime || entry.loadTime);
    }
});
observer.observe({entryTypes: ['largest-contentful-paint']});
```

### æ€§èƒ½API
```javascript
// Navigation Timing
const perfData = performance.getEntriesByType('navigation')[0];
console.log('DOMåŠ è½½æ—¶é—´:', perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart);
console.log('é¡µé¢åŠ è½½æ—¶é—´:', perfData.loadEventEnd - perfData.loadEventStart);

// Resource Timing
const resources = performance.getEntriesByType('resource');
resources.forEach(resource => {
    console.log(`${resource.name}: ${resource.duration}ms`);
});

// è‡ªå®šä¹‰æ ‡è®°
performance.mark('start');
// æ‰§è¡Œä»£ç 
performance.mark('end');
performance.measure('operation', 'start', 'end');
```

## ğŸ¨ ä»£ç ä¼˜åŒ–

### JavaScriptä¼˜åŒ–
```javascript
// âŒ é¿å…ï¼šé¢‘ç¹æ“ä½œDOM
for (let i = 0; i < 1000; i++) {
    document.body.innerHTML += `<div>${i}</div>`;
}

// âœ… æ¨èï¼šæ‰¹é‡æ“ä½œ
const fragment = document.createDocumentFragment();
for (let i = 0; i < 1000; i++) {
    const div = document.createElement('div');
    div.textContent = i;
    fragment.appendChild(div);
}
document.body.appendChild(fragment);

// âŒ é¿å…ï¼šåœ¨å¾ªç¯ä¸­æŸ¥è¯¢DOM
for (let i = 0; i < items.length; i++) {
    document.getElementById('container').appendChild(items[i]);
}

// âœ… æ¨èï¼šç¼“å­˜DOMå¼•ç”¨
const container = document.getElementById('container');
for (let i = 0; i < items.length; i++) {
    container.appendChild(items[i]);
}

// âŒ é¿å…ï¼šå¼ºåˆ¶åŒæ­¥å¸ƒå±€
const width = element.offsetWidth;
element.style.width = width + 10 + 'px';
const height = element.offsetHeight; // è§¦å‘å›æµ

// âœ… æ¨èï¼šæ‰¹é‡è¯»å†™
const width = element.offsetWidth;
const height = element.offsetHeight;
element.style.width = width + 10 + 'px';
```

### é˜²æŠ–å’ŒèŠ‚æµ
```javascript
// é˜²æŠ–ï¼ˆDebounceï¼‰
function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => {
            fn.apply(this, args);
        }, delay);
    };
}

// ä½¿ç”¨
const handleSearch = debounce((query) => {
    console.log('Searching:', query);
}, 500);

input.addEventListener('input', (e) => {
    handleSearch(e.target.value);
});

// èŠ‚æµï¼ˆThrottleï¼‰
function throttle(fn, delay) {
    let lastCall = 0;
    return function(...args) {
        const now = Date.now();
        if (now - lastCall >= delay) {
            lastCall = now;
            fn.apply(this, args);
        }
    };
}

// ä½¿ç”¨
const handleScroll = throttle(() => {
    console.log('Scrolled');
}, 200);

window.addEventListener('scroll', handleScroll);
```

### è™šæ‹Ÿæ»šåŠ¨
```jsx
import {FixedSizeList} from 'react-window';

function VirtualList({items}) {
    const Row = ({index, style}) => (
        <div style={style}>
            {items[index].name}
        </div>
    );
    
    return (
        <FixedSizeList
            height={600}
            itemCount={items.length}
            itemSize={35}
            width="100%"
        >
            {Row}
        </FixedSizeList>
    );
}
```

## âš›ï¸ Reactæ€§èƒ½ä¼˜åŒ–

### memoå’ŒuseMemo
```jsx
// React.memoï¼šé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
const ExpensiveComponent = React.memo(({data}) => {
    console.log('Rendering ExpensiveComponent');
    return <div>{data}</div>;
});

// useMemoï¼šç¼“å­˜è®¡ç®—ç»“æœ
function Component({items}) {
    const expensiveValue = useMemo(() => {
        return items.reduce((sum, item) => sum + item.value, 0);
    }, [items]);
    
    return <div>{expensiveValue}</div>;
}

// useCallbackï¼šç¼“å­˜å‡½æ•°
function Parent() {
    const [count, setCount] = useState(0);
    
    const handleClick = useCallback(() => {
        console.log('Clicked');
    }, []);
    
    return <Child onClick={handleClick} />;
}

const Child = React.memo(({onClick}) => {
    console.log('Child rendered');
    return <button onClick={onClick}>Click</button>;
});
```

### ä»£ç åˆ†å‰²
```jsx
// è·¯ç”±çº§åˆ«åˆ†å‰²
const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));

function App() {
    return (
        <Suspense fallback={<Loading />}>
            <Routes>
                <Route path="/" element={<Home />} />
                <Route path="/about" element={<About />} />
            </Routes>
        </Suspense>
    );
}

// ç»„ä»¶çº§åˆ«åˆ†å‰²
const HeavyComponent = lazy(() => import('./HeavyComponent'));

function Page() {
    const [show, setShow] = useState(false);
    
    return (
        <div>
            <button onClick={() => setShow(true)}>Show</button>
            {show && (
                <Suspense fallback={<div>Loading...</div>}>
                    <HeavyComponent />
                </Suspense>
            )}
        </div>
    );
}
```

### åˆ—è¡¨ä¼˜åŒ–
```jsx
// âŒ é¿å…ï¼šä½¿ç”¨indexä½œä¸ºkey
{items.map((item, index) => (
    <Item key={index} data={item} />
))}

// âœ… æ¨èï¼šä½¿ç”¨å”¯ä¸€ID
{items.map(item => (
    <Item key={item.id} data={item} />
))}

// è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
import {Virtuoso} from 'react-virtuoso';

function LongList({items}) {
    return (
        <Virtuoso
            style={{height: '600px'}}
            data={items}
            itemContent={(index, item) => (
                <div>{item.name}</div>
            )}
        />
    );
}
```

## ğŸ’š Vueæ€§èƒ½ä¼˜åŒ–

### v-memoå’Œv-once
```vue
<template>
    <!-- v-onceï¼šåªæ¸²æŸ“ä¸€æ¬¡ -->
    <div v-once>
        {{ staticContent }}
    </div>
    
    <!-- v-memoï¼šæ¡ä»¶æ€§è·³è¿‡æ›´æ–° -->
    <div v-memo="[user.id, user.name]">
        {{ user.name }} - {{ user.email }}
    </div>
</template>
```

### è®¡ç®—å±æ€§ç¼“å­˜
```vue
<script setup>
import {ref, computed} from 'vue';

const items = ref([...]);

// âœ… ä½¿ç”¨computedï¼ˆæœ‰ç¼“å­˜ï¼‰
const filteredItems = computed(() => {
    console.log('Computing...');
    return items.value.filter(item => item.active);
});

// âŒ é¿å…ï¼šä½¿ç”¨methodï¼ˆæ— ç¼“å­˜ï¼‰
function getFilteredItems() {
    console.log('Computing...');
    return items.value.filter(item => item.active);
}
</script>
```

### å¼‚æ­¥ç»„ä»¶
```vue
<script setup>
import {defineAsyncComponent} from 'vue';

const AsyncComponent = defineAsyncComponent({
    loader: () => import('./HeavyComponent.vue'),
    loadingComponent: LoadingComponent,
    delay: 200,
    timeout: 3000
});
</script>

<template>
    <Suspense>
        <AsyncComponent />
        <template #fallback>
            <Loading />
        </template>
    </Suspense>
</template>
```

## ğŸ“¦ èµ„æºä¼˜åŒ–

### å›¾ç‰‡ä¼˜åŒ–
```html
<!-- å“åº”å¼å›¾ç‰‡ -->
<picture>
    <source srcset="image.webp" type="image/webp">
    <source srcset="image.jpg" type="image/jpeg">
    <img src="image.jpg" alt="Description">
</picture>

<!-- æ‡’åŠ è½½ -->
<img src="image.jpg" loading="lazy" alt="Description">

<!-- srcsetå’Œsizes -->
<img
    srcset="small.jpg 480w, medium.jpg 800w, large.jpg 1200w"
    sizes="(max-width: 600px) 480px, (max-width: 900px) 800px, 1200px"
    src="medium.jpg"
    alt="Responsive image"
>
```

### å­—ä½“ä¼˜åŒ–
```css
/* å­—ä½“é¢„åŠ è½½ */
<link rel="preload" href="font.woff2" as="font" type="font/woff2" crossorigin>

/* font-display */
@font-face {
    font-family: 'CustomFont';
    src: url('font.woff2') format('woff2');
    font-display: swap; /* swap, fallback, optional */
}

/* å­é›†åŒ– */
@font-face {
    font-family: 'CustomFont';
    src: url('font-subset.woff2') format('woff2');
    unicode-range: U+0000-00FF; /* æ‹‰ä¸å­—ç¬¦ */
}
```

### CSSä¼˜åŒ–
```css
/* é¿å…æ˜‚è´µçš„é€‰æ‹©å™¨ */
/* âŒ é¿å… */
* {...}
div div div div {...}
[type="text"] {...}

/* âœ… æ¨è */
.specific-class {...}

/* ä½¿ç”¨contain */
.component {
    contain: layout style paint;
}

/* ä½¿ç”¨will-changeï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ */
.element {
    will-change: transform;
}

.element:hover {
    transform: scale(1.1);
}
```

## ğŸŒ ç½‘ç»œä¼˜åŒ–

### èµ„æºé¢„åŠ è½½
```html
<!-- DNSé¢„è§£æ -->
<link rel="dns-prefetch" href="https://api.example.com">

<!-- é¢„è¿æ¥ -->
<link rel="preconnect" href="https://fonts.googleapis.com">

<!-- é¢„åŠ è½½å…³é”®èµ„æº -->
<link rel="preload" href="critical.css" as="style">
<link rel="preload" href="critical.js" as="script">

<!-- é¢„è·å–ä¸‹ä¸€é¡µèµ„æº -->
<link rel="prefetch" href="next-page.js">

<!-- é¢„æ¸²æŸ“ -->
<link rel="prerender" href="next-page.html">
```

### ä»£ç åˆ†å‰²
```javascript
// Viteé…ç½®
export default {
    build: {
        rollupOptions: {
            output: {
                manualChunks: {
                    'vendor': ['react', 'react-dom'],
                    'ui': ['@mui/material'],
                    'utils': ['lodash', 'axios']
                }
            }
        }
    }
};

// åŠ¨æ€å¯¼å…¥
button.addEventListener('click', async () => {
    const {default: module} = await import('./heavy-module.js');
    module.init();
});
```

### HTTPç¼“å­˜
```javascript
// Service Workerç¼“å­˜
self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request).then((response) => {
            return response || fetch(event.request);
        })
    );
});

// HTTPç¼“å­˜å¤´ï¼ˆæœåŠ¡ç«¯é…ç½®ï¼‰
Cache-Control: public, max-age=31536000, immutable
```

## ğŸ” æ€§èƒ½ç›‘æ§

### æ€§èƒ½ç›‘æ§å·¥å…·
```javascript
// Web Vitals
import {getCLS, getFID, getLCP} from 'web-vitals';

getCLS(console.log);
getFID(console.log);
getLCP(console.log);

// è‡ªå®šä¹‰ç›‘æ§
class PerformanceMonitor {
    constructor() {
        this.metrics = {};
    }
    
    mark(name) {
        performance.mark(name);
    }
    
    measure(name, startMark, endMark) {
        performance.measure(name, startMark, endMark);
        const measure = performance.getEntriesByName(name)[0];
        this.metrics[name] = measure.duration;
    }
    
    report() {
        // å‘é€åˆ°åˆ†ææœåŠ¡
        console.log('Performance Metrics:', this.metrics);
    }
}
```

### Lighthouse CI
```yaml
# .github/workflows/lighthouse.yml
name: Lighthouse CI

on: [push]

jobs:
    lighthouse:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Run Lighthouse CI
              uses: treosh/lighthouse-ci-action@v9
              with:
                  urls: |
                      https://example.com
                  uploadArtifacts: true
```

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### JavaScript
- [ ] ä½¿ç”¨ä»£ç åˆ†å‰²
- [ ] æ‡’åŠ è½½éå…³é”®ç»„ä»¶
- [ ] é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- [ ] ä½¿ç”¨Web Workerså¤„ç†å¯†é›†è®¡ç®—
- [ ] ä½¿ç”¨é˜²æŠ–/èŠ‚æµ

### CSS
- [ ] ä½¿ç”¨CSS contain
- [ ] é¿å…å¤æ‚é€‰æ‹©å™¨
- [ ] ç§»é™¤æœªä½¿ç”¨çš„CSS
- [ ] ä½¿ç”¨CSSåŠ¨ç”»è€ŒéJSåŠ¨ç”»
- [ ] ä¼˜åŒ–å…³é”®æ¸²æŸ“è·¯å¾„

### èµ„æº
- [ ] å‹ç¼©å›¾ç‰‡
- [ ] ä½¿ç”¨WebPæ ¼å¼
- [ ] å›¾ç‰‡æ‡’åŠ è½½
- [ ] å­—ä½“å­é›†åŒ–
- [ ] ä½¿ç”¨CDN

### ç½‘ç»œ
- [ ] å¯ç”¨HTTP/2
- [ ] ä½¿ç”¨Gzip/Brotliå‹ç¼©
- [ ] è®¾ç½®ç¼“å­˜ç­–ç•¥
- [ ] å‡å°‘HTTPè¯·æ±‚
- [ ] ä½¿ç”¨èµ„æºé¢„åŠ è½½

## ğŸ“š å·¥å…·æ¨è

### åˆ†æå·¥å…·
- Lighthouse
- WebPageTest
- Chrome DevTools Performance
- Bundle Analyzer

### ä¼˜åŒ–å·¥å…·
- ImageOptimï¼ˆå›¾ç‰‡å‹ç¼©ï¼‰
- SVGOï¼ˆSVGä¼˜åŒ–ï¼‰
- PurgeCSSï¼ˆç§»é™¤æœªä½¿ç”¨CSSï¼‰
- Terserï¼ˆJSå‹ç¼©ï¼‰

## ğŸ“š å‚è€ƒèµ„æ–™
- [Web.dev Performance](https://web.dev/performance/)
- [MDN Performance](https://developer.mozilla.org/zh-CN/docs/Web/Performance)
- [Reactæ€§èƒ½ä¼˜åŒ–](https://react.dev/learn/render-and-commit)
- [Vueæ€§èƒ½ä¼˜åŒ–](https://cn.vuejs.org/guide/best-practices/performance.html)

